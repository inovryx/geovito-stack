services:
  db:
    image: postgres:16-alpine
    container_name: geovito_db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-geovito}
      POSTGRES_USER: ${POSTGRES_USER:-geovito}
      POSTGRES_PASSWORD: ${DB_PASS:-change_me}
    volumes:
      - geovito_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    restart: unless-stopped

  strapi:
    build:
      context: ./app
      dockerfile: deploy/Dockerfile
    image: geovito_strapi:local
    container_name: geovito_strapi
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-1337}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SEED_ON_BOOT: ${SEED_ON_BOOT:-false}
      SEED_MOCK_ON_BOOT: ${SEED_MOCK_ON_BOOT:-false}
      TRANSLATION_BUNDLE_ENABLED: ${TRANSLATION_BUNDLE_ENABLED:-false}
      TRANSLATION_BUNDLE_ALLOW_STATUS_PROMOTE: ${TRANSLATION_BUNDLE_ALLOW_STATUS_PROMOTE:-false}

      DATABASE_CLIENT: ${DATABASE_CLIENT:-postgres}
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_NAME: ${POSTGRES_DB:-geovito}
      DATABASE_USERNAME: ${POSTGRES_USER:-geovito}
      DATABASE_PASSWORD: ${DB_PASS:-change_me}
      DATABASE_SCHEMA: ${DATABASE_SCHEMA:-public}
      DATABASE_SSL: ${DATABASE_SSL:-false}

      APP_KEYS: ${APP_KEYS}
      API_TOKEN_SALT: ${API_TOKEN_SALT}
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
      TRANSFER_TOKEN_SALT: ${TRANSFER_TOKEN_SALT}
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      DOMAIN_LOG_ROOT: /opt/logs
      AI_ENABLED: ${AI_ENABLED:-false}
      AI_DIAGNOSTICS_ENABLED: ${AI_DIAGNOSTICS_ENABLED:-false}
      AI_DRAFT_ENABLED: ${AI_DRAFT_ENABLED:-false}
      AI_AUTHOR_LANGUAGES: ${AI_AUTHOR_LANGUAGES:-en,tr,de,es,ru,zh-cn}
    volumes:
      - geovito_uploads:/opt/app/public/uploads
      - ./logs:/opt/logs
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "127.0.0.1:1337:1337"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:1337/admin >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    restart: unless-stopped

  search-indexer:
    build:
      context: ./services/search-indexer
      dockerfile: Dockerfile
    image: geovito_search_indexer:local
    container_name: geovito_search_indexer
    environment:
      NODE_ENV: production
      PORT: 4400
      SEARCH_WEBHOOK_SECRET: ${SEARCH_WEBHOOK_SECRET:-}
      SEARCH_REINDEX_TOKEN: ${SEARCH_REINDEX_TOKEN:-}
    depends_on:
      strapi:
        condition: service_healthy
    ports:
      - "127.0.0.1:4400:4400"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:4400/health >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    restart: unless-stopped

  frontend:
    image: node:20-alpine
    container_name: geovito_frontend
    profiles: ["frontend"]
    working_dir: /opt/web
    command: sh -lc "npm install && npm run dev -- --host 0.0.0.0 --port 4321"
    environment:
      STRAPI_URL: http://strapi:1337
      PUBLIC_SITE_URL: https://www.geovito.com
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN:-}
    volumes:
      - ./frontend:/opt/web
    depends_on:
      strapi:
        condition: service_healthy
    ports:
      - "127.0.0.1:4321:4321"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

volumes:
  geovito_db:
  geovito_uploads:
