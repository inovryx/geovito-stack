---
import LanguageSwitcher from './LanguageSwitcher.astro';
import { translate } from '../lib/uiLanguage';
import { resolveStrapiBaseUrl } from '../lib/strapiConfig';

interface Props {
  currentLanguage: string;
  languageLinks: Record<string, string>;
  ui: Record<string, unknown>;
}

const { currentLanguage, languageLinks, ui } = Astro.props as Props;
const isTruthy = (value: string | undefined) => ['1', 'true', 'yes', 'on'].includes(String(value || '').trim().toLowerCase());
const siteLockdownEnabled = isTruthy(
  (import.meta.env.PUBLIC_SITE_LOCKDOWN_ENABLED as string | undefined) || process.env.PUBLIC_SITE_LOCKDOWN_ENABLED
);
const loginPath = `/${currentLanguage}/login/`;
const registerPath = `/${currentLanguage}/register/`;
const dashboardPath = `/${currentLanguage}/dashboard/`;
const accountPath = `/${currentLanguage}/account/`;
const accountCommentsPath = `${accountPath}?commentState=pending#comments`;
const accountLocalePath = `${accountPath}#locale-progress`;
const dashboardEditorialPath = `${dashboardPath}#dashboard-editorial-moderation`;
const dashboardControlPath = `${dashboardPath}#dashboard-control`;
const authBaseUrl = resolveStrapiBaseUrl({
  STRAPI_URL: import.meta.env.STRAPI_URL as string | undefined,
  PUBLIC_STRAPI_URL: import.meta.env.PUBLIC_STRAPI_URL as string | undefined,
  CF_PAGES: process.env.CF_PAGES,
  NODE_ENV: process.env.NODE_ENV,
  ALLOW_LOCALHOST_STRAPI:
    process.env.ALLOW_LOCALHOST_STRAPI || (import.meta.env.ALLOW_LOCALHOST_STRAPI as string | undefined),
});
const strapiAdminUrl = `${authBaseUrl.replace(/\/$/, '')}/admin`;
const ownerEmailHint = String(import.meta.env.PUBLIC_OWNER_EMAIL || '').trim().toLowerCase();
const loginLabel = translate(ui, 'auth.login', {}, 'Login');
const registerLabel = translate(ui, 'auth.register', {}, 'Register');
const dashboardLabel = translate(ui, 'dashboard.title', {}, 'Dashboard');
const accountLabel = translate(ui, 'nav.account', {}, 'Account');
const logoutLabel = translate(ui, 'auth.logout', {}, 'Logout');
const signedInLabel = translate(ui, 'auth.signedInAs', {}, 'Signed in');
const lockdownHint = translate(ui, 'auth.lockdownHint', {}, 'Test mode active');
const adminToolsLabel = translate(ui, 'dashboard.controlTitle', {}, 'Control center');
const adminRoleLabel = translate(ui, 'dashboard.accessRole', {}, 'Role');
const accessMemberLabel = translate(ui, 'dashboard.accessMember', {}, 'Member');
const accessEditorLabel = translate(ui, 'dashboard.accessEditor', {}, 'Editor');
const accessAdminLabel = translate(ui, 'dashboard.accessAdmin', {}, 'Admin');
const accessOwnerLabel = translate(ui, 'dashboard.accessOwner', {}, 'Owner');
const adminModerationLabel = translate(ui, 'dashboard.moderationQueueTitle', {}, 'Pending moderation queue');
const adminLocaleLabel = translate(ui, 'dashboard.localeTitle', {}, 'Translation visibility');
const adminControlLabel = translate(ui, 'dashboard.controlAdmin', {}, 'Open Strapi admin');
const workspaceTitle = translate(ui, 'dashboard.workspaceTitle', {}, 'Workspace');
const workspaceHint = translate(ui, 'dashboard.workspaceHint', {}, 'Personal and role-based shortcuts.');
const workspaceCommentsLabel = translate(ui, 'dashboard.quickComments', {}, 'Open my comment queue');
const workspaceLocaleLabel = translate(ui, 'dashboard.quickLocale', {}, 'Open translation progress');
const workspaceModerationLabel = translate(ui, 'dashboard.moderationQueueTitle', {}, 'Pending moderation queue');
const workspaceControlLabel = translate(ui, 'dashboard.controlTitle', {}, 'Control center');
const workspaceOwnerOpsLabel = translate(ui, 'dashboard.ownerOpsTitle', {}, 'Owner operations');
const dashboardModuleTitle = translate(ui, 'dashboard.moduleNavTitle', {}, 'Dashboard modules');
const dashboardModuleGeneral = translate(ui, 'dashboard.moduleGeneral', {}, 'General');
const dashboardModuleSeo = translate(ui, 'dashboard.moduleSeo', {}, 'SEO');
const dashboardModuleAds = translate(ui, 'dashboard.moduleAds', {}, 'Ads');
const dashboardModuleModeration = translate(ui, 'dashboard.moduleModeration', {}, 'Moderation');
const dashboardModuleTranslation = translate(ui, 'dashboard.moduleTranslation', {}, 'Translation');
const dashboardModuleSettings = translate(ui, 'dashboard.moduleSettings', {}, 'Settings');
---

<div class="left-sidebar-stack">
  <section
    class="sidebar-block sidebar-dashboard-modules gv-card bg-surface border-border"
    data-auth-dashboard-shell
    hidden
  >
    <h2 class="sidebar-title">{dashboardModuleTitle}</h2>
    <ul class="sidebar-admin-list sidebar-dashboard-modules-list">
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-member`} data-auth-dashboard-link data-min-role="member">
          {dashboardModuleGeneral}
        </a>
      </li>
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-control`} data-auth-dashboard-link data-min-role="admin" hidden>
          {dashboardModuleSeo}
        </a>
      </li>
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-control-ads`} data-auth-dashboard-link data-min-role="admin" hidden>
          {dashboardModuleAds}
        </a>
      </li>
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-editorial-moderation`} data-auth-dashboard-link data-min-role="editor" hidden>
          {dashboardModuleModeration}
        </a>
      </li>
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-editorial-locale`} data-auth-dashboard-link data-min-role="editor" hidden>
          {dashboardModuleTranslation}
        </a>
      </li>
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-member-settings`} data-auth-dashboard-link data-min-role="member">
          {dashboardModuleSettings}
        </a>
      </li>
    </ul>
  </section>

  <section class="sidebar-block sidebar-language-switch gv-card bg-surface border-border">
    <h2 class="sidebar-title">{translate(ui, 'layout.languageTitle', {}, 'Language')}</h2>
    <LanguageSwitcher currentLanguage={currentLanguage} languageLinks={languageLinks} ui={ui} />
  </section>

  <section
    class="sidebar-block sidebar-auth-links gv-card bg-surface border-border"
    data-auth-shell
    data-signed-in-label={signedInLabel}
    data-auth-base-url={authBaseUrl}
    data-owner-email-hint={ownerEmailHint}
  >
    <p class="small sidebar-auth-user" data-auth-user hidden></p>

    <div class="sidebar-auth-row" data-auth-logged-out>
      <a href={loginPath} class="small-link">{loginLabel}</a>
      {
        siteLockdownEnabled ? (
          <span class="small-link sidebar-auth-disabled" aria-disabled="true">
            {lockdownHint}
          </span>
        ) : (
          <a href={registerPath} class="small-link">{registerLabel}</a>
        )
      }
    </div>

    <div class="sidebar-auth-row" data-auth-logged-in hidden>
      <a href={dashboardPath} class="small-link">{dashboardLabel}</a>
      <a href={accountPath} class="small-link">{accountLabel}</a>
      <button type="button" class="small-link sidebar-auth-logout" data-auth-logout>{logoutLabel}</button>
    </div>
  </section>

  <section
    class="sidebar-block sidebar-workspace gv-card bg-surface border-border"
    data-auth-workspace-shell
    hidden
  >
    <h2 class="sidebar-title">{workspaceTitle}</h2>
    <p class="small sidebar-workspace-hint">{workspaceHint}</p>
    <ul class="sidebar-admin-list sidebar-workspace-list">
      <li>
        <a class="small-link" href={dashboardPath} data-auth-workspace-link data-min-role="member">
          {dashboardLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={accountPath} data-auth-workspace-link data-min-role="member">
          {accountLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={accountCommentsPath} data-auth-workspace-link data-min-role="member">
          {workspaceCommentsLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={accountLocalePath} data-auth-workspace-link data-min-role="editor" hidden>
          {workspaceLocaleLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={dashboardEditorialPath} data-auth-workspace-link data-min-role="editor" hidden>
          {workspaceModerationLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={dashboardControlPath} data-auth-workspace-link data-min-role="admin" hidden>
          {workspaceControlLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={dashboardControlPath} data-auth-workspace-link data-min-role="owner" hidden>
          {workspaceOwnerOpsLabel}
        </a>
      </li>
    </ul>
  </section>

  <section
    class="sidebar-block sidebar-admin-tools gv-card bg-surface border-border"
    data-auth-admin-shell
    data-role-prefix={adminRoleLabel}
    data-role-member={accessMemberLabel}
    data-role-editor={accessEditorLabel}
    data-role-admin={accessAdminLabel}
    data-role-owner={accessOwnerLabel}
    hidden
  >
    <h2 class="sidebar-title">{adminToolsLabel}</h2>
    <p class="small sidebar-auth-user" data-auth-admin-role>
      {adminRoleLabel}: {accessMemberLabel}
    </p>
    <ul class="sidebar-admin-list">
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-editorial-moderation`} data-auth-admin-link data-min-role="editor" hidden>
          {adminModerationLabel}
        </a>
      </li>
      <li>
        <a class="small-link" href={`${dashboardPath}#dashboard-editorial-locale`} data-auth-admin-link data-min-role="editor" hidden>
          {adminLocaleLabel}
        </a>
      </li>
      <li>
        <a
          class="small-link"
          href={strapiAdminUrl}
          target="_blank"
          rel="noopener noreferrer"
          data-auth-admin-link
          data-min-role="admin"
          hidden
        >
          {adminControlLabel}
        </a>
      </li>
    </ul>
  </section>
</div>

<script>
  (() => {
    if (window.__geovitoAuthSidebarBound) return;
    window.__geovitoAuthSidebarBound = true;

    const isDashboardRoute = (() => {
      const parts = String(window.location.pathname || '')
        .split('/')
        .filter(Boolean);
      return parts.length >= 2 && parts[1] === 'dashboard';
    })();

    const readSession = () => {
      try {
        const fromLocal = localStorage.getItem('geovito_auth_session');
        const fromSession = sessionStorage.getItem('geovito_auth_session');
        const raw = fromLocal || fromSession;
        if (!raw) return null;

        if (!fromLocal && fromSession) {
          localStorage.setItem('geovito_auth_session', fromSession);
        }

        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        const jwt = typeof parsed.jwt === 'string' ? parsed.jwt.trim() : '';
        if (!jwt) return null;
        const username = typeof parsed.username === 'string' ? parsed.username.trim() : '';
        const email = typeof parsed.email === 'string' ? parsed.email.trim() : '';
        return { username, email, jwt };
      } catch {
        return null;
      }
    };

    const normalize = (value) => String(value || '').trim().toLowerCase();
    const roleOrder = {
      member: 0,
      editor: 1,
      admin: 2,
      owner: 3,
    };

    const isSidebarLinkActive = (href, fallbackWhenNoHash = false) => {
      const value = String(href || '').trim();
      if (!value) return false;
      try {
        const target = new URL(value, window.location.origin);
        const current = new URL(window.location.href);
        if (target.pathname !== current.pathname) return false;
        if (!target.hash) return true;
        if (!current.hash && fallbackWhenNoHash) return true;
        if (target.hash && target.hash !== current.hash) return false;
        return true;
      } catch {
        return false;
      }
    };

    const inferRole = (payload, session, ownerHint) => {
      const roleRaw = normalize(payload?.role?.type || payload?.role?.name || payload?.role?.code);
      if (roleRaw.includes('super') || roleRaw.includes('admin') || roleRaw.includes('administrator')) {
        return 'admin';
      }
      if (roleRaw.includes('editor')) {
        return 'editor';
      }
      const email = normalize(payload?.email || session?.email || '');
      if (ownerHint && email && email === ownerHint) {
        return 'owner';
      }
      return 'member';
    };

    const resolveSessionRole = async (session) => {
      const shells = Array.from(document.querySelectorAll('[data-auth-shell]'));
      const firstShell = shells.find((shell) => shell instanceof HTMLElement);
      const authBaseUrl = firstShell instanceof HTMLElement
        ? String(firstShell.getAttribute('data-auth-base-url') || '').trim()
        : '';
      const ownerHint = firstShell instanceof HTMLElement
        ? normalize(firstShell.getAttribute('data-owner-email-hint') || '')
        : '';

      if (!session || !session.email || !authBaseUrl) {
        return 'member';
      }

      try {
        const response = await fetch(`${authBaseUrl}/api/users/me?populate=role`, {
          headers: {
            Accept: 'application/json',
            Authorization: `Bearer ${session.jwt}`,
          },
        });
        if (!response.ok) {
          return ownerHint && normalize(session.email) === ownerHint ? 'owner' : 'member';
        }
        const payload = await response.json().catch(() => null);
        return inferRole(payload, session, ownerHint);
      } catch {
        return ownerHint && normalize(session.email) === ownerHint ? 'owner' : 'member';
      }
    };

    const applyAuthState = async () => {
      const session = readSession();
      const role = session ? await resolveSessionRole(session) : 'member';
      const roleRank = Number(roleOrder[role] ?? 0);

      document.querySelectorAll('.left-sidebar-stack').forEach((stack) => {
        if (!(stack instanceof HTMLElement)) return;
        stack.classList.toggle('is-dashboard-mode', isDashboardRoute);
        stack.classList.toggle('is-dashboard-auth', isDashboardRoute && Boolean(session));
      });

      document.querySelectorAll('[data-auth-shell]').forEach((shell) => {
        if (!(shell instanceof HTMLElement)) return;

        const loggedOut = shell.querySelector('[data-auth-logged-out]');
        const loggedIn = shell.querySelector('[data-auth-logged-in]');
        const userLine = shell.querySelector('[data-auth-user]');
        const signedInPrefix = shell.getAttribute('data-signed-in-label') || 'Signed in';
        const identity = session ? (session.username || session.email) : '';

        if (loggedOut instanceof HTMLElement) {
          loggedOut.hidden = Boolean(session);
        }

        if (loggedIn instanceof HTMLElement) {
          loggedIn.hidden = !session;
        }

        if (userLine instanceof HTMLElement) {
          if (session && identity) {
            userLine.hidden = false;
            userLine.textContent = `${signedInPrefix}: ${identity}`;
          } else {
            userLine.hidden = true;
            userLine.textContent = '';
          }
        }
      });

      document.querySelectorAll('[data-auth-admin-shell]').forEach((shell) => {
        if (!(shell instanceof HTMLElement)) return;

        shell.hidden = !session || roleRank < roleOrder.editor;

        const roleNode = shell.querySelector('[data-auth-admin-role]');
        const rolePrefix = shell.getAttribute('data-role-prefix') || 'Role';
        const roleLabelMap = {
          member: shell.getAttribute('data-role-member') || 'Member',
          editor: shell.getAttribute('data-role-editor') || 'Editor',
          admin: shell.getAttribute('data-role-admin') || 'Admin',
          owner: shell.getAttribute('data-role-owner') || 'Owner',
        };
        if (roleNode instanceof HTMLElement) {
          roleNode.textContent = `${rolePrefix}: ${roleLabelMap[role] || roleLabelMap.member}`;
        }

        shell.querySelectorAll('[data-auth-admin-link]').forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          const minRole = normalize(node.getAttribute('data-min-role') || 'member');
          const minRank = Number(roleOrder[minRole] ?? roleOrder.member);
          node.hidden = roleRank < minRank;
        });
      });

      document.querySelectorAll('[data-auth-workspace-shell]').forEach((shell) => {
        if (!(shell instanceof HTMLElement)) return;

        shell.hidden = !session;
        if (!session) return;

        shell.querySelectorAll('[data-auth-workspace-link]').forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          const minRole = normalize(node.getAttribute('data-min-role') || 'member');
          const minRank = Number(roleOrder[minRole] ?? roleOrder.member);
          node.hidden = roleRank < minRank;
          const href = node.getAttribute('href') || '';
          node.classList.toggle('is-active', !node.hidden && isSidebarLinkActive(href));
        });
      });

      document.querySelectorAll('[data-auth-dashboard-shell]').forEach((shell) => {
        if (!(shell instanceof HTMLElement)) return;

        shell.hidden = !session || !isDashboardRoute;
        if (!session || !isDashboardRoute) return;

        shell.querySelectorAll('[data-auth-dashboard-link]').forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          const minRole = normalize(node.getAttribute('data-min-role') || 'member');
          const minRank = Number(roleOrder[minRole] ?? roleOrder.member);
          node.hidden = roleRank < minRank;
          const href = node.getAttribute('href') || '';
          const fallbackWhenNoHash = href.endsWith('#dashboard-member');
          node.classList.toggle('is-active', !node.hidden && isSidebarLinkActive(href, fallbackWhenNoHash));
        });
      });
    };

    const bindLogout = () => {
      document.querySelectorAll('[data-auth-logout]').forEach((button) => {
        if (!(button instanceof HTMLButtonElement)) return;
        if (button.dataset.authLogoutBound === '1') return;
        button.dataset.authLogoutBound = '1';

        button.addEventListener('click', () => {
          try {
            localStorage.removeItem('geovito_auth_session');
            sessionStorage.removeItem('geovito_auth_session');
          } catch {
            // no-op
          }

          void applyAuthState();

          const language = document.documentElement.lang?.toLowerCase() || 'en';
          window.location.assign(`/${language}/login/`);
        });
      });
    };

    const init = () => {
      bindLogout();
      void applyAuthState();
    };

    window.addEventListener('storage', (event) => {
      if (event.key === 'geovito_auth_session') {
        void applyAuthState();
      }
    });

    window.addEventListener('hashchange', () => {
      void applyAuthState();
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
      return;
    }

    init();
  })();
</script>

<style>
.sidebar-auth-disabled {
    color: var(--ink-muted);
    cursor: default;
    text-decoration: none;
}

.sidebar-nav-main-title {
    display: none;
}

.left-sidebar-stack.is-dashboard-auth {
    gap: 0.62rem;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-dashboard-modules {
    order: 1;
    border-color: color-mix(in srgb, var(--brand) 34%, var(--border));
    background: color-mix(in srgb, var(--brand-soft) 42%, var(--surface-strong));
}

.left-sidebar-stack.is-dashboard-auth .sidebar-dashboard-modules-list {
    gap: 0.3rem;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-dashboard-modules-list .small-link {
    font-size: 0.92rem;
    display: inline-block;
    line-height: 1.25;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-dashboard-modules-list .small-link.is-active {
    font-weight: 700;
    color: var(--brand-strong);
    text-decoration: underline;
    text-decoration-thickness: 1.4px;
    text-underline-offset: 2px;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-workspace {
    order: 2;
    border-color: color-mix(in srgb, var(--brand) 30%, var(--border));
    background: color-mix(in srgb, var(--brand-soft) 54%, var(--surface-strong));
}

.left-sidebar-stack.is-dashboard-auth .sidebar-workspace-list .small-link {
    font-size: 0.93rem;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-auth-links {
    order: 3;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-admin-tools {
    order: 4;
}

.left-sidebar-stack.is-dashboard-auth .sidebar-language-switch {
    order: 5;
}
</style>
