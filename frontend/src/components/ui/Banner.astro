---
import Icon from '../Icon.astro';

interface Props {
  variant?: 'info' | 'success' | 'warning' | 'danger';
  title?: string;
  dismissible?: boolean;
  storageKey?: string;
  class?: string;
}

const {
  variant = 'info',
  title,
  dismissible = false,
  storageKey = '',
  class: className = '',
} = Astro.props as Props;

const key = storageKey || `geovito.ui-banner.${variant}`;
const variantClasses = {
  info: 'border-accent/40 bg-accent/10 text-fg',
  success: 'border-success/40 bg-success/10 text-fg',
  warning: 'border-warn/45 bg-warn/14 text-fg',
  danger: 'border-danger/45 bg-danger/12 text-fg',
} as const;
---

<aside
  class={`ui-banner ui-banner-${variant} rounded-sm border ${variantClasses[variant]} ${className}`.trim()}
  data-ui-banner
  data-ui-banner-key={key}
>
  <div class="ui-banner-content">
    {title ? <strong>{title}</strong> : <Icon name="Info" size={16} />}
    <span><slot /></span>
  </div>
  {
    dismissible ? (
      <button type="button" class="ui-banner-close" data-ui-banner-dismiss aria-label="Dismiss banner">
        <Icon name="X" size={16} />
      </button>
    ) : null
  }
</aside>

{
  dismissible ? (
    <script is:inline>
      (() => {
        document.querySelectorAll('[data-ui-banner]').forEach((banner) => {
          const key = banner.getAttribute('data-ui-banner-key');
          if (!key) return;

          try {
            if (localStorage.getItem(key) === '1') {
              banner.classList.add('is-dismissed');
            }
          } catch {
            // no-op
          }

          const button = banner.querySelector('[data-ui-banner-dismiss]');
          if (!button || button.getAttribute('data-bound') === 'true') return;
          button.setAttribute('data-bound', 'true');

          button.addEventListener('click', () => {
            banner.classList.add('is-dismissed');
            try {
              localStorage.setItem(key, '1');
            } catch {
              // no-op
            }
          });
        });
      })();
    </script>
  ) : null
}
