---
import MainLayout from '../../../layouts/MainLayout.astro';
import StateBanner from '../../../components/StateBanner.astro';
import { resolveTranslation } from '../../../lib/languageState';
import { getBlogPosts } from '../../../lib/strapi';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const posts = await getBlogPosts();
const hasMockContent = posts.some((post) => post.mock === true);

const entries = posts
  .map((post) => {
    const resolved = resolveTranslation(post.translations, lang, post.canonical_language);
    const requested = resolved.requested;
    const complete = resolved.complete;

    if (!complete?.slug || !resolved.output) {
      return null;
    }

    const slug = requested?.status === 'complete' && requested.slug ? requested.slug : complete.slug;

    return {
      post_id: post.post_id,
      title: resolved.output.title || post.post_id,
      excerpt: resolved.output.excerpt || '',
      href: `/${lang}/blog/${slug}/`,
      status: requested?.status || 'missing',
    };
  })
  .filter(Boolean);

const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'blog')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage(lang, 'blog'));
const robots = hasMockContent ? 'noindex,nofollow' : 'index,follow';
---

<MainLayout
  title={translate(ui, 'blog.listTitle')}
  description={translate(ui, 'blog.listDescription')}
  canonical={canonical}
  robots={robots}
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  {hasMockContent ? <StateBanner status="mock" language={lang} canonicalPath={canonical} ui={ui} /> : null}

  <h1>{translate(ui, 'blog.listTitle')}</h1>
  <p class="small">{translate(ui, 'blog.listHint')}</p>

  <div class="grid">
    {
      entries.map((entry) => (
        <article class="card">
          <a href={entry?.href || '#'}>
            <h2>{entry?.title}</h2>
          </a>
          <span class="status-pill">{entry?.status}</span>
          <p class="small">{entry?.excerpt}</p>
        </article>
      ))
    }
  </div>
</MainLayout>
