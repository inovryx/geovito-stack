---
import MainLayout from '../../../layouts/MainLayout.astro';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { resolveStrapiBaseUrl } from '../../../lib/strapiConfig';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'reset-password')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage('en', 'reset-password'));
const authBaseUrl = resolveStrapiBaseUrl({
  STRAPI_URL: import.meta.env.STRAPI_URL as string | undefined,
  PUBLIC_STRAPI_URL: import.meta.env.PUBLIC_STRAPI_URL as string | undefined,
  CF_PAGES: process.env.CF_PAGES,
  NODE_ENV: process.env.NODE_ENV,
  ALLOW_LOCALHOST_STRAPI:
    process.env.ALLOW_LOCALHOST_STRAPI || (import.meta.env.ALLOW_LOCALHOST_STRAPI as string | undefined),
});
const loginPath = pathForLanguage(lang, 'login');
const forgotPath = pathForLanguage(lang, 'forgot-password');
const resetPasswordMessages = {
  tokenMissing: translate(ui, 'auth.resetTokenMissing', {}, 'Reset token is missing. Please request a new reset link.'),
  required: translate(ui, 'auth.resetPasswordRequired', {}, 'Password and confirmation are required.'),
  minLength: translate(ui, 'auth.resetPasswordLength', {}, 'Password must be at least 8 characters.'),
  mismatch: translate(ui, 'auth.resetPasswordMismatch', {}, 'Password confirmation does not match.'),
  updating: translate(ui, 'auth.resetPasswordUpdating', {}, 'Updating password...'),
  failed: translate(ui, 'auth.resetPasswordFailed', {}, 'Password reset failed. Please request a new link.'),
  successRedirect: translate(ui, 'auth.resetPasswordSuccessRedirect', {}, 'Password updated. Redirecting to login...'),
  networkError: translate(ui, 'auth.networkError', {}, 'Network error. Please try again.'),
};
---

<MainLayout
  title={translate(ui, 'auth.resetPasswordTitle', {}, 'Reset password')}
  description={translate(ui, 'auth.resetPasswordDescription', {}, 'Set a new password using your reset token.')}
  canonical={canonical}
  robots="noindex,nofollow"
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  <h1>{translate(ui, 'auth.resetPasswordTitle', {}, 'Reset password')}</h1>
  <p class="small">{translate(ui, 'auth.resetPasswordDescription', {}, 'Set a new password using your reset token.')}</p>

  <section class="card panel auth-panel gv-stack">
    <form class="gv-stack auth-form" data-auth-form="reset-password" data-auth-base={authBaseUrl} novalidate>
      <label class="auth-field">
        <span>{translate(ui, 'auth.newPassword', {}, 'New password')}</span>
        <input
          type="password"
          name="password"
          autocomplete="new-password"
          required
          minlength="8"
          placeholder={translate(ui, 'auth.passwordPlaceholder', {}, 'Min 8 characters')}
        />
      </label>

      <label class="auth-field">
        <span>{translate(ui, 'auth.passwordConfirm', {}, 'Confirm password')}</span>
        <input
          type="password"
          name="passwordConfirmation"
          autocomplete="new-password"
          required
          minlength="8"
          placeholder={translate(ui, 'auth.passwordConfirmPlaceholder', {}, 'Repeat your password')}
        />
      </label>

      <button type="submit" class="ui-button ui-button-primary ui-button-md" data-reset-submit>
        <span class="ui-button-label">{translate(ui, 'auth.updatePassword', {}, 'Update password')}</span>
      </button>
      <p class="small auth-feedback" data-auth-feedback aria-live="polite"></p>
    </form>

    <p class="small">
      <a href={loginPath}>{translate(ui, 'auth.backToLogin', {}, 'Back to login')}</a>
      {' Â· '}
      <a href={forgotPath}>{translate(ui, 'auth.requestNewResetLink', {}, 'Request a new reset link')}</a>
    </p>
  </section>

  <script is:inline define:vars={{ loginPath, resetPasswordMessages }}>
    (() => {
      const form = document.querySelector('[data-auth-form="reset-password"]');
      const feedback = document.querySelector('[data-auth-feedback]');
      const submit = document.querySelector('[data-reset-submit]');
      if (!(form instanceof HTMLFormElement) || !(feedback instanceof HTMLElement) || !(submit instanceof HTMLButtonElement)) return;

      const authBase = form.getAttribute('data-auth-base');
      if (!authBase) return;

      const setFeedback = (message, isError = false) => {
        feedback.textContent = message;
        feedback.classList.toggle('is-error', isError);
      };

      const disableForm = () => {
        for (const element of form.elements) {
          if (element instanceof HTMLInputElement || element instanceof HTMLButtonElement) {
            element.disabled = true;
          }
        }
      };

      const params = new URLSearchParams(window.location.search);
      const code = String(params.get('code') || '').trim();
      if (!code) {
        disableForm();
        setFeedback(resetPasswordMessages.tokenMissing, true);
        return;
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const password = String(formData.get('password') || '');
        const passwordConfirmation = String(formData.get('passwordConfirmation') || '');

        if (!password || !passwordConfirmation) {
          setFeedback(resetPasswordMessages.required, true);
          return;
        }
        if (password.length < 8) {
          setFeedback(resetPasswordMessages.minLength, true);
          return;
        }
        if (password !== passwordConfirmation) {
          setFeedback(resetPasswordMessages.mismatch, true);
          return;
        }

        setFeedback(resetPasswordMessages.updating);
        submit.disabled = true;
        try {
          const response = await fetch(`${authBase}/api/auth/reset-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify({
              code,
              password,
              passwordConfirmation,
            }),
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message =
              payload?.error?.message ||
              payload?.message ||
              resetPasswordMessages.failed;
            setFeedback(message, true);
            submit.disabled = false;
            return;
          }

          setFeedback(resetPasswordMessages.successRedirect);
          window.setTimeout(() => {
            window.location.assign(loginPath);
          }, 1100);
        } catch {
          setFeedback(resetPasswordMessages.networkError, true);
          submit.disabled = false;
        }
      });
    })();
  </script>
</MainLayout>

<style>
  .auth-panel {
    max-width: 560px;
  }

  .auth-form {
    gap: 0.75rem;
  }

  .auth-field {
    display: grid;
    gap: 0.4rem;
  }

  .auth-field input {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 0.85rem;
    background: var(--surface);
    color: var(--text);
  }

  .auth-field input:focus-visible {
    outline: 2px solid var(--brand);
    outline-offset: 1px;
  }

  .auth-feedback {
    margin: 0;
    min-height: 1.25rem;
  }

  .auth-feedback.is-error {
    color: var(--danger);
  }
</style>
