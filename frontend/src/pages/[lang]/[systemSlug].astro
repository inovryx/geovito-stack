---
import MainLayout from '../../layouts/MainLayout.astro';
import StateBanner from '../../components/StateBanner.astro';
import { resolveTranslation } from '../../lib/languageState';
import { getUiPage } from '../../lib/strapi';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../lib/languages';
import { absoluteUrl, buildLanguageLinks, toAlternates } from '../../lib/pageHelpers';
import { SYSTEM_PAGES, isSystemSlug } from '../../lib/systemPages';
import { getUiMessages, translate } from '../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.flatMap((language) =>
    SYSTEM_PAGES.map((systemSlug) => ({
      params: { lang: language, systemSlug },
    }))
  );
}

const lang = Astro.params.lang || '';
const systemSlug = Astro.params.systemSlug || '';

if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

if (!isSystemSlug(systemSlug)) {
  throw new Error(`Unsupported system page: ${systemSlug}`);
}

const ui = getUiMessages(lang);
const runtimeMode = Astro.url.searchParams.get('translate') === '1';
const page = await getUiPage(systemSlug);
const resolution = page ? resolveTranslation(page.translations, lang, page.canonical_language, runtimeMode) : null;
const hasRenderableContent = Boolean(resolution?.output && resolution?.complete);
const isMockView = page?.mock === true;

const canonicalPath = hasRenderableContent
  ? resolution?.complete?.canonical_path ||
    pathForLanguage(page?.canonical_language || 'en', resolution?.complete?.slug || systemSlug)
  : pathForLanguage('en', systemSlug);

const title = hasRenderableContent
  ? resolution?.output?.seo?.metaTitle || resolution?.output?.title || systemSlug
  : `${translate(ui, `nav.${systemSlug}`)} - ${translate(ui, 'uiPage.notFoundTitle')}`;
const description = hasRenderableContent
  ? resolution?.output?.seo?.metaDescription || resolution?.output?.excerpt || ''
  : translate(ui, 'uiPage.notFoundDescription');

const languagePathMap: Record<string, string> = {};
for (const language of SUPPORTED_LANGUAGES) {
  languagePathMap[language] = pathForLanguage(language, systemSlug);
}

const languageLinks = buildLanguageLinks(languagePathMap);
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(canonicalPath);
const robots = !hasRenderableContent
  ? 'noindex,nofollow'
  : isMockView
    ? 'noindex,nofollow'
    : resolution?.indexable
      ? 'index,follow'
      : 'noindex,nofollow';
---

<MainLayout
  title={title}
  description={description}
  canonical={canonical}
  robots={robots}
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  {isMockView ? <StateBanner status="mock" language={lang} canonicalPath={canonical} ui={ui} /> : null}

  {
    hasRenderableContent ? (
      <>
        {resolution?.isRuntime ? (
          <StateBanner status="runtime" language={lang} canonicalPath={canonical} ui={ui} />
        ) : resolution?.isFallback ? (
          <StateBanner status="fallback" language={lang} canonicalPath={canonical} ui={ui} />
        ) : null}

        <h1>{resolution?.output?.title}</h1>
        <p class="small">{resolution?.output?.excerpt}</p>
        {resolution?.output?.body ? (
          <article data-ev-root="off" set:html={resolution?.output?.body || ''}></article>
        ) : (
          <p>{translate(ui, 'uiPage.noBody')}</p>
        )}

        {resolution?.requested?.status !== 'complete' && !runtimeMode ? (
          <p>
            <a href={`?translate=1`}>{translate(ui, 'actions.previewOnDemand')}</a>
          </p>
        ) : null}
      </>
    ) : (
      <>
        <h1>{translate(ui, 'uiPage.notFoundTitle')}</h1>
        <p>{translate(ui, 'uiPage.notFoundDescription')}</p>
      </>
    )
  }
</MainLayout>
