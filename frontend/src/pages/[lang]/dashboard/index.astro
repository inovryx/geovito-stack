---
import MainLayout from '../../../layouts/MainLayout.astro';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { resolveStrapiBaseUrl } from '../../../lib/strapiConfig';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'dashboard')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage('en', 'dashboard'));
const loginPath = pathForLanguage(lang, 'login');
const accountPath = pathForLanguage(lang, 'account');
const releaseCommand = 'bash tools/release_deploy_smoke.sh --with-moderation --with-account-test --with-blog-engagement-test';
const stackHealthCommand = 'bash tools/stack_health.sh';
const smokeAccessCommand = 'bash tools/smoke_access.sh';
const ownerEmailHint = String(import.meta.env.PUBLIC_OWNER_EMAIL || '').trim().toLowerCase();
const authBaseUrl = resolveStrapiBaseUrl({
  STRAPI_URL: import.meta.env.STRAPI_URL as string | undefined,
  PUBLIC_STRAPI_URL: import.meta.env.PUBLIC_STRAPI_URL as string | undefined,
  CF_PAGES: process.env.CF_PAGES,
  NODE_ENV: process.env.NODE_ENV,
  ALLOW_LOCALHOST_STRAPI:
    process.env.ALLOW_LOCALHOST_STRAPI || (import.meta.env.ALLOW_LOCALHOST_STRAPI as string | undefined),
});
const strapiAdminUrl = `${authBaseUrl.replace(/\/$/, '')}/admin`;

const dashboardCopy = {
  title: translate(ui, 'dashboard.title', {}, 'Dashboard'),
  description: translate(ui, 'dashboard.description', {}, 'Review account activity and moderation visibility from one place.'),
  loginRequiredTitle: translate(ui, 'dashboard.loginRequiredTitle', {}, 'Login required'),
  loginRequiredBody: translate(
    ui,
    'dashboard.loginRequiredBody',
    {},
    'Sign in first to load your dashboard session and observation cards.'
  ),
  loginCta: translate(ui, 'dashboard.loginCta', {}, 'Go to login'),
  overviewTitle: translate(ui, 'dashboard.overviewTitle', {}, 'Session overview'),
  overviewIdentity: translate(ui, 'dashboard.overviewIdentity', {}, 'Identity'),
  overviewEmail: translate(ui, 'dashboard.overviewEmail', {}, 'Email'),
  overviewStatus: translate(ui, 'dashboard.overviewStatus', {}, 'Status'),
  overviewMemberSince: translate(ui, 'dashboard.overviewMemberSince', {}, 'Member since'),
  overviewLoginAt: translate(ui, 'dashboard.overviewLoginAt', {}, 'Last login'),
  statusActive: translate(ui, 'dashboard.statusActive', {}, 'Active'),
  statusPending: translate(ui, 'dashboard.statusPending', {}, 'Pending confirmation'),
  statusBlocked: translate(ui, 'dashboard.statusBlocked', {}, 'Blocked'),
  unknown: translate(ui, 'dashboard.unknown', {}, 'Unknown'),
  preferenceTitle: translate(ui, 'dashboard.preferenceTitle', {}, 'Language preference'),
  preferenceBody: translate(
    ui,
    'dashboard.preferenceBody',
    {},
    'Preferred UI language saved to your profile.'
  ),
  preferenceValue: translate(ui, 'dashboard.preferenceValue', {}, 'Preferred language'),
  commentsTitle: translate(ui, 'dashboard.commentsTitle', {}, 'My comment moderation'),
  commentsBody: translate(
    ui,
    'dashboard.commentsBody',
    {},
    'Quick status from your latest comments.'
  ),
  commentsTotal: translate(ui, 'dashboard.commentsTotal', {}, 'Total'),
  commentsPending: translate(ui, 'dashboard.commentsPending', {}, 'Pending'),
  commentsApproved: translate(ui, 'dashboard.commentsApproved', {}, 'Approved'),
  commentsRejected: translate(ui, 'dashboard.commentsRejected', {}, 'Rejected/Spam'),
  moderationQueueTitle: translate(ui, 'dashboard.moderationQueueTitle', {}, 'Pending moderation queue'),
  moderationQueueBody: translate(
    ui,
    'dashboard.moderationQueueBody',
    {},
    'Editor/admin roles can approve, reject, or mark spam directly from dashboard.'
  ),
  moderationQueuePendingCount: translate(ui, 'dashboard.moderationQueuePendingCount', {}, 'Pending items'),
  moderationQueueStaleCount: translate(ui, 'dashboard.moderationQueueStaleCount', {}, 'Older than 24h'),
  moderationQueueOldest: translate(ui, 'dashboard.moderationQueueOldest', {}, 'Oldest pending'),
  moderationQueueStaleAlert: translate(
    ui,
    'dashboard.moderationQueueStaleAlert',
    {},
    '{count} pending comments are older than {hours}h.'
  ),
  moderationQueueEmpty: translate(ui, 'dashboard.moderationQueueEmpty', {}, 'No pending comments in queue.'),
  moderationHistoryTitle: translate(ui, 'dashboard.moderationHistoryTitle', {}, 'Recent moderation actions'),
  moderationHistoryBody: translate(
    ui,
    'dashboard.moderationHistoryBody',
    {},
    'Latest approved/rejected/spam actions with reviewer and timestamp.'
  ),
  moderationHistoryEmpty: translate(ui, 'dashboard.moderationHistoryEmpty', {}, 'No recent moderation actions yet.'),
  moderationHistoryPost: translate(ui, 'dashboard.moderationHistoryPost', {}, 'Post'),
  moderationHistoryNote: translate(ui, 'dashboard.moderationHistoryNote', {}, 'Note'),
  moderationApprove: translate(ui, 'dashboard.moderationApprove', {}, 'Approve'),
  moderationReject: translate(ui, 'dashboard.moderationReject', {}, 'Reject'),
  moderationSpam: translate(ui, 'dashboard.moderationSpam', {}, 'Spam'),
  moderationNotesPrompt: translate(
    ui,
    'dashboard.moderationNotesPrompt',
    {},
    'Enter moderation note (required for reject/spam):'
  ),
  moderationNotesRequired: translate(ui, 'dashboard.moderationNotesRequired', {}, 'Moderation note is required for this action.'),
  moderationActionSuccess: translate(ui, 'dashboard.moderationActionSuccess', {}, 'Moderation update saved.'),
  moderationActionFailed: translate(ui, 'dashboard.moderationActionFailed', {}, 'Moderation update failed.'),
  localeTitle: translate(ui, 'dashboard.localeTitle', {}, 'Translation visibility'),
  localeBody: translate(
    ui,
    'dashboard.localeBody',
    {},
    'Locale progress is visible for editorial permissions.'
  ),
  localeCoverage: translate(ui, 'dashboard.localeCoverage', {}, 'Coverage ({lang})'),
  localeGapLocales: translate(ui, 'dashboard.localeGapLocales', {}, 'Locales with gaps'),
  localeDeployRequired: translate(ui, 'dashboard.localeDeployRequired', {}, 'Locales pending deploy'),
  localeLimited: translate(ui, 'dashboard.localeLimited', {}, 'Limited: editor/admin permission required'),
  quickTitle: translate(ui, 'dashboard.quickTitle', {}, 'Quick actions'),
  quickBody: translate(ui, 'dashboard.quickBody', {}, 'Open account settings or continue product workflows.'),
  quickAccount: translate(ui, 'dashboard.quickAccount', {}, 'Open account settings'),
  quickComments: translate(ui, 'dashboard.quickComments', {}, 'Open my comment queue'),
  quickLocale: translate(ui, 'dashboard.quickLocale', {}, 'Open translation progress'),
  quickAtlas: translate(ui, 'dashboard.quickAtlas', {}, 'Go to atlas'),
  quickBlog: translate(ui, 'dashboard.quickBlog', {}, 'Go to blog'),
  accessTitle: translate(ui, 'dashboard.accessTitle', {}, 'Access level'),
  accessBody: translate(
    ui,
    'dashboard.accessBody',
    {},
    'Role-driven capability map for dashboard visibility. Backend permissions remain authoritative.'
  ),
  accessRole: translate(ui, 'dashboard.accessRole', {}, 'Role'),
  accessOwner: translate(ui, 'dashboard.accessOwner', {}, 'Owner'),
  accessAdmin: translate(ui, 'dashboard.accessAdmin', {}, 'Admin'),
  accessEditor: translate(ui, 'dashboard.accessEditor', {}, 'Editor'),
  accessMember: translate(ui, 'dashboard.accessMember', {}, 'Member'),
  roleGovernanceTitle: translate(ui, 'dashboard.roleGovernanceTitle', {}, 'Role governance'),
  roleGovernanceBody: translate(
    ui,
    'dashboard.roleGovernanceBody',
    {},
    'Role mapping for owner/admin/editor/member and where permissions are managed.'
  ),
  roleGovernanceCurrent: translate(ui, 'dashboard.roleGovernanceCurrent', {}, 'Current role'),
  roleGovernanceScope: translate(ui, 'dashboard.roleGovernanceScope', {}, 'Scope'),
  roleGovernancePolicy: translate(ui, 'dashboard.roleGovernancePolicy', {}, 'Policy'),
  roleGovernanceOwnerScope: translate(
    ui,
    'dashboard.roleGovernanceOwnerScope',
    {},
    'Full stack governance and production operations.'
  ),
  roleGovernanceOwnerPolicy: translate(
    ui,
    'dashboard.roleGovernanceOwnerPolicy',
    {},
    'Can assign/revoke admin and editor responsibilities.'
  ),
  roleGovernanceAdminScope: translate(
    ui,
    'dashboard.roleGovernanceAdminScope',
    {},
    'Operational admin controls and moderation oversight.'
  ),
  roleGovernanceAdminPolicy: translate(
    ui,
    'dashboard.roleGovernanceAdminPolicy',
    {},
    'Can manage editors and moderation workflows.'
  ),
  roleGovernanceEditorScope: translate(
    ui,
    'dashboard.roleGovernanceEditorScope',
    {},
    'Editorial workflows, locale progress, and comment moderation.'
  ),
  roleGovernanceEditorPolicy: translate(
    ui,
    'dashboard.roleGovernanceEditorPolicy',
    {},
    'Cannot assign roles; escalation via admin/owner only.'
  ),
  roleGovernanceMemberScope: translate(
    ui,
    'dashboard.roleGovernanceMemberScope',
    {},
    'Personal profile and own engagement visibility.'
  ),
  roleGovernanceMemberPolicy: translate(
    ui,
    'dashboard.roleGovernanceMemberPolicy',
    {},
    'Role changes require owner/admin action.'
  ),
  roleGovernanceManageRoles: translate(ui, 'dashboard.roleGovernanceManageRoles', {}, 'Manage roles'),
  roleGovernanceManageUsers: translate(ui, 'dashboard.roleGovernanceManageUsers', {}, 'Manage users'),
  roleGovernanceLimited: translate(
    ui,
    'dashboard.roleGovernanceLimited',
    {},
    'Role management links are visible for owner/admin only.'
  ),
  capabilityModeration: translate(ui, 'dashboard.capabilityModeration', {}, 'Moderation view'),
  capabilityLocale: translate(ui, 'dashboard.capabilityLocale', {}, 'Translation progress'),
  capabilityAdminTools: translate(ui, 'dashboard.capabilityAdminTools', {}, 'Admin tools links'),
  capabilityEnabled: translate(ui, 'dashboard.capabilityEnabled', {}, 'Enabled'),
  capabilityDisabled: translate(ui, 'dashboard.capabilityDisabled', {}, 'Limited'),
  controlTitle: translate(ui, 'dashboard.controlTitle', {}, 'Control center'),
  controlBody: translate(
    ui,
    'dashboard.controlBody',
    {},
    'Owner/admin shortcuts for operational panels. UI visibility is role-based; backend still enforces access.'
  ),
  controlAdmin: translate(ui, 'dashboard.controlAdmin', {}, 'Open Strapi admin'),
  controlRunbook: translate(ui, 'dashboard.controlRunbook', {}, 'Open launch runbook'),
  controlRelease: translate(ui, 'dashboard.controlRelease', {}, 'Copy release smoke command'),
  controlReleaseCopied: translate(ui, 'dashboard.controlReleaseCopied', {}, 'Release command copied.'),
  controlReleaseCopyFailed: translate(ui, 'dashboard.controlReleaseCopyFailed', {}, 'Clipboard blocked. Copy manually.'),
  controlLimited: translate(ui, 'dashboard.controlLimited', {}, 'Admin links are visible for owner/admin roles only.'),
  ownerOpsTitle: translate(ui, 'dashboard.ownerOpsTitle', {}, 'Owner operations'),
  ownerOpsBody: translate(
    ui,
    'dashboard.ownerOpsBody',
    {},
    'Runbook-grade commands for deployment validation and infrastructure checks.'
  ),
  ownerOpsRelease: translate(ui, 'dashboard.ownerOpsRelease', {}, 'Release + smoke'),
  ownerOpsHealth: translate(ui, 'dashboard.ownerOpsHealth', {}, 'Stack health'),
  ownerOpsAccess: translate(ui, 'dashboard.ownerOpsAccess', {}, 'Access smoke'),
  ownerOpsCopy: translate(ui, 'dashboard.ownerOpsCopy', {}, 'Copy command'),
  refresh: translate(ui, 'dashboard.refresh', {}, 'Refresh'),
  loading: translate(ui, 'dashboard.loading', {}, 'Loading dashboard data...'),
  loadFailed: translate(ui, 'dashboard.loadFailed', {}, 'Some dashboard cards could not be loaded.'),
};
---

<MainLayout
  title={dashboardCopy.title}
  description={dashboardCopy.description}
  canonical={canonical}
  robots="noindex,nofollow"
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  <h1>{dashboardCopy.title}</h1>
  <p class="small">{dashboardCopy.description}</p>

  <section class="card panel gv-stack" data-dashboard-logged-out hidden>
    <h2>{dashboardCopy.loginRequiredTitle}</h2>
    <p class="small">{dashboardCopy.loginRequiredBody}</p>
    <a class="ui-button ui-button-primary ui-button-md" href={loginPath}>{dashboardCopy.loginCta}</a>
  </section>

  <section class="dashboard-shell gv-stack" data-dashboard-authenticated hidden>
    <div class="dashboard-head">
      <p class="small" data-dashboard-feedback aria-live="polite">{dashboardCopy.loading}</p>
      <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-refresh>
        <span class="ui-button-label">{dashboardCopy.refresh}</span>
      </button>
    </div>

    <nav class="dashboard-section-nav" aria-label={dashboardCopy.quickTitle}>
      <a class="dashboard-section-pill" href="#dashboard-member" data-dashboard-role-gated data-min-role="member">
        {dashboardCopy.overviewTitle}
      </a>
      <a class="dashboard-section-pill" href="#dashboard-editorial" data-dashboard-role-gated data-min-role="editor" hidden>
        {dashboardCopy.localeTitle}
      </a>
      <a class="dashboard-section-pill" href="#dashboard-control" data-dashboard-role-gated data-min-role="admin" hidden>
        {dashboardCopy.controlTitle}
      </a>
    </nav>

    <div class="dashboard-lanes">
      <section class="dashboard-lane gv-stack" id="dashboard-member" data-dashboard-lane data-min-role="member">
        <header class="dashboard-lane-head">
          <div class="dashboard-lane-title-wrap">
            <h2 class="dashboard-lane-title">{dashboardCopy.overviewTitle}</h2>
            <p class="small">{dashboardCopy.quickBody}</p>
          </div>
          <p class="dashboard-role-pill">
            <span>{dashboardCopy.accessRole}</span>
            <strong data-dashboard-role>{dashboardCopy.accessMember}</strong>
          </p>
        </header>

        <div class="dashboard-grid">
          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.overviewTitle}</h3>
            <dl class="dashboard-dl">
              <div>
                <dt>{dashboardCopy.overviewIdentity}</dt>
                <dd data-dashboard-identity>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewEmail}</dt>
                <dd data-dashboard-email>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewStatus}</dt>
                <dd data-dashboard-status>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewMemberSince}</dt>
                <dd data-dashboard-created>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewLoginAt}</dt>
                <dd data-dashboard-loginat>{dashboardCopy.unknown}</dd>
              </div>
            </dl>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.preferenceTitle}</h3>
            <p class="small">{dashboardCopy.preferenceBody}</p>
            <p class="dashboard-kpi">
              <span>{dashboardCopy.preferenceValue}</span>
              <strong data-dashboard-preferred>{dashboardCopy.unknown}</strong>
            </p>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.commentsTitle}</h3>
            <p class="small">{dashboardCopy.commentsBody}</p>
            <div class="dashboard-kpi-grid">
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsTotal}</span><strong data-dashboard-comments-total>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsPending}</span><strong data-dashboard-comments-pending>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsApproved}</span><strong data-dashboard-comments-approved>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsRejected}</span><strong data-dashboard-comments-rejected>0</strong></p>
            </div>
            <ul class="dashboard-mini-list" data-dashboard-comments-recent hidden></ul>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.accessTitle}</h3>
            <p class="small">{dashboardCopy.accessBody}</p>
            <ul class="dashboard-capabilities">
              <li>
                <span>{dashboardCopy.capabilityModeration}</span>
                <strong data-dashboard-cap-moderation>{dashboardCopy.capabilityDisabled}</strong>
              </li>
              <li>
                <span>{dashboardCopy.capabilityLocale}</span>
                <strong data-dashboard-cap-locale>{dashboardCopy.capabilityDisabled}</strong>
              </li>
              <li>
                <span>{dashboardCopy.capabilityAdminTools}</span>
                <strong data-dashboard-cap-admin>{dashboardCopy.capabilityDisabled}</strong>
              </li>
            </ul>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.quickTitle}</h3>
            <p class="small">{dashboardCopy.quickBody}</p>
            <div class="dashboard-actions">
              <a class="ui-button ui-button-secondary ui-button-sm" href={accountPath}>
                <span class="ui-button-label">{dashboardCopy.quickAccount}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={`${accountPath}#comments`}>
                <span class="ui-button-label">{dashboardCopy.quickComments}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={`${accountPath}#locale-progress`}>
                <span class="ui-button-label">{dashboardCopy.quickLocale}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={pathForLanguage(lang, 'atlas')}>
                <span class="ui-button-label">{dashboardCopy.quickAtlas}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={pathForLanguage(lang, 'blog')}>
                <span class="ui-button-label">{dashboardCopy.quickBlog}</span>
              </a>
            </div>
          </article>
        </div>
      </section>

      <section
        class="dashboard-lane gv-stack"
        id="dashboard-editorial"
        data-dashboard-lane
        data-min-role="editor"
        hidden
      >
        <header class="dashboard-lane-head">
          <div class="dashboard-lane-title-wrap">
            <h2 class="dashboard-lane-title">{dashboardCopy.localeTitle}</h2>
            <p class="small">{dashboardCopy.localeBody}</p>
          </div>
        </header>

        <div class="dashboard-grid">
          <article class="card panel gv-stack">
            <div class="gv-stack dashboard-moderation-wrap" data-dashboard-moderation-wrap hidden>
              <h3 class="dashboard-mini-title">{dashboardCopy.moderationQueueTitle}</h3>
              <p class="small">{dashboardCopy.moderationQueueBody}</p>
              <div class="dashboard-kpi-grid">
                <p class="dashboard-kpi">
                  <span>{dashboardCopy.moderationQueuePendingCount}</span>
                  <strong data-dashboard-moderation-pending>0</strong>
                </p>
                <p class="dashboard-kpi">
                  <span>{dashboardCopy.moderationQueueStaleCount}</span>
                  <strong data-dashboard-moderation-stale>0</strong>
                </p>
                <p class="dashboard-kpi">
                  <span>{dashboardCopy.moderationQueueOldest}</span>
                  <strong data-dashboard-moderation-oldest>0h</strong>
                </p>
              </div>
              <p class="small dashboard-alert" data-dashboard-moderation-alert hidden></p>
              <ul class="dashboard-mini-list" data-dashboard-moderation-list></ul>
              <h3 class="dashboard-mini-title">{dashboardCopy.moderationHistoryTitle}</h3>
              <p class="small">{dashboardCopy.moderationHistoryBody}</p>
              <ul class="dashboard-mini-list" data-dashboard-moderation-history></ul>
            </div>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.localeTitle}</h3>
            <p class="small">{dashboardCopy.localeBody}</p>
            <div class="dashboard-kpi-grid">
              <p class="dashboard-kpi"><span>{dashboardCopy.localeCoverage.replace('{lang}', lang.toUpperCase())}</span><strong data-dashboard-locale-coverage>0%</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.localeGapLocales}</span><strong data-dashboard-locale-gaps>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.localeDeployRequired}</span><strong data-dashboard-locale-deploy>0</strong></p>
            </div>
            <p class="small" data-dashboard-locale-note hidden>{dashboardCopy.localeLimited}</p>
          </article>
        </div>
      </section>

      <section
        class="dashboard-lane gv-stack"
        id="dashboard-control"
        data-dashboard-lane
        data-min-role="admin"
        hidden
      >
        <header class="dashboard-lane-head">
          <div class="dashboard-lane-title-wrap">
            <h2 class="dashboard-lane-title">{dashboardCopy.controlTitle}</h2>
            <p class="small">{dashboardCopy.controlBody}</p>
          </div>
          <p class="dashboard-role-pill">
            <span>{dashboardCopy.roleGovernanceCurrent}</span>
            <strong data-dashboard-governance-role>{dashboardCopy.accessMember}</strong>
          </p>
        </header>

        <div class="dashboard-grid">
          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.roleGovernanceTitle}</h3>
            <p class="small">{dashboardCopy.roleGovernanceBody}</p>
            <p class="small"><strong>{dashboardCopy.roleGovernanceScope}:</strong> <span data-dashboard-governance-scope>{dashboardCopy.roleGovernanceMemberScope}</span></p>
            <p class="small"><strong>{dashboardCopy.roleGovernancePolicy}:</strong> <span data-dashboard-governance-policy>{dashboardCopy.roleGovernanceMemberPolicy}</span></p>
            <div class="dashboard-actions">
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={`${strapiAdminUrl}/settings/users-permissions/roles`}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.roleGovernanceManageRoles}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={`${strapiAdminUrl}/settings/users-permissions/users`}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.roleGovernanceManageUsers}</span>
              </a>
            </div>
            <p class="small" data-dashboard-governance-limited>{dashboardCopy.roleGovernanceLimited}</p>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.controlTitle}</h3>
            <p class="small">{dashboardCopy.controlBody}</p>
            <div class="dashboard-actions">
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={strapiAdminUrl}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.controlAdmin}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href="https://github.com/inovryx/geovito-stack/blob/main/docs/LAUNCH_RUNBOOK.md"
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.controlRunbook}</span>
              </a>
              <button
                type="button"
                class="ui-button ui-button-secondary ui-button-sm"
                data-dashboard-copy-command
                data-command-value={releaseCommand}
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.controlRelease}</span>
              </button>
            </div>
            <p class="small" data-dashboard-control-note>{dashboardCopy.controlLimited}</p>
          </article>

          <article class="card panel gv-stack" data-dashboard-role-gated data-min-role="owner" hidden>
            <h3 class="dashboard-mini-title">{dashboardCopy.ownerOpsTitle}</h3>
            <p class="small">{dashboardCopy.ownerOpsBody}</p>
            <div class="dashboard-command-grid">
              <div class="dashboard-command-card">
                <strong>{dashboardCopy.ownerOpsRelease}</strong>
                <code>{releaseCommand}</code>
                <button
                  type="button"
                  class="ui-button ui-button-secondary ui-button-sm"
                  data-dashboard-copy-command
                  data-command-value={releaseCommand}
                >
                  <span class="ui-button-label">{dashboardCopy.ownerOpsCopy}</span>
                </button>
              </div>
              <div class="dashboard-command-card">
                <strong>{dashboardCopy.ownerOpsHealth}</strong>
                <code>{stackHealthCommand}</code>
                <button
                  type="button"
                  class="ui-button ui-button-secondary ui-button-sm"
                  data-dashboard-copy-command
                  data-command-value={stackHealthCommand}
                >
                  <span class="ui-button-label">{dashboardCopy.ownerOpsCopy}</span>
                </button>
              </div>
              <div class="dashboard-command-card">
                <strong>{dashboardCopy.ownerOpsAccess}</strong>
                <code>{smokeAccessCommand}</code>
                <button
                  type="button"
                  class="ui-button ui-button-secondary ui-button-sm"
                  data-dashboard-copy-command
                  data-command-value={smokeAccessCommand}
                >
                  <span class="ui-button-label">{dashboardCopy.ownerOpsCopy}</span>
                </button>
              </div>
            </div>
          </article>
        </div>
      </section>
    </div>
  </section>

  <script is:inline define:vars={{ authBaseUrl, dashboardCopy, ownerEmailHint }}>
    (() => {
      const loggedOutPanel = document.querySelector('[data-dashboard-logged-out]');
      const authedPanel = document.querySelector('[data-dashboard-authenticated]');
      const refreshButton = document.querySelector('[data-dashboard-refresh]');
      const feedback = document.querySelector('[data-dashboard-feedback]');
      const localeNote = document.querySelector('[data-dashboard-locale-note]');
      const controlNote = document.querySelector('[data-dashboard-control-note]');
      const adminLinks = Array.from(document.querySelectorAll('[data-dashboard-admin-link]'));
      const copyCommandButtons = Array.from(document.querySelectorAll('[data-dashboard-copy-command]'));
      const roleGatedNodes = Array.from(document.querySelectorAll('[data-dashboard-role-gated]'));
      const moderationWrapNode = document.querySelector('[data-dashboard-moderation-wrap]');
      const moderationListNode = document.querySelector('[data-dashboard-moderation-list]');
      const moderationHistoryNode = document.querySelector('[data-dashboard-moderation-history]');
      const moderationPendingNode = document.querySelector('[data-dashboard-moderation-pending]');
      const moderationStaleNode = document.querySelector('[data-dashboard-moderation-stale]');
      const moderationOldestNode = document.querySelector('[data-dashboard-moderation-oldest]');
      const moderationAlertNode = document.querySelector('[data-dashboard-moderation-alert]');

      const identityNode = document.querySelector('[data-dashboard-identity]');
      const emailNode = document.querySelector('[data-dashboard-email]');
      const statusNode = document.querySelector('[data-dashboard-status]');
      const createdNode = document.querySelector('[data-dashboard-created]');
      const loginAtNode = document.querySelector('[data-dashboard-loginat]');
      const preferredNode = document.querySelector('[data-dashboard-preferred]');
      const roleNode = document.querySelector('[data-dashboard-role]');
      const governanceRoleNode = document.querySelector('[data-dashboard-governance-role]');
      const governanceScopeNode = document.querySelector('[data-dashboard-governance-scope]');
      const governancePolicyNode = document.querySelector('[data-dashboard-governance-policy]');
      const governanceLimitedNoteNode = document.querySelector('[data-dashboard-governance-limited]');
      const capModerationNode = document.querySelector('[data-dashboard-cap-moderation]');
      const capLocaleNode = document.querySelector('[data-dashboard-cap-locale]');
      const capAdminNode = document.querySelector('[data-dashboard-cap-admin]');
      const commentsTotalNode = document.querySelector('[data-dashboard-comments-total]');
      const commentsPendingNode = document.querySelector('[data-dashboard-comments-pending]');
      const commentsApprovedNode = document.querySelector('[data-dashboard-comments-approved]');
      const commentsRejectedNode = document.querySelector('[data-dashboard-comments-rejected]');
      const commentsRecentNode = document.querySelector('[data-dashboard-comments-recent]');
      const localeCoverageNode = document.querySelector('[data-dashboard-locale-coverage]');
      const localeGapsNode = document.querySelector('[data-dashboard-locale-gaps]');
      const localeDeployNode = document.querySelector('[data-dashboard-locale-deploy]');
      const laneNodes = Array.from(document.querySelectorAll('[data-dashboard-lane]'));
      let currentSession = null;
      let canRunModeration = false;
      let isLoading = false;
      const STALE_PENDING_HOURS = 24;
      const roleRanks = {
        member: 0,
        editor: 1,
        admin: 2,
        owner: 3,
      };

      const toNode = (value) => (value instanceof HTMLElement ? value : null);
      const setText = (node, value) => {
        const el = toNode(node);
        if (!el) return;
        el.textContent = String(value ?? '');
      };

      const setFeedback = (message, isError = false) => {
        const el = toNode(feedback);
        if (!el) return;
        el.textContent = String(message || '');
        el.classList.toggle('is-error', Boolean(isError));
      };

      const escapeHtml = (value) =>
        String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const readSession = () => {
        try {
          const fromLocal = localStorage.getItem('geovito_auth_session');
          const fromSession = sessionStorage.getItem('geovito_auth_session');
          const raw = fromLocal || fromSession;
          if (!raw) return null;

          if (!fromLocal && fromSession) {
            localStorage.setItem('geovito_auth_session', fromSession);
          }

          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return null;
          const jwt = typeof parsed.jwt === 'string' ? parsed.jwt.trim() : '';
          if (!jwt) return null;

          return {
            jwt,
            email: typeof parsed.email === 'string' ? parsed.email.trim() : '',
            username: typeof parsed.username === 'string' ? parsed.username.trim() : '',
            loginAt: typeof parsed.loginAt === 'string' ? parsed.loginAt.trim() : '',
          };
        } catch {
          return null;
        }
      };

      const formatDate = (value) => {
        if (!value) return dashboardCopy.unknown;
        const date = new Date(String(value));
        if (Number.isNaN(date.getTime())) return dashboardCopy.unknown;
        try {
          return new Intl.DateTimeFormat(document.documentElement.lang || 'en', {
            dateStyle: 'medium',
            timeStyle: 'short',
          }).format(date);
        } catch {
          return date.toISOString();
        }
      };

      const normalizeLanguage = (value) => String(value || '').trim().toLowerCase();

      const getGovernanceCopy = (role) => {
        const normalized = String(role || '').toLowerCase();
        if (normalized === 'owner') {
          return {
            scope: dashboardCopy.roleGovernanceOwnerScope,
            policy: dashboardCopy.roleGovernanceOwnerPolicy,
          };
        }
        if (normalized === 'admin') {
          return {
            scope: dashboardCopy.roleGovernanceAdminScope,
            policy: dashboardCopy.roleGovernanceAdminPolicy,
          };
        }
        if (normalized === 'editor') {
          return {
            scope: dashboardCopy.roleGovernanceEditorScope,
            policy: dashboardCopy.roleGovernanceEditorPolicy,
          };
        }
        return {
          scope: dashboardCopy.roleGovernanceMemberScope,
          policy: dashboardCopy.roleGovernanceMemberPolicy,
        };
      };

      const inferRole = (userPayload, session) => {
        const roleRaw = String(
          userPayload?.role?.type ||
          userPayload?.role?.name ||
          userPayload?.role?.code ||
          ''
        ).trim().toLowerCase();

        if (roleRaw.includes('super') || roleRaw === 'admin' || roleRaw.includes('administrator')) {
          return 'admin';
        }
        if (roleRaw.includes('editor')) {
          return 'editor';
        }

        const email = normalizeLanguage(userPayload?.email || session?.email || '');
        if (ownerEmailHint && email && email === normalizeLanguage(ownerEmailHint)) {
          return 'owner';
        }

        return 'member';
      };

      const applyAccessView = (role) => {
        const normalizedRole = String(role || 'member').toLowerCase();
        const isOwner = normalizedRole === 'owner';
        const isAdmin = isOwner || normalizedRole === 'admin';
        const isEditor = isAdmin || normalizedRole === 'editor';
        const effectiveRole = isOwner ? 'owner' : isAdmin ? 'admin' : isEditor ? 'editor' : 'member';
        const effectiveRoleRank = Number(roleRanks[effectiveRole] ?? 0);
        canRunModeration = isEditor;

        const roleLabel = isOwner
          ? dashboardCopy.accessOwner
          : isAdmin
            ? dashboardCopy.accessAdmin
            : isEditor
              ? dashboardCopy.accessEditor
              : dashboardCopy.accessMember;
        setText(roleNode, roleLabel);
        setText(governanceRoleNode, roleLabel);

        const governanceCopy = getGovernanceCopy(
          isOwner ? 'owner' : isAdmin ? 'admin' : isEditor ? 'editor' : 'member'
        );
        setText(governanceScopeNode, governanceCopy.scope);
        setText(governancePolicyNode, governanceCopy.policy);

        setText(capModerationNode, isEditor ? dashboardCopy.capabilityEnabled : dashboardCopy.capabilityDisabled);
        setText(capLocaleNode, isEditor ? dashboardCopy.capabilityEnabled : dashboardCopy.capabilityDisabled);
        setText(capAdminNode, isAdmin ? dashboardCopy.capabilityEnabled : dashboardCopy.capabilityDisabled);

        adminLinks.forEach((link) => {
          if (!(link instanceof HTMLElement)) return;
          link.hidden = !isAdmin;
        });

        copyCommandButtons.forEach((button) => {
          if (!(button instanceof HTMLElement)) return;
          button.hidden = !isAdmin;
        });

        if (toNode(controlNote)) {
          toNode(controlNote).hidden = isAdmin;
        }

        if (toNode(governanceLimitedNoteNode)) {
          toNode(governanceLimitedNoteNode).hidden = isAdmin;
        }

        if (toNode(moderationWrapNode)) {
          toNode(moderationWrapNode).hidden = !canRunModeration;
        }

        laneNodes.forEach((lane) => {
          if (!(lane instanceof HTMLElement)) return;
          const minRole = String(lane.getAttribute('data-min-role') || 'member').toLowerCase();
          const minRoleRank = Number(roleRanks[minRole] ?? 0);
          lane.hidden = effectiveRoleRank < minRoleRank;
        });

        roleGatedNodes.forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          const minRole = String(node.getAttribute('data-min-role') || 'member').toLowerCase();
          const minRoleRank = Number(roleRanks[minRole] ?? 0);
          node.hidden = effectiveRoleRank < minRoleRank;
        });

        return {
          isOwner,
          isAdmin,
          isEditor,
        };
      };

      const renderRecentComments = (items) => {
        const host = toNode(commentsRecentNode);
        if (!host) return;
        host.innerHTML = '';

        const list = Array.isArray(items) ? items.slice(0, 5) : [];
        host.hidden = list.length === 0;
        if (list.length === 0) return;

        const fragment = document.createDocumentFragment();
        list.forEach((item) => {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';
          const status = String(item?.status || '').trim().toUpperCase() || '-';
          const body = String(item?.body || '').trim() || '-';
          const compactBody = body.length > 110 ? `${body.slice(0, 107)}...` : body;
          row.innerHTML = `<strong>${status}</strong><span>${compactBody}</span>`;
          fragment.appendChild(row);
        });

        host.appendChild(fragment);
      };

      const renderModerationQueue = (items) => {
        const host = toNode(moderationListNode);
        if (!host) return;

        host.innerHTML = '';

        const sourceList = Array.isArray(items) ? items : [];
        let staleCount = 0;
        let oldestHours = 0;
        const nowMs = Date.now();

        sourceList.forEach((item) => {
          const createdRaw = String(
            item?.created_at ||
            item?.createdAt ||
            item?.submitted_at ||
            ''
          ).trim();
          if (!createdRaw) return;

          const createdMs = new Date(createdRaw).getTime();
          if (!Number.isFinite(createdMs) || createdMs <= 0) return;

          const ageHours = Math.max(0, Math.floor((nowMs - createdMs) / 3600000));
          if (ageHours > oldestHours) oldestHours = ageHours;
          if (ageHours >= STALE_PENDING_HOURS) staleCount += 1;
        });

        setText(moderationPendingNode, String(sourceList.length));
        setText(moderationStaleNode, String(staleCount));
        setText(moderationOldestNode, `${oldestHours}h`);

        const alertEl = toNode(moderationAlertNode);
        if (alertEl) {
          if (staleCount > 0) {
            alertEl.hidden = false;
            alertEl.textContent = dashboardCopy.moderationQueueStaleAlert
              .replace('{count}', String(staleCount))
              .replace('{hours}', String(STALE_PENDING_HOURS));
          } else {
            alertEl.hidden = true;
            alertEl.textContent = '';
          }
        }

        const list = sourceList.slice(0, 8);
        if (!canRunModeration || list.length === 0) {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';
          row.innerHTML = `<span>${escapeHtml(dashboardCopy.moderationQueueEmpty)}</span>`;
          host.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        list.forEach((item) => {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item dashboard-moderation-item';
          const status = String(item?.status || '').trim().toUpperCase() || '-';
          const body = String(item?.body || '').trim() || '-';
          const compactBody = body.length > 120 ? `${body.slice(0, 117)}...` : body;
          const commentId = String(item?.comment_id || '').trim();
          const author = String(item?.display_name || item?.source || '').trim() || '-';
          const postRef = String(item?.blog_post_ref || '').trim() || '-';
          row.innerHTML = `
            <strong>${escapeHtml(status)} · ${escapeHtml(author)}</strong>
            <span>${escapeHtml(compactBody)}</span>
            <span>${escapeHtml(dashboardCopy.moderationHistoryPost)}: ${escapeHtml(postRef)}</span>
            <div class="dashboard-action-row">
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-moderate="approved" data-comment-id="${escapeHtml(commentId)}">
                <span class="ui-button-label">${escapeHtml(dashboardCopy.moderationApprove)}</span>
              </button>
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-moderate="rejected" data-comment-id="${escapeHtml(commentId)}">
                <span class="ui-button-label">${escapeHtml(dashboardCopy.moderationReject)}</span>
              </button>
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-moderate="spam" data-comment-id="${escapeHtml(commentId)}">
                <span class="ui-button-label">${escapeHtml(dashboardCopy.moderationSpam)}</span>
              </button>
            </div>
          `;
          fragment.appendChild(row);
        });

        host.appendChild(fragment);
      };

      const renderModerationHistory = (items) => {
        const host = toNode(moderationHistoryNode);
        if (!host) return;

        host.innerHTML = '';
        const list = Array.isArray(items) ? items.slice(0, 8) : [];
        if (!canRunModeration || list.length === 0) {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';
          row.innerHTML = `<span>${escapeHtml(dashboardCopy.moderationHistoryEmpty)}</span>`;
          host.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        list.forEach((item) => {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';

          const status = String(item?.status || '').trim().toUpperCase() || '-';
          const reviewer = String(item?.reviewed_by || '').trim() || '-';
          const reviewedAt = String(item?.reviewed_at || item?.updated_at || '').trim();
          const reviewedAtLabel = reviewedAt ? formatDate(reviewedAt) : dashboardCopy.unknown;
          const body = String(item?.body || '').trim() || '-';
          const compactBody = body.length > 120 ? `${body.slice(0, 117)}...` : body;
          const postRef = String(item?.blog_post_ref || '').trim() || '-';
          const moderationNote = String(item?.moderation_notes || '').trim();

          row.innerHTML = `
            <strong>${escapeHtml(status)} · ${escapeHtml(reviewer)} · ${escapeHtml(reviewedAtLabel)}</strong>
            <span>${escapeHtml(compactBody)}</span>
            <span>${escapeHtml(dashboardCopy.moderationHistoryPost)}: ${escapeHtml(postRef)}</span>
            ${moderationNote ? `<span>${escapeHtml(dashboardCopy.moderationHistoryNote)}: ${escapeHtml(moderationNote)}</span>` : ''}
          `;
          fragment.appendChild(row);
        });

        host.appendChild(fragment);
      };

      const runModerationAction = async (session, commentId, status) => {
        if (!session?.jwt || !commentId || !status) return false;

        let moderationNotes = '';
        if (status === 'rejected' || status === 'spam') {
          moderationNotes = String(window.prompt(dashboardCopy.moderationNotesPrompt, '') || '').trim();
          if (!moderationNotes) {
            setFeedback(dashboardCopy.moderationNotesRequired, true);
            return false;
          }
        }

        const response = await fetch(`${authBaseUrl}/api/blog-comments/moderation/set`, {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            Authorization: `Bearer ${session.jwt}`,
          },
          body: JSON.stringify({
            comment_id: commentId,
            status,
            moderation_notes: moderationNotes || undefined,
          }),
        });

        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          const message = String(payload?.error?.message || dashboardCopy.moderationActionFailed);
          setFeedback(message, true);
          return false;
        }

        setFeedback(dashboardCopy.moderationActionSuccess);
        return true;
      };

      const loadDashboard = async (session) => {
        if (isLoading) return;
        isLoading = true;
        setFeedback(dashboardCopy.loading);

        setText(identityNode, session.username || session.email || dashboardCopy.unknown);
        setText(emailNode, session.email || dashboardCopy.unknown);
        setText(loginAtNode, formatDate(session.loginAt));
        setText(statusNode, dashboardCopy.statusActive);
        setText(createdNode, dashboardCopy.unknown);
        setText(preferredNode, normalizeLanguage(document.documentElement.lang || 'en').toUpperCase());
        applyAccessView('member');
        renderRecentComments([]);
        renderModerationQueue([]);
        renderModerationHistory([]);

        setText(commentsTotalNode, '0');
        setText(commentsPendingNode, '0');
        setText(commentsApprovedNode, '0');
        setText(commentsRejectedNode, '0');
        setText(moderationPendingNode, '0');
        setText(moderationStaleNode, '0');
        setText(moderationOldestNode, '0h');
        if (toNode(moderationAlertNode)) {
          toNode(moderationAlertNode).hidden = true;
        }

        setText(localeCoverageNode, '0%');
        setText(localeGapsNode, '0');
        setText(localeDeployNode, '0');
        if (toNode(localeNote)) {
          toNode(localeNote).hidden = true;
        }

        let hadErrors = false;

        const authHeaders = {
          Accept: 'application/json',
          Authorization: `Bearer ${session.jwt}`,
        };

        let userPayload = null;

        try {
          const response = await fetch(`${authBaseUrl}/api/users/me?populate=role`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => null);
            userPayload = payload;
            setText(identityNode, payload?.username || session.username || session.email || dashboardCopy.unknown);
            setText(emailNode, payload?.email || session.email || dashboardCopy.unknown);
            setText(createdNode, formatDate(payload?.createdAt));
            if (payload?.blocked === true) {
              setText(statusNode, dashboardCopy.statusBlocked);
            } else if (payload?.confirmed === false) {
              setText(statusNode, dashboardCopy.statusPending);
            } else {
              setText(statusNode, dashboardCopy.statusActive);
            }
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        const access = applyAccessView(inferRole(userPayload, session));

        try {
          const response = await fetch(`${authBaseUrl}/api/user-preferences/me`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => null);
            const preferred = normalizeLanguage(payload?.data?.preferred_ui_language || '');
            if (preferred) {
              setText(preferredNode, preferred.toUpperCase());
            }
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        try {
          const response = await fetch(`${authBaseUrl}/api/blog-comments/me/list?limit=30`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => ({}));
            const items = Array.isArray(payload?.data) ? payload.data : [];
            const pending = items.filter((item) => String(item?.status || '').toLowerCase() === 'pending').length;
            const approved = items.filter((item) => String(item?.status || '').toLowerCase() === 'approved').length;
            const rejected = items.filter((item) => {
              const status = String(item?.status || '').toLowerCase();
              return status === 'rejected' || status === 'spam' || status === 'deleted';
            }).length;

            setText(commentsTotalNode, String(items.length));
            setText(commentsPendingNode, String(pending));
            setText(commentsApprovedNode, String(approved));
            setText(commentsRejectedNode, String(rejected));
            renderRecentComments(items);
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        if (access.isEditor) {
          try {
            const response = await fetch(
              `${authBaseUrl}/api/blog-comments/moderation/list?status=all&limit=40`,
              { headers: authHeaders }
            );
            if (response.ok) {
              const payload = await response.json().catch(() => ({}));
              const items = Array.isArray(payload?.data) ? payload.data : [];
              const pendingItems = items.filter((item) => String(item?.status || '').toLowerCase() === 'pending');
              const reviewedItems = items
                .filter((item) => String(item?.status || '').toLowerCase() !== 'pending')
                .sort((a, b) => {
                  const aTs = new Date(String(a?.reviewed_at || a?.updated_at || a?.created_at || 0)).getTime();
                  const bTs = new Date(String(b?.reviewed_at || b?.updated_at || b?.created_at || 0)).getTime();
                  return Number.isFinite(bTs) && Number.isFinite(aTs) ? bTs - aTs : 0;
                });
              renderModerationQueue(pendingItems);
              renderModerationHistory(reviewedItems);
            } else {
              hadErrors = true;
            }
          } catch {
            hadErrors = true;
          }
        } else {
          renderModerationQueue([]);
          renderModerationHistory([]);
        }

        try {
          const response = await fetch(`${authBaseUrl}/api/ui-locales/meta/progress?reference_locale=en`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => ({}));
            const rows = Array.isArray(payload?.data?.locales) ? payload.data.locales : [];
            const summary = payload?.data?.summary && typeof payload.data.summary === 'object' ? payload.data.summary : {};
            const currentLocale = normalizeLanguage(document.documentElement.lang || 'en');
            const currentRow = rows.find((row) => normalizeLanguage(row?.ui_locale) === currentLocale) || null;

            const coverage = Number(currentRow?.coverage_percent || 0);
            const gapLocales = rows.filter((row) => Number(row?.missing_keys || 0) + Number(row?.untranslated_keys || 0) > 0).length;
            const deployRequired = Number(summary?.deploy_required_count || 0);

            setText(localeCoverageNode, `${Math.round(coverage * 100) / 100}%`);
            setText(localeGapsNode, String(gapLocales));
            setText(localeDeployNode, String(deployRequired));
          } else if (response.status === 401 || response.status === 403) {
            if (toNode(localeNote)) {
              toNode(localeNote).hidden = false;
            }
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        if (hadErrors) {
          setFeedback(dashboardCopy.loadFailed, true);
        } else {
          setFeedback('');
        }
        isLoading = false;
      };

      const init = async () => {
        const session = readSession();
        if (!session) {
          if (toNode(loggedOutPanel)) toNode(loggedOutPanel).hidden = false;
          if (toNode(authedPanel)) toNode(authedPanel).hidden = true;
          return;
        }

        currentSession = session;
        if (toNode(loggedOutPanel)) toNode(loggedOutPanel).hidden = true;
        if (toNode(authedPanel)) toNode(authedPanel).hidden = false;

        await loadDashboard(session);

        if (refreshButton instanceof HTMLButtonElement) {
          refreshButton.addEventListener('click', async () => {
            refreshButton.disabled = true;
            try {
              await loadDashboard(session);
            } finally {
              refreshButton.disabled = false;
            }
          });
        }

        copyCommandButtons.forEach((button) => {
          if (!(button instanceof HTMLButtonElement)) return;
          button.addEventListener('click', async () => {
            const command = String(button.dataset.commandValue || '').trim();
            if (!command) return;
            try {
              await navigator.clipboard.writeText(command);
              setFeedback(dashboardCopy.controlReleaseCopied);
            } catch {
              setFeedback(`${dashboardCopy.controlReleaseCopyFailed} ${command}`, true);
            }
          });
        });

        if (moderationListNode instanceof HTMLElement) {
          moderationListNode.addEventListener('click', async (event) => {
            const target = event.target;
            const button =
              target instanceof HTMLElement ? target.closest('[data-dashboard-moderate]') : null;
            if (!(button instanceof HTMLButtonElement)) return;
            if (!canRunModeration || !currentSession) return;

            const commentId = String(button.dataset.commentId || '').trim();
            const status = String(button.dataset.dashboardModerate || '').trim().toLowerCase();
            if (!commentId || !status) return;

            button.disabled = true;
            try {
              const ok = await runModerationAction(currentSession, commentId, status);
              if (ok) {
                await loadDashboard(currentSession);
              }
            } finally {
              button.disabled = false;
            }
          });
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        void init();
      }
    })();
  </script>
</MainLayout>

<style>
  .dashboard-shell {
    gap: 1rem;
  }

  .dashboard-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .dashboard-section-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }

  .dashboard-section-pill {
    display: inline-flex;
    align-items: center;
    min-height: 1.9rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--ink);
    font-size: 0.78rem;
    font-weight: 600;
    padding: 0.18rem 0.64rem;
  }

  .dashboard-section-pill:hover {
    text-decoration: none;
    border-color: color-mix(in srgb, var(--brand) 28%, var(--border));
    background: var(--brand-soft);
  }

  .dashboard-lanes {
    display: grid;
    gap: 0.95rem;
  }

  .dashboard-lane {
    border: 1px solid var(--border);
    border-radius: 0.9rem;
    background: color-mix(in srgb, var(--surface-2) 68%, transparent);
    padding: 0.75rem;
  }

  .dashboard-lane-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .dashboard-lane-title-wrap {
    display: grid;
    gap: 0.2rem;
  }

  .dashboard-lane-title {
    margin: 0;
    font-size: 1.02rem;
    font-weight: 700;
  }

  .dashboard-role-pill {
    margin: 0;
    display: grid;
    gap: 0.1rem;
    text-align: right;
    padding: 0.42rem 0.58rem;
    border: 1px solid var(--border);
    border-radius: 0.72rem;
    background: var(--surface-2);
  }

  .dashboard-role-pill span {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--ink-muted);
  }

  .dashboard-role-pill strong {
    font-size: 0.84rem;
    color: var(--ink);
  }

  .dashboard-grid {
    display: grid;
    gap: 0.875rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .dashboard-dl {
    margin: 0;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .dashboard-dl dt {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--ink-muted);
  }

  .dashboard-dl dd {
    margin: 0.25rem 0 0;
    font-weight: 600;
    color: var(--ink);
  }

  .dashboard-kpi-grid {
    display: grid;
    gap: 0.55rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .dashboard-kpi {
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.12rem;
    padding: 0.55rem 0.65rem;
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    background: var(--surface-2);
  }

  .dashboard-kpi span {
    color: var(--ink-muted);
    font-size: 0.78rem;
  }

  .dashboard-kpi strong {
    font-size: 1rem;
    line-height: 1.2;
  }

  .dashboard-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .dashboard-command-grid {
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .dashboard-command-card {
    display: grid;
    gap: 0.45rem;
    padding: 0.6rem;
    border: 1px solid var(--border);
    border-radius: 0.72rem;
    background: var(--surface-2);
  }

  .dashboard-command-card strong {
    font-size: 0.83rem;
    color: var(--ink);
  }

  .dashboard-command-card code {
    display: block;
    font-size: 0.72rem;
    line-height: 1.35;
    color: var(--ink-muted);
    word-break: break-word;
  }

  .dashboard-capabilities {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.45rem;
  }

  .dashboard-capabilities li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.5rem 0.65rem;
    border-radius: 0.65rem;
    border: 1px solid var(--border);
    background: var(--surface-2);
    font-size: 0.84rem;
  }

  .dashboard-capabilities strong {
    font-size: 0.78rem;
    color: var(--ink-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .dashboard-mini-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.45rem;
  }

  .dashboard-mini-item {
    border: 1px solid var(--border);
    border-radius: 0.65rem;
    background: var(--surface-2);
    padding: 0.5rem 0.6rem;
    display: grid;
    gap: 0.2rem;
  }

  .dashboard-mini-item strong {
    font-size: 0.74rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .dashboard-mini-item span {
    font-size: 0.85rem;
    color: var(--ink);
    line-height: 1.35;
  }

  .dashboard-mini-title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 700;
  }

  .dashboard-moderation-wrap {
    padding-top: 0.25rem;
  }

  .dashboard-moderation-item {
    gap: 0.45rem;
  }

  .dashboard-alert {
    color: #b9382f;
    font-weight: 600;
  }

  .dashboard-action-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  @media (max-width: 960px) {
    .dashboard-lane-head {
      flex-direction: column;
      align-items: flex-start;
    }

    .dashboard-role-pill {
      text-align: left;
      width: 100%;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .dashboard-command-grid {
      grid-template-columns: 1fr;
    }

    .dashboard-dl {
      grid-template-columns: 1fr;
    }
  }
</style>
