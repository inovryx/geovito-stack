---
import MainLayout from '../../../layouts/MainLayout.astro';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { resolveStrapiBaseUrl } from '../../../lib/strapiConfig';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'dashboard')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage('en', 'dashboard'));
const loginPath = pathForLanguage(lang, 'login');
const accountPath = pathForLanguage(lang, 'account');
const homePath = pathForLanguage(lang, '');
const releaseCommand = 'bash tools/release_deploy_smoke.sh --with-moderation --with-account-test --with-blog-engagement-test';
const stackHealthCommand = 'bash tools/stack_health.sh';
const smokeAccessCommand = 'bash tools/smoke_access.sh';
const launchRunbookUrl = 'https://github.com/inovryx/geovito-stack/blob/main/docs/LAUNCH_RUNBOOK.md';
const ownerEmailHint = String(import.meta.env.PUBLIC_OWNER_EMAIL || '').trim().toLowerCase();
const authBaseUrl = resolveStrapiBaseUrl({
  STRAPI_URL: import.meta.env.STRAPI_URL as string | undefined,
  PUBLIC_STRAPI_URL: import.meta.env.PUBLIC_STRAPI_URL as string | undefined,
  CF_PAGES: process.env.CF_PAGES,
  NODE_ENV: process.env.NODE_ENV,
  ALLOW_LOCALHOST_STRAPI:
    process.env.ALLOW_LOCALHOST_STRAPI || (import.meta.env.ALLOW_LOCALHOST_STRAPI as string | undefined),
});
const strapiAdminUrl = `${authBaseUrl.replace(/\/$/, '')}/admin`;

const dashboardCopy = {
  title: translate(ui, 'dashboard.title', {}, 'Dashboard'),
  description: translate(ui, 'dashboard.description', {}, 'Review account activity and moderation visibility from one place.'),
  loginRequiredTitle: translate(ui, 'dashboard.loginRequiredTitle', {}, 'Login required'),
  loginRequiredBody: translate(
    ui,
    'dashboard.loginRequiredBody',
    {},
    'Sign in first to load your dashboard session and observation cards.'
  ),
  loginCta: translate(ui, 'dashboard.loginCta', {}, 'Go to login'),
  overviewTitle: translate(ui, 'dashboard.overviewTitle', {}, 'Session overview'),
  overviewIdentity: translate(ui, 'dashboard.overviewIdentity', {}, 'Identity'),
  overviewEmail: translate(ui, 'dashboard.overviewEmail', {}, 'Email'),
  overviewStatus: translate(ui, 'dashboard.overviewStatus', {}, 'Status'),
  overviewMemberSince: translate(ui, 'dashboard.overviewMemberSince', {}, 'Member since'),
  overviewLoginAt: translate(ui, 'dashboard.overviewLoginAt', {}, 'Last login'),
  statusActive: translate(ui, 'dashboard.statusActive', {}, 'Active'),
  statusPending: translate(ui, 'dashboard.statusPending', {}, 'Pending confirmation'),
  statusBlocked: translate(ui, 'dashboard.statusBlocked', {}, 'Blocked'),
  unknown: translate(ui, 'dashboard.unknown', {}, 'Unknown'),
  preferenceTitle: translate(ui, 'dashboard.preferenceTitle', {}, 'Language preference'),
  preferenceBody: translate(
    ui,
    'dashboard.preferenceBody',
    {},
    'Preferred UI language saved to your profile.'
  ),
  preferenceValue: translate(ui, 'dashboard.preferenceValue', {}, 'Preferred language'),
  commentsTitle: translate(ui, 'dashboard.commentsTitle', {}, 'My comment moderation'),
  commentsBody: translate(
    ui,
    'dashboard.commentsBody',
    {},
    'Quick status from your latest comments.'
  ),
  commentsTotal: translate(ui, 'dashboard.commentsTotal', {}, 'Total'),
  commentsPending: translate(ui, 'dashboard.commentsPending', {}, 'Pending'),
  commentsApproved: translate(ui, 'dashboard.commentsApproved', {}, 'Approved'),
  commentsRejected: translate(ui, 'dashboard.commentsRejected', {}, 'Rejected/Spam'),
  moderationQueueTitle: translate(ui, 'dashboard.moderationQueueTitle', {}, 'Pending moderation queue'),
  moderationQueueBody: translate(
    ui,
    'dashboard.moderationQueueBody',
    {},
    'Editor/admin roles can approve, reject, or mark spam directly from dashboard.'
  ),
  moderationQueuePendingCount: translate(ui, 'dashboard.moderationQueuePendingCount', {}, 'Pending items'),
  moderationQueueStaleCount: translate(ui, 'dashboard.moderationQueueStaleCount', {}, 'Older than 24h'),
  moderationQueueOldest: translate(ui, 'dashboard.moderationQueueOldest', {}, 'Oldest pending'),
  moderationQueueStaleAlert: translate(
    ui,
    'dashboard.moderationQueueStaleAlert',
    {},
    '{count} pending comments are older than {hours}h.'
  ),
  moderationQueueEmpty: translate(ui, 'dashboard.moderationQueueEmpty', {}, 'No pending comments in queue.'),
  moderationHistoryTitle: translate(ui, 'dashboard.moderationHistoryTitle', {}, 'Recent moderation actions'),
  moderationHistoryBody: translate(
    ui,
    'dashboard.moderationHistoryBody',
    {},
    'Latest approved/rejected/spam actions with reviewer and timestamp.'
  ),
  moderationHistoryEmpty: translate(ui, 'dashboard.moderationHistoryEmpty', {}, 'No recent moderation actions yet.'),
  moderationHistoryPost: translate(ui, 'dashboard.moderationHistoryPost', {}, 'Post'),
  moderationHistoryNote: translate(ui, 'dashboard.moderationHistoryNote', {}, 'Note'),
  moderationApprove: translate(ui, 'dashboard.moderationApprove', {}, 'Approve'),
  moderationReject: translate(ui, 'dashboard.moderationReject', {}, 'Reject'),
  moderationSpam: translate(ui, 'dashboard.moderationSpam', {}, 'Spam'),
  moderationNotesPrompt: translate(
    ui,
    'dashboard.moderationNotesPrompt',
    {},
    'Enter moderation note (required for reject/spam):'
  ),
  moderationNotesRequired: translate(ui, 'dashboard.moderationNotesRequired', {}, 'Moderation note is required for this action.'),
  moderationActionSuccess: translate(ui, 'dashboard.moderationActionSuccess', {}, 'Moderation update saved.'),
  moderationActionFailed: translate(ui, 'dashboard.moderationActionFailed', {}, 'Moderation update failed.'),
  localeTitle: translate(ui, 'dashboard.localeTitle', {}, 'Translation visibility'),
  localeBody: translate(
    ui,
    'dashboard.localeBody',
    {},
    'Locale progress is visible for editorial permissions.'
  ),
  localeCoverage: translate(ui, 'dashboard.localeCoverage', {}, 'Coverage ({lang})'),
  localeGapLocales: translate(ui, 'dashboard.localeGapLocales', {}, 'Locales with gaps'),
  localeDeployRequired: translate(ui, 'dashboard.localeDeployRequired', {}, 'Locales pending deploy'),
  localeLimited: translate(ui, 'dashboard.localeLimited', {}, 'Limited: editor/admin permission required'),
  quickTitle: translate(ui, 'dashboard.quickTitle', {}, 'Quick actions'),
  quickBody: translate(ui, 'dashboard.quickBody', {}, 'Open account settings or continue product workflows.'),
  quickAccount: translate(ui, 'dashboard.quickAccount', {}, 'Open account settings'),
  quickComments: translate(ui, 'dashboard.quickComments', {}, 'Open my comment queue'),
  quickLocale: translate(ui, 'dashboard.quickLocale', {}, 'Open translation progress'),
  quickModeration: translate(ui, 'dashboard.quickModeration', {}, 'Open moderation queue'),
  quickControl: translate(ui, 'dashboard.quickControl', {}, 'Open control center'),
  quickOwnerOps: translate(ui, 'dashboard.quickOwnerOps', {}, 'Open owner operations'),
  quickAtlas: translate(ui, 'dashboard.quickAtlas', {}, 'Go to atlas'),
  quickBlog: translate(ui, 'dashboard.quickBlog', {}, 'Go to blog'),
  navHome: translate(ui, 'nav.home', {}, 'Home'),
  navAtlas: translate(ui, 'nav.atlas', {}, 'Atlas'),
  navBlog: translate(ui, 'nav.blog', {}, 'Blog'),
  accessTitle: translate(ui, 'dashboard.accessTitle', {}, 'Access level'),
  accessBody: translate(
    ui,
    'dashboard.accessBody',
    {},
    'Role-driven capability map for dashboard visibility. Backend permissions remain authoritative.'
  ),
  accessRole: translate(ui, 'dashboard.accessRole', {}, 'Role'),
  accessOwner: translate(ui, 'dashboard.accessOwner', {}, 'Owner'),
  accessAdmin: translate(ui, 'dashboard.accessAdmin', {}, 'Admin'),
  accessEditor: translate(ui, 'dashboard.accessEditor', {}, 'Editor'),
  accessMember: translate(ui, 'dashboard.accessMember', {}, 'Member'),
  roleGovernanceTitle: translate(ui, 'dashboard.roleGovernanceTitle', {}, 'Role governance'),
  roleGovernanceBody: translate(
    ui,
    'dashboard.roleGovernanceBody',
    {},
    'Role mapping for owner/admin/editor/member and where permissions are managed.'
  ),
  roleGovernanceCurrent: translate(ui, 'dashboard.roleGovernanceCurrent', {}, 'Current role'),
  roleGovernanceScope: translate(ui, 'dashboard.roleGovernanceScope', {}, 'Scope'),
  roleGovernancePolicy: translate(ui, 'dashboard.roleGovernancePolicy', {}, 'Policy'),
  roleGovernanceOwnerScope: translate(
    ui,
    'dashboard.roleGovernanceOwnerScope',
    {},
    'Full stack governance and production operations.'
  ),
  roleGovernanceOwnerPolicy: translate(
    ui,
    'dashboard.roleGovernanceOwnerPolicy',
    {},
    'Can assign/revoke admin and editor responsibilities.'
  ),
  roleGovernanceAdminScope: translate(
    ui,
    'dashboard.roleGovernanceAdminScope',
    {},
    'Operational admin controls and moderation oversight.'
  ),
  roleGovernanceAdminPolicy: translate(
    ui,
    'dashboard.roleGovernanceAdminPolicy',
    {},
    'Can manage editors and moderation workflows.'
  ),
  roleGovernanceEditorScope: translate(
    ui,
    'dashboard.roleGovernanceEditorScope',
    {},
    'Editorial workflows, locale progress, and comment moderation.'
  ),
  roleGovernanceEditorPolicy: translate(
    ui,
    'dashboard.roleGovernanceEditorPolicy',
    {},
    'Cannot assign roles; escalation via admin/owner only.'
  ),
  roleGovernanceMemberScope: translate(
    ui,
    'dashboard.roleGovernanceMemberScope',
    {},
    'Personal profile and own engagement visibility.'
  ),
  roleGovernanceMemberPolicy: translate(
    ui,
    'dashboard.roleGovernanceMemberPolicy',
    {},
    'Role changes require owner/admin action.'
  ),
  roleGovernanceManageRoles: translate(ui, 'dashboard.roleGovernanceManageRoles', {}, 'Manage roles'),
  roleGovernanceManageUsers: translate(ui, 'dashboard.roleGovernanceManageUsers', {}, 'Manage users'),
  roleGovernanceLimited: translate(
    ui,
    'dashboard.roleGovernanceLimited',
    {},
    'Role management links are visible for owner/admin only.'
  ),
  capabilityModeration: translate(ui, 'dashboard.capabilityModeration', {}, 'Moderation view'),
  capabilityLocale: translate(ui, 'dashboard.capabilityLocale', {}, 'Translation progress'),
  capabilityAdminTools: translate(ui, 'dashboard.capabilityAdminTools', {}, 'Admin tools links'),
  capabilityEnabled: translate(ui, 'dashboard.capabilityEnabled', {}, 'Enabled'),
  capabilityDisabled: translate(ui, 'dashboard.capabilityDisabled', {}, 'Limited'),
  controlTitle: translate(ui, 'dashboard.controlTitle', {}, 'Control center'),
  controlBody: translate(
    ui,
    'dashboard.controlBody',
    {},
    'Owner/admin shortcuts for operational panels. UI visibility is role-based; backend still enforces access.'
  ),
  controlAdmin: translate(ui, 'dashboard.controlAdmin', {}, 'Open Strapi admin'),
  controlRunbook: translate(ui, 'dashboard.controlRunbook', {}, 'Open launch runbook'),
  controlRelease: translate(ui, 'dashboard.controlRelease', {}, 'Copy release smoke command'),
  controlReleaseCopied: translate(ui, 'dashboard.controlReleaseCopied', {}, 'Release command copied.'),
  controlReleaseCopyFailed: translate(ui, 'dashboard.controlReleaseCopyFailed', {}, 'Clipboard blocked. Copy manually.'),
  controlLimited: translate(ui, 'dashboard.controlLimited', {}, 'Admin links are visible for owner/admin roles only.'),
  ownerOpsTitle: translate(ui, 'dashboard.ownerOpsTitle', {}, 'Owner operations'),
  ownerOpsBody: translate(
    ui,
    'dashboard.ownerOpsBody',
    {},
    'Runbook-grade commands for deployment validation and infrastructure checks.'
  ),
  ownerOpsRelease: translate(ui, 'dashboard.ownerOpsRelease', {}, 'Release + smoke'),
  ownerOpsHealth: translate(ui, 'dashboard.ownerOpsHealth', {}, 'Stack health'),
  ownerOpsAccess: translate(ui, 'dashboard.ownerOpsAccess', {}, 'Access smoke'),
  ownerOpsCopy: translate(ui, 'dashboard.ownerOpsCopy', {}, 'Copy command'),
  ownerSummaryTitle: translate(ui, 'dashboard.ownerSummaryTitle', {}, 'Owner summary'),
  ownerSummaryBody: translate(
    ui,
    'dashboard.ownerSummaryBody',
    {},
    'Single-card snapshot for deployment and operational readiness.'
  ),
  ownerSummaryBuildSha: translate(ui, 'dashboard.ownerSummaryBuildSha', {}, 'Live build SHA'),
  ownerSummaryReleaseStatus: translate(ui, 'dashboard.ownerSummaryReleaseStatus', {}, 'Release status'),
  ownerSummaryPending: translate(ui, 'dashboard.ownerSummaryPending', {}, 'Pending moderation'),
  ownerSummaryLocaleGaps: translate(ui, 'dashboard.ownerSummaryLocaleGaps', {}, 'Locale gaps'),
  ownerSummaryLocaleDeploy: translate(ui, 'dashboard.ownerSummaryLocaleDeploy', {}, 'Locales pending deploy'),
  ownerSummaryRefreshedAt: translate(ui, 'dashboard.ownerSummaryRefreshedAt', {}, 'Refreshed at'),
  ownerSummaryStatusLive: translate(ui, 'dashboard.ownerSummaryStatusLive', {}, 'Live'),
  ownerSummaryStatusAttention: translate(ui, 'dashboard.ownerSummaryStatusAttention', {}, 'Needs attention'),
  ownerSummaryStatusUnknown: translate(ui, 'dashboard.ownerSummaryStatusUnknown', {}, 'Unknown'),
  activityTitle: translate(ui, 'dashboard.activityTitle', {}, 'Activity feed'),
  activityBody: translate(
    ui,
    'dashboard.activityBody',
    {},
    'Recent operational signals from moderation, locale, and release checks.'
  ),
  activityEmpty: translate(ui, 'dashboard.activityEmpty', {}, 'No recent activity signals.'),
  activityLevelOk: translate(ui, 'dashboard.activityLevelOk', {}, 'OK'),
  activityLevelInfo: translate(ui, 'dashboard.activityLevelInfo', {}, 'INFO'),
  activityLevelWarn: translate(ui, 'dashboard.activityLevelWarn', {}, 'WARN'),
  activityBuildLive: translate(ui, 'dashboard.activityBuildLive', {}, 'Build {sha} is live.'),
  activityBuildUnknown: translate(ui, 'dashboard.activityBuildUnknown', {}, 'Build fingerprint unavailable.'),
  activityPending: translate(ui, 'dashboard.activityPending', {}, '{count} comments are pending moderation.'),
  activityPendingStale: translate(ui, 'dashboard.activityPendingStale', {}, '{count} pending comments are older than {hours}h.'),
  activityLocaleGaps: translate(ui, 'dashboard.activityLocaleGaps', {}, '{count} locales have UI translation gaps.'),
  activityLocaleDeploy: translate(ui, 'dashboard.activityLocaleDeploy', {}, '{count} locales are pending deploy sync.'),
  activityAllClear: translate(ui, 'dashboard.activityAllClear', {}, 'Operational signals are clean.'),
  activityLoadFailed: translate(ui, 'dashboard.activityLoadFailed', {}, 'Some dashboard data failed to load.'),
  activityActionModeration: translate(ui, 'dashboard.activityActionModeration', {}, 'Moderation'),
  activityActionTranslations: translate(ui, 'dashboard.activityActionTranslations', {}, 'Translations'),
  activityActionRunbook: translate(ui, 'dashboard.activityActionRunbook', {}, 'Runbook'),
  activityFilterWarnOnly: translate(ui, 'dashboard.activityFilterWarnOnly', {}, 'Show WARN only'),
  activityWarnOnlyEmpty: translate(ui, 'dashboard.activityWarnOnlyEmpty', {}, 'No warnings right now.'),
  activityNow: translate(ui, 'dashboard.activityNow', {}, 'just now'),
  activityClearHistory: translate(ui, 'dashboard.activityClearHistory', {}, 'Clear history'),
  activityClearHistoryDone: translate(ui, 'dashboard.activityClearHistoryDone', {}, 'Activity history cleared.'),
  refresh: translate(ui, 'dashboard.refresh', {}, 'Refresh'),
  loading: translate(ui, 'dashboard.loading', {}, 'Loading dashboard data...'),
  loadFailed: translate(ui, 'dashboard.loadFailed', {}, 'Some dashboard cards could not be loaded.'),
};
---

<MainLayout
  title={dashboardCopy.title}
  description={dashboardCopy.description}
  canonical={canonical}
  robots="noindex,nofollow"
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  <h1>{dashboardCopy.title}</h1>
  <p class="small">{dashboardCopy.description}</p>

  <section class="card panel gv-stack" data-dashboard-logged-out hidden>
    <h2>{dashboardCopy.loginRequiredTitle}</h2>
    <p class="small">{dashboardCopy.loginRequiredBody}</p>
    <a class="ui-button ui-button-primary ui-button-md" href={loginPath}>{dashboardCopy.loginCta}</a>
  </section>

  <section class="dashboard-shell gv-stack" data-dashboard-authenticated hidden>
    <div class="dashboard-head">
      <p class="small" data-dashboard-feedback aria-live="polite">{dashboardCopy.loading}</p>
      <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-refresh>
        <span class="ui-button-label">{dashboardCopy.refresh}</span>
      </button>
    </div>

    <nav class="dashboard-section-nav" aria-label={dashboardCopy.quickTitle}>
      <a class="dashboard-section-pill" href="#dashboard-member" data-dashboard-section-pill data-dashboard-role-gated data-min-role="member">
        {dashboardCopy.overviewTitle}
      </a>
      <a class="dashboard-section-pill" href="#dashboard-editorial" data-dashboard-section-pill data-dashboard-role-gated data-min-role="editor" hidden>
        {dashboardCopy.localeTitle}
      </a>
      <a class="dashboard-section-pill" href="#dashboard-control" data-dashboard-section-pill data-dashboard-role-gated data-min-role="admin" hidden>
        {dashboardCopy.controlTitle}
      </a>
    </nav>

    <div class="dashboard-lanes">
      <section class="dashboard-lane gv-stack" id="dashboard-member" data-dashboard-lane data-min-role="member">
        <header class="dashboard-lane-head">
          <div class="dashboard-lane-title-wrap">
            <h2 class="dashboard-lane-title">{dashboardCopy.overviewTitle}</h2>
            <p class="small">{dashboardCopy.quickBody}</p>
          </div>
          <button
            type="button"
            class="dashboard-lane-toggle"
            data-dashboard-lane-toggle
            aria-expanded="true"
            aria-label={`Toggle ${dashboardCopy.overviewTitle}`}
            title={`Toggle ${dashboardCopy.overviewTitle}`}
          >
            -
          </button>
          <p class="dashboard-role-pill">
            <span>{dashboardCopy.accessRole}</span>
            <strong data-dashboard-role>{dashboardCopy.accessMember}</strong>
          </p>
        </header>

        <div class="dashboard-grid" data-dashboard-lane-content>
          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.overviewTitle}</h3>
            <dl class="dashboard-dl">
              <div>
                <dt>{dashboardCopy.overviewIdentity}</dt>
                <dd data-dashboard-identity>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewEmail}</dt>
                <dd data-dashboard-email>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewStatus}</dt>
                <dd data-dashboard-status>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewMemberSince}</dt>
                <dd data-dashboard-created>{dashboardCopy.unknown}</dd>
              </div>
              <div>
                <dt>{dashboardCopy.overviewLoginAt}</dt>
                <dd data-dashboard-loginat>{dashboardCopy.unknown}</dd>
              </div>
            </dl>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.preferenceTitle}</h3>
            <p class="small">{dashboardCopy.preferenceBody}</p>
            <p class="dashboard-kpi">
              <span>{dashboardCopy.preferenceValue}</span>
              <strong data-dashboard-preferred>{dashboardCopy.unknown}</strong>
            </p>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.commentsTitle}</h3>
            <p class="small">{dashboardCopy.commentsBody}</p>
            <div class="dashboard-kpi-grid">
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsTotal}</span><strong data-dashboard-comments-total>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsPending}</span><strong data-dashboard-comments-pending>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsApproved}</span><strong data-dashboard-comments-approved>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.commentsRejected}</span><strong data-dashboard-comments-rejected>0</strong></p>
            </div>
            <ul class="dashboard-mini-list" data-dashboard-comments-recent hidden></ul>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.accessTitle}</h3>
            <p class="small">{dashboardCopy.accessBody}</p>
            <ul class="dashboard-capabilities">
              <li>
                <span>{dashboardCopy.capabilityModeration}</span>
                <strong data-dashboard-cap-moderation>{dashboardCopy.capabilityDisabled}</strong>
              </li>
              <li>
                <span>{dashboardCopy.capabilityLocale}</span>
                <strong data-dashboard-cap-locale>{dashboardCopy.capabilityDisabled}</strong>
              </li>
              <li>
                <span>{dashboardCopy.capabilityAdminTools}</span>
                <strong data-dashboard-cap-admin>{dashboardCopy.capabilityDisabled}</strong>
              </li>
            </ul>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.quickTitle}</h3>
            <p class="small">{dashboardCopy.quickBody}</p>
            <div class="dashboard-actions">
              <a class="ui-button ui-button-secondary ui-button-sm" href={accountPath} data-dashboard-quick-id="account" data-dashboard-role-gated data-min-role="member">
                <span class="ui-button-label">{dashboardCopy.quickAccount}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={`${accountPath}#comments`} data-dashboard-quick-id="comments" data-dashboard-role-gated data-min-role="member">
                <span class="ui-button-label">{dashboardCopy.quickComments}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={`${accountPath}#locale-progress`}
                data-dashboard-quick-id="locale-progress"
                data-dashboard-role-gated
                data-min-role="editor"
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.quickLocale}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={pathForLanguage(lang, 'atlas')} data-dashboard-quick-id="atlas" data-dashboard-role-gated data-min-role="member">
                <span class="ui-button-label">{dashboardCopy.quickAtlas}</span>
              </a>
              <a class="ui-button ui-button-secondary ui-button-sm" href={pathForLanguage(lang, 'blog')} data-dashboard-quick-id="blog" data-dashboard-role-gated data-min-role="member">
                <span class="ui-button-label">{dashboardCopy.quickBlog}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href="#dashboard-editorial"
                data-dashboard-quick-id="moderation"
                data-dashboard-section-pill
                data-dashboard-role-gated
                data-min-role="editor"
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.quickModeration}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href="#dashboard-control"
                data-dashboard-quick-id="control"
                data-dashboard-section-pill
                data-dashboard-role-gated
                data-min-role="admin"
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.quickControl}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href="#dashboard-control"
                data-dashboard-quick-id="owner-ops"
                data-dashboard-section-pill
                data-dashboard-role-gated
                data-min-role="owner"
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.quickOwnerOps}</span>
              </a>
            </div>
          </article>
        </div>
      </section>

      <section
        class="dashboard-lane gv-stack"
        id="dashboard-editorial"
        data-dashboard-lane
        data-min-role="editor"
        hidden
      >
        <header class="dashboard-lane-head">
          <div class="dashboard-lane-title-wrap">
            <h2 class="dashboard-lane-title">{dashboardCopy.localeTitle}</h2>
            <p class="small">{dashboardCopy.localeBody}</p>
          </div>
          <button
            type="button"
            class="dashboard-lane-toggle"
            data-dashboard-lane-toggle
            aria-expanded="true"
            aria-label={`Toggle ${dashboardCopy.localeTitle}`}
            title={`Toggle ${dashboardCopy.localeTitle}`}
          >
            -
          </button>
        </header>

        <div class="dashboard-grid" data-dashboard-lane-content>
          <article class="card panel gv-stack">
            <div class="gv-stack dashboard-moderation-wrap" data-dashboard-moderation-wrap hidden>
              <h3 class="dashboard-mini-title">{dashboardCopy.moderationQueueTitle}</h3>
              <p class="small">{dashboardCopy.moderationQueueBody}</p>
              <div class="dashboard-kpi-grid">
                <p class="dashboard-kpi">
                  <span>{dashboardCopy.moderationQueuePendingCount}</span>
                  <strong data-dashboard-moderation-pending>0</strong>
                </p>
                <p class="dashboard-kpi">
                  <span>{dashboardCopy.moderationQueueStaleCount}</span>
                  <strong data-dashboard-moderation-stale>0</strong>
                </p>
                <p class="dashboard-kpi">
                  <span>{dashboardCopy.moderationQueueOldest}</span>
                  <strong data-dashboard-moderation-oldest>0h</strong>
                </p>
              </div>
              <p class="small dashboard-alert" data-dashboard-moderation-alert hidden></p>
              <ul class="dashboard-mini-list" data-dashboard-moderation-list></ul>
              <h3 class="dashboard-mini-title">{dashboardCopy.moderationHistoryTitle}</h3>
              <p class="small">{dashboardCopy.moderationHistoryBody}</p>
              <ul class="dashboard-mini-list" data-dashboard-moderation-history></ul>
            </div>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.localeTitle}</h3>
            <p class="small">{dashboardCopy.localeBody}</p>
            <div class="dashboard-kpi-grid">
              <p class="dashboard-kpi"><span>{dashboardCopy.localeCoverage.replace('{lang}', lang.toUpperCase())}</span><strong data-dashboard-locale-coverage>0%</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.localeGapLocales}</span><strong data-dashboard-locale-gaps>0</strong></p>
              <p class="dashboard-kpi"><span>{dashboardCopy.localeDeployRequired}</span><strong data-dashboard-locale-deploy>0</strong></p>
            </div>
            <p class="small" data-dashboard-locale-note hidden>{dashboardCopy.localeLimited}</p>
          </article>
        </div>
      </section>

      <section
        class="dashboard-lane gv-stack"
        id="dashboard-control"
        data-dashboard-lane
        data-min-role="admin"
        hidden
      >
        <header class="dashboard-lane-head">
          <div class="dashboard-lane-title-wrap">
            <h2 class="dashboard-lane-title">{dashboardCopy.controlTitle}</h2>
            <p class="small">{dashboardCopy.controlBody}</p>
          </div>
          <button
            type="button"
            class="dashboard-lane-toggle"
            data-dashboard-lane-toggle
            aria-expanded="true"
            aria-label={`Toggle ${dashboardCopy.controlTitle}`}
            title={`Toggle ${dashboardCopy.controlTitle}`}
          >
            -
          </button>
          <p class="dashboard-role-pill">
            <span>{dashboardCopy.roleGovernanceCurrent}</span>
            <strong data-dashboard-governance-role>{dashboardCopy.accessMember}</strong>
          </p>
        </header>

        <div class="dashboard-grid" data-dashboard-lane-content>
          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.roleGovernanceTitle}</h3>
            <p class="small">{dashboardCopy.roleGovernanceBody}</p>
            <p class="small"><strong>{dashboardCopy.roleGovernanceScope}:</strong> <span data-dashboard-governance-scope>{dashboardCopy.roleGovernanceMemberScope}</span></p>
            <p class="small"><strong>{dashboardCopy.roleGovernancePolicy}:</strong> <span data-dashboard-governance-policy>{dashboardCopy.roleGovernanceMemberPolicy}</span></p>
            <div class="dashboard-actions">
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={`${strapiAdminUrl}/settings/users-permissions/roles`}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.roleGovernanceManageRoles}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={`${strapiAdminUrl}/settings/users-permissions/users`}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.roleGovernanceManageUsers}</span>
              </a>
            </div>
            <p class="small" data-dashboard-governance-limited>{dashboardCopy.roleGovernanceLimited}</p>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.controlTitle}</h3>
            <p class="small">{dashboardCopy.controlBody}</p>
            <div class="dashboard-actions">
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={strapiAdminUrl}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.controlAdmin}</span>
              </a>
              <a
                class="ui-button ui-button-secondary ui-button-sm"
                href={launchRunbookUrl}
                target="_blank"
                rel="noopener noreferrer"
                data-dashboard-admin-link
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.controlRunbook}</span>
              </a>
              <button
                type="button"
                class="ui-button ui-button-secondary ui-button-sm"
                data-dashboard-copy-command
                data-command-value={releaseCommand}
                hidden
              >
                <span class="ui-button-label">{dashboardCopy.controlRelease}</span>
              </button>
            </div>
            <p class="small" data-dashboard-control-note>{dashboardCopy.controlLimited}</p>
          </article>

          <article class="card panel gv-stack">
            <h3 class="dashboard-mini-title">{dashboardCopy.activityTitle}</h3>
            <p class="small">{dashboardCopy.activityBody}</p>
            <div class="dashboard-activity-controls">
              <label class="dashboard-activity-toggle">
                <input type="checkbox" data-dashboard-activity-warn-only />
                <span>{dashboardCopy.activityFilterWarnOnly}</span>
              </label>
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-activity-clear>
                <span class="ui-button-label">{dashboardCopy.activityClearHistory}</span>
              </button>
            </div>
            <ul class="dashboard-activity-feed" data-dashboard-activity-feed hidden></ul>
            <p class="small" data-dashboard-activity-empty>{dashboardCopy.activityEmpty}</p>
          </article>

          <article class="card panel gv-stack" data-dashboard-role-gated data-min-role="owner" hidden>
            <h3 class="dashboard-mini-title">{dashboardCopy.ownerSummaryTitle}</h3>
            <p class="small">{dashboardCopy.ownerSummaryBody}</p>
            <ul class="dashboard-owner-summary-list">
              <li>
                <span>{dashboardCopy.ownerSummaryBuildSha}</span>
                <strong data-dashboard-owner-build-sha>{dashboardCopy.unknown}</strong>
              </li>
              <li>
                <span>{dashboardCopy.ownerSummaryReleaseStatus}</span>
                <strong data-dashboard-owner-release-status>{dashboardCopy.ownerSummaryStatusUnknown}</strong>
              </li>
              <li>
                <span>{dashboardCopy.ownerSummaryPending}</span>
                <strong data-dashboard-owner-pending>0</strong>
              </li>
              <li>
                <span>{dashboardCopy.ownerSummaryLocaleGaps}</span>
                <strong data-dashboard-owner-locale-gaps>0</strong>
              </li>
              <li>
                <span>{dashboardCopy.ownerSummaryLocaleDeploy}</span>
                <strong data-dashboard-owner-locale-deploy>0</strong>
              </li>
              <li>
                <span>{dashboardCopy.ownerSummaryRefreshedAt}</span>
                <strong data-dashboard-owner-refreshed>{dashboardCopy.unknown}</strong>
              </li>
            </ul>
            <div class="dashboard-owner-widgets">
              <article class="dashboard-owner-widget" data-dashboard-owner-widget="release" data-state="unknown">
                <header>
                  <span>{dashboardCopy.ownerSummaryReleaseStatus}</span>
                  <strong data-dashboard-owner-widget-release-state>{dashboardCopy.ownerSummaryStatusUnknown}</strong>
                </header>
                <p class="small" data-dashboard-owner-widget-release-detail>{dashboardCopy.activityBuildUnknown}</p>
                <div class="dashboard-owner-widget-actions">
                  <a
                    class="ui-button ui-button-secondary ui-button-sm"
                    href={launchRunbookUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    data-dashboard-owner-widget-action="release"
                  >
                    <span class="ui-button-label">{dashboardCopy.activityActionRunbook}</span>
                    <span class="dashboard-owner-widget-badge" data-dashboard-owner-widget-badge="release" hidden>0</span>
                  </a>
                </div>
              </article>
              <article class="dashboard-owner-widget" data-dashboard-owner-widget="moderation" data-state="unknown">
                <header>
                  <span>{dashboardCopy.ownerSummaryPending}</span>
                  <strong data-dashboard-owner-widget-moderation-state>{dashboardCopy.ownerSummaryStatusUnknown}</strong>
                </header>
                <p class="small" data-dashboard-owner-widget-moderation-detail>{dashboardCopy.moderationQueueEmpty}</p>
                <div class="dashboard-owner-widget-actions">
                  <a
                    class="ui-button ui-button-secondary ui-button-sm"
                    href="#dashboard-editorial"
                    data-dashboard-section-pill
                    data-dashboard-owner-widget-action="moderation"
                  >
                    <span class="ui-button-label">{dashboardCopy.activityActionModeration}</span>
                    <span class="dashboard-owner-widget-badge" data-dashboard-owner-widget-badge="moderation" hidden>0</span>
                  </a>
                </div>
              </article>
              <article class="dashboard-owner-widget" data-dashboard-owner-widget="locale" data-state="unknown">
                <header>
                  <span>{dashboardCopy.ownerSummaryLocaleGaps}</span>
                  <strong data-dashboard-owner-widget-locale-state>{dashboardCopy.ownerSummaryStatusUnknown}</strong>
                </header>
                <p class="small" data-dashboard-owner-widget-locale-detail>{dashboardCopy.activityAllClear}</p>
                <div class="dashboard-owner-widget-actions">
                  <a
                    class="ui-button ui-button-secondary ui-button-sm"
                    href="#dashboard-editorial"
                    data-dashboard-section-pill
                    data-dashboard-owner-widget-action="locale"
                  >
                    <span class="ui-button-label">{dashboardCopy.activityActionTranslations}</span>
                    <span class="dashboard-owner-widget-badge" data-dashboard-owner-widget-badge="locale" hidden>0</span>
                  </a>
                </div>
              </article>
            </div>
          </article>

          <article class="card panel gv-stack" data-dashboard-role-gated data-min-role="owner" hidden>
            <h3 class="dashboard-mini-title">{dashboardCopy.ownerOpsTitle}</h3>
            <p class="small">{dashboardCopy.ownerOpsBody}</p>
            <div class="dashboard-command-grid">
              <div class="dashboard-command-card">
                <strong>{dashboardCopy.ownerOpsRelease}</strong>
                <code>{releaseCommand}</code>
                <button
                  type="button"
                  class="ui-button ui-button-secondary ui-button-sm"
                  data-dashboard-copy-command
                  data-command-value={releaseCommand}
                >
                  <span class="ui-button-label">{dashboardCopy.ownerOpsCopy}</span>
                </button>
              </div>
              <div class="dashboard-command-card">
                <strong>{dashboardCopy.ownerOpsHealth}</strong>
                <code>{stackHealthCommand}</code>
                <button
                  type="button"
                  class="ui-button ui-button-secondary ui-button-sm"
                  data-dashboard-copy-command
                  data-command-value={stackHealthCommand}
                >
                  <span class="ui-button-label">{dashboardCopy.ownerOpsCopy}</span>
                </button>
              </div>
              <div class="dashboard-command-card">
                <strong>{dashboardCopy.ownerOpsAccess}</strong>
                <code>{smokeAccessCommand}</code>
                <button
                  type="button"
                  class="ui-button ui-button-secondary ui-button-sm"
                  data-dashboard-copy-command
                  data-command-value={smokeAccessCommand}
                >
                  <span class="ui-button-label">{dashboardCopy.ownerOpsCopy}</span>
                </button>
              </div>
            </div>
          </article>
        </div>
      </section>
    </div>

    <footer class="dashboard-footer card panel gv-stack">
      <h3 class="dashboard-mini-title">{dashboardCopy.quickTitle}</h3>
      <div class="dashboard-footer-links">
        <a class="dashboard-section-pill" href={homePath} data-dashboard-role-gated data-min-role="member">
          {dashboardCopy.navHome}
        </a>
        <a class="dashboard-section-pill" href={pathForLanguage(lang, 'atlas')} data-dashboard-role-gated data-min-role="member">
          {dashboardCopy.navAtlas}
        </a>
        <a class="dashboard-section-pill" href={pathForLanguage(lang, 'blog')} data-dashboard-role-gated data-min-role="member">
          {dashboardCopy.navBlog}
        </a>
        <a class="dashboard-section-pill" href={accountPath} data-dashboard-role-gated data-min-role="member">
          {dashboardCopy.quickAccount}
        </a>
        <a
          class="dashboard-section-pill"
          href="#dashboard-editorial"
          data-dashboard-section-pill
          data-dashboard-role-gated
          data-min-role="editor"
          hidden
        >
          {dashboardCopy.localeTitle}
        </a>
        <a
          class="dashboard-section-pill"
          href="#dashboard-control"
          data-dashboard-section-pill
          data-dashboard-role-gated
          data-min-role="admin"
          hidden
        >
          {dashboardCopy.controlTitle}
        </a>
      </div>
    </footer>
  </section>

  <script is:inline define:vars={{ authBaseUrl, dashboardCopy, ownerEmailHint, launchRunbookUrl }}>
    (() => {
      const loggedOutPanel = document.querySelector('[data-dashboard-logged-out]');
      const authedPanel = document.querySelector('[data-dashboard-authenticated]');
      const refreshButton = document.querySelector('[data-dashboard-refresh]');
      const feedback = document.querySelector('[data-dashboard-feedback]');
      const localeNote = document.querySelector('[data-dashboard-locale-note]');
      const controlNote = document.querySelector('[data-dashboard-control-note]');
      const adminLinks = Array.from(document.querySelectorAll('[data-dashboard-admin-link]'));
      const copyCommandButtons = Array.from(document.querySelectorAll('[data-dashboard-copy-command]'));
      const roleGatedNodes = Array.from(document.querySelectorAll('[data-dashboard-role-gated]'));
      const moderationWrapNode = document.querySelector('[data-dashboard-moderation-wrap]');
      const moderationListNode = document.querySelector('[data-dashboard-moderation-list]');
      const moderationHistoryNode = document.querySelector('[data-dashboard-moderation-history]');
      const moderationPendingNode = document.querySelector('[data-dashboard-moderation-pending]');
      const moderationStaleNode = document.querySelector('[data-dashboard-moderation-stale]');
      const moderationOldestNode = document.querySelector('[data-dashboard-moderation-oldest]');
      const moderationAlertNode = document.querySelector('[data-dashboard-moderation-alert]');

      const identityNode = document.querySelector('[data-dashboard-identity]');
      const emailNode = document.querySelector('[data-dashboard-email]');
      const statusNode = document.querySelector('[data-dashboard-status]');
      const createdNode = document.querySelector('[data-dashboard-created]');
      const loginAtNode = document.querySelector('[data-dashboard-loginat]');
      const preferredNode = document.querySelector('[data-dashboard-preferred]');
      const roleNode = document.querySelector('[data-dashboard-role]');
      const governanceRoleNode = document.querySelector('[data-dashboard-governance-role]');
      const governanceScopeNode = document.querySelector('[data-dashboard-governance-scope]');
      const governancePolicyNode = document.querySelector('[data-dashboard-governance-policy]');
      const governanceLimitedNoteNode = document.querySelector('[data-dashboard-governance-limited]');
      const capModerationNode = document.querySelector('[data-dashboard-cap-moderation]');
      const capLocaleNode = document.querySelector('[data-dashboard-cap-locale]');
      const capAdminNode = document.querySelector('[data-dashboard-cap-admin]');
      const commentsTotalNode = document.querySelector('[data-dashboard-comments-total]');
      const commentsPendingNode = document.querySelector('[data-dashboard-comments-pending]');
      const commentsApprovedNode = document.querySelector('[data-dashboard-comments-approved]');
      const commentsRejectedNode = document.querySelector('[data-dashboard-comments-rejected]');
      const commentsRecentNode = document.querySelector('[data-dashboard-comments-recent]');
      const localeCoverageNode = document.querySelector('[data-dashboard-locale-coverage]');
      const localeGapsNode = document.querySelector('[data-dashboard-locale-gaps]');
      const localeDeployNode = document.querySelector('[data-dashboard-locale-deploy]');
      const ownerBuildShaNode = document.querySelector('[data-dashboard-owner-build-sha]');
      const ownerReleaseStatusNode = document.querySelector('[data-dashboard-owner-release-status]');
      const ownerPendingNode = document.querySelector('[data-dashboard-owner-pending]');
      const ownerLocaleGapsNode = document.querySelector('[data-dashboard-owner-locale-gaps]');
      const ownerLocaleDeployNode = document.querySelector('[data-dashboard-owner-locale-deploy]');
      const ownerRefreshedNode = document.querySelector('[data-dashboard-owner-refreshed]');
      const ownerWidgetReleaseNode = document.querySelector('[data-dashboard-owner-widget="release"]');
      const ownerWidgetReleaseStateNode = document.querySelector('[data-dashboard-owner-widget-release-state]');
      const ownerWidgetReleaseDetailNode = document.querySelector('[data-dashboard-owner-widget-release-detail]');
      const ownerWidgetModerationNode = document.querySelector('[data-dashboard-owner-widget="moderation"]');
      const ownerWidgetModerationStateNode = document.querySelector('[data-dashboard-owner-widget-moderation-state]');
      const ownerWidgetModerationDetailNode = document.querySelector('[data-dashboard-owner-widget-moderation-detail]');
      const ownerWidgetLocaleNode = document.querySelector('[data-dashboard-owner-widget="locale"]');
      const ownerWidgetLocaleStateNode = document.querySelector('[data-dashboard-owner-widget-locale-state]');
      const ownerWidgetLocaleDetailNode = document.querySelector('[data-dashboard-owner-widget-locale-detail]');
      const ownerWidgetReleaseBadgeNode = document.querySelector('[data-dashboard-owner-widget-badge="release"]');
      const ownerWidgetModerationBadgeNode = document.querySelector('[data-dashboard-owner-widget-badge="moderation"]');
      const ownerWidgetLocaleBadgeNode = document.querySelector('[data-dashboard-owner-widget-badge="locale"]');
      const activityFeedNode = document.querySelector('[data-dashboard-activity-feed]');
      const activityEmptyNode = document.querySelector('[data-dashboard-activity-empty]');
      const activityWarnOnlyNode = document.querySelector('[data-dashboard-activity-warn-only]');
      const activityClearNode = document.querySelector('[data-dashboard-activity-clear]');
      const sectionPillLinks = Array.from(document.querySelectorAll('[data-dashboard-section-pill]'));
      const laneNodes = Array.from(document.querySelectorAll('[data-dashboard-lane]'));
      const laneToggleButtons = Array.from(document.querySelectorAll('[data-dashboard-lane-toggle]'));
      let currentSession = null;
      let canRunModeration = false;
      let isLoading = false;
      const STALE_PENDING_HOURS = 24;
      let ownerPendingCount = 0;
      let ownerStalePendingCount = 0;
      let ownerLocaleGapCount = 0;
      let ownerLocaleDeployCount = 0;
      let ownerFingerprintSha = '';
      let lastActivityHasErrors = false;
      let activityHistory = [];
      let activityTickTimer = null;
      let sectionSyncFrame = null;
      const editorialSectionHref = '#dashboard-editorial';
      const ACTIVITY_HISTORY_STORAGE_KEY = 'geovito_dashboard_activity_history_v1';
      const ACTIVITY_HISTORY_LIMIT = 20;
      const LANE_STATE_STORAGE_KEY = 'geovito_dashboard_lane_state_v1';
      const roleRanks = {
        member: 0,
        editor: 1,
        admin: 2,
        owner: 3,
      };
      let laneCollapsedState = {};

      const toNode = (value) => (value instanceof HTMLElement ? value : null);
      const setText = (node, value) => {
        const el = toNode(node);
        if (!el) return;
        el.textContent = String(value ?? '');
      };

      const setFeedback = (message, isError = false) => {
        const el = toNode(feedback);
        if (!el) return;
        el.textContent = String(message || '');
        el.classList.toggle('is-error', Boolean(isError));
      };

      const setOwnerWidgetState = (node, state, statusNode, detailNode, statusText, detailText) => {
        const host = toNode(node);
        if (host) {
          host.dataset.state = String(state || 'unknown');
        }
        setText(statusNode, statusText);
        setText(detailNode, detailText);
      };

      const setOwnerWidgetBadge = (badgeNode, value) => {
        const badge = toNode(badgeNode);
        if (!badge) return;
        const count = Number(value || 0);
        if (!Number.isFinite(count) || count <= 0) {
          badge.hidden = true;
          badge.textContent = '0';
          return;
        }
        badge.hidden = false;
        badge.textContent = String(Math.round(count));
      };

      const normalizeActivityEvent = (event) => {
        if (!event || typeof event !== 'object') return null;
        const message = String(event.message || '').trim();
        if (!message) return null;
        const levelRaw = String(event.level || 'info').trim().toLowerCase();
        const level =
          levelRaw === 'warn' || levelRaw === 'ok' || levelRaw === 'info'
            ? levelRaw
            : 'info';
        const actionLabel = String(event.actionLabel || '').trim();
        const actionHref = String(event.actionHref || '').trim();
        const tsNum = Number(event.ts);
        const ts = Number.isFinite(tsNum) ? tsNum : Date.now();
        return {
          level,
          message,
          actionLabel: actionLabel || undefined,
          actionHref: actionHref || undefined,
          ts,
        };
      };

      const dedupeActivityEvents = (events) => {
        if (!Array.isArray(events)) return [];
        const map = new Map();
        events.forEach((raw) => {
          const event = normalizeActivityEvent(raw);
          if (!event) return;
          const key = `${event.level}|${event.message}|${event.actionHref || ''}`;
          const prev = map.get(key);
          if (!prev || event.ts > prev.ts) {
            map.set(key, event);
          }
        });
        return Array.from(map.values())
          .sort((a, b) => b.ts - a.ts)
          .slice(0, ACTIVITY_HISTORY_LIMIT);
      };

      const readActivityHistory = () => {
        try {
          const raw = localStorage.getItem(ACTIVITY_HISTORY_STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return dedupeActivityEvents(parsed);
        } catch {
          return [];
        }
      };

      const persistActivityHistory = () => {
        try {
          localStorage.setItem(
            ACTIVITY_HISTORY_STORAGE_KEY,
            JSON.stringify(activityHistory.slice(0, ACTIVITY_HISTORY_LIMIT))
          );
        } catch {
          // ignore storage write failures (private mode / quota)
        }
      };

      const readLaneCollapsedState = () => {
        try {
          const raw = localStorage.getItem(LANE_STATE_STORAGE_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) return {};
          return parsed;
        } catch {
          return {};
        }
      };

      const persistLaneCollapsedState = () => {
        try {
          localStorage.setItem(LANE_STATE_STORAGE_KEY, JSON.stringify(laneCollapsedState));
        } catch {
          // ignore storage write failures (private mode / quota)
        }
      };

      const updateLaneCollapsedState = (laneNode, isCollapsed, { persist = true } = {}) => {
        if (!(laneNode instanceof HTMLElement)) return;
        const laneId = String(laneNode.id || '').trim();
        if (!laneId) return;

        laneNode.dataset.collapsed = isCollapsed ? 'true' : 'false';

        const contentNode = laneNode.querySelector('[data-dashboard-lane-content]');
        if (contentNode instanceof HTMLElement) {
          contentNode.hidden = isCollapsed;
        }

        const toggleNode = laneNode.querySelector('[data-dashboard-lane-toggle]');
        if (toggleNode instanceof HTMLButtonElement) {
          toggleNode.textContent = isCollapsed ? '+' : '-';
          toggleNode.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        }

        laneCollapsedState[laneId] = Boolean(isCollapsed);
        if (persist) {
          persistLaneCollapsedState();
        }
      };

      const getLaneFromHash = (hash) => {
        const value = String(hash || '').trim();
        if (!value || !value.startsWith('#')) return null;
        const target = document.querySelector(value);
        if (!(target instanceof HTMLElement)) return null;
        if (!target.hasAttribute('data-dashboard-lane')) return null;
        return target;
      };

      const isLaneVisible = (laneNode) => laneNode instanceof HTMLElement && laneNode.hidden !== true;

      const getVisibleSectionLinks = () => {
        return sectionPillLinks.filter((link) => {
          if (!(link instanceof HTMLAnchorElement)) return false;
          const laneNode = getLaneFromHash(link.getAttribute('href') || '');
          return laneNode ? isLaneVisible(laneNode) : false;
        });
      };

      const setActiveSectionPill = (hash) => {
        const visibleLinks = getVisibleSectionLinks();
        sectionPillLinks.forEach((link) => {
          if (link instanceof HTMLElement) {
            link.classList.remove('is-active');
          }
        });

        if (visibleLinks.length === 0) return;

        const normalizedHash = String(hash || '').trim();
        const matchingLinks = visibleLinks.filter((link) => String(link.getAttribute('href') || '') === normalizedHash);
        if (matchingLinks.length > 0) {
          matchingLinks.forEach((link) => link.classList.add('is-active'));
          return;
        }

        const fallbackHref = String(visibleLinks[0].getAttribute('href') || '').trim();
        visibleLinks
          .filter((link) => String(link.getAttribute('href') || '') === fallbackHref)
          .forEach((link) => link.classList.add('is-active'));
      };

      const syncActiveSectionFromScroll = () => {
        const visibleLanes = laneNodes.filter((lane) => lane instanceof HTMLElement && isLaneVisible(lane));
        if (visibleLanes.length === 0) return;

        let activeLane = visibleLanes[0];
        visibleLanes.forEach((lane) => {
          const top = lane.getBoundingClientRect().top;
          if (top <= 180) {
            activeLane = lane;
          }
        });

        if (activeLane instanceof HTMLElement && activeLane.id) {
          setActiveSectionPill(`#${activeLane.id}`);
        }
      };

      const requestSectionSync = () => {
        if (sectionSyncFrame !== null) return;
        sectionSyncFrame = window.requestAnimationFrame(() => {
          sectionSyncFrame = null;
          syncActiveSectionFromScroll();
        });
      };

      const mergeActivityHistory = (events) => {
        if (!Array.isArray(events) || events.length === 0) return;
        activityHistory = dedupeActivityEvents([...events, ...activityHistory]);
        persistActivityHistory();
      };

      const relativeFormatter = (() => {
        try {
          return new Intl.RelativeTimeFormat(document.documentElement.lang || 'en', { numeric: 'auto' });
        } catch {
          return null;
        }
      })();

      const formatRelativeTime = (timestampMs) => {
        if (!Number.isFinite(timestampMs)) return dashboardCopy.unknown;
        const diffSeconds = Math.round((timestampMs - Date.now()) / 1000);
        const absSeconds = Math.abs(diffSeconds);

        if (absSeconds < 10) return dashboardCopy.activityNow;

        const units = [
          ['day', 86400],
          ['hour', 3600],
          ['minute', 60],
        ];
        for (const [unit, size] of units) {
          if (absSeconds >= size) {
            const value = Math.round(diffSeconds / size);
            if (relativeFormatter) {
              return relativeFormatter.format(value, unit);
            }
            return value < 0 ? `${Math.abs(value)}${String(unit).charAt(0)} ago` : `in ${value}${String(unit).charAt(0)}`;
          }
        }

        if (relativeFormatter) {
          return relativeFormatter.format(diffSeconds, 'second');
        }
        return dashboardCopy.activityNow;
      };

      const syncOwnerReleaseStatus = () => {
        const hasSignals =
          ownerPendingCount > 0 ||
          ownerStalePendingCount > 0 ||
          ownerLocaleGapCount > 0 ||
          ownerLocaleDeployCount > 0;
        const status = hasSignals
          ? dashboardCopy.ownerSummaryStatusAttention
          : dashboardCopy.ownerSummaryStatusLive;
        setText(ownerReleaseStatusNode, status);
      };

      const syncOwnerWidgets = () => {
        const hasReleaseSha = Boolean(ownerFingerprintSha);
        const moderationHasPending = ownerPendingCount > 0;
        const moderationHasStale = ownerStalePendingCount > 0;
        const localeHasGaps = ownerLocaleGapCount > 0;
        const localeNeedsDeploy = ownerLocaleDeployCount > 0;
        const localeIssueCount = Math.max(0, Number(ownerLocaleGapCount) + Number(ownerLocaleDeployCount));
        const releaseIssueCount = Number(moderationHasPending) + Number(moderationHasStale) + Number(localeHasGaps) + Number(localeNeedsDeploy);

        const releaseState = !hasReleaseSha
          ? 'unknown'
          : moderationHasPending || moderationHasStale || localeHasGaps || localeNeedsDeploy
            ? 'warn'
            : 'ok';
        const releaseStatusText =
          releaseState === 'unknown'
            ? dashboardCopy.ownerSummaryStatusUnknown
            : releaseState === 'warn'
              ? dashboardCopy.ownerSummaryStatusAttention
              : dashboardCopy.ownerSummaryStatusLive;
        const releaseDetailText = hasReleaseSha
          ? dashboardCopy.activityBuildLive.replace('{sha}', ownerFingerprintSha)
          : dashboardCopy.activityBuildUnknown;
        setOwnerWidgetState(
          ownerWidgetReleaseNode,
          releaseState,
          ownerWidgetReleaseStateNode,
          ownerWidgetReleaseDetailNode,
          releaseStatusText,
          releaseDetailText
        );
        setOwnerWidgetBadge(ownerWidgetReleaseBadgeNode, releaseIssueCount);

        const moderationState = moderationHasStale
          ? 'warn'
          : moderationHasPending
            ? 'info'
            : 'ok';
        let moderationDetailText = dashboardCopy.moderationQueueEmpty;
        if (moderationHasStale) {
          moderationDetailText = dashboardCopy.activityPendingStale
            .replace('{count}', String(ownerStalePendingCount))
            .replace('{hours}', String(STALE_PENDING_HOURS));
        } else if (moderationHasPending) {
          moderationDetailText = dashboardCopy.activityPending.replace('{count}', String(ownerPendingCount));
        }
        setOwnerWidgetState(
          ownerWidgetModerationNode,
          moderationState,
          ownerWidgetModerationStateNode,
          ownerWidgetModerationDetailNode,
          moderationState === 'warn'
            ? dashboardCopy.activityLevelWarn
            : moderationState === 'info'
              ? dashboardCopy.activityLevelInfo
              : dashboardCopy.activityLevelOk,
          moderationDetailText
        );
        setOwnerWidgetBadge(ownerWidgetModerationBadgeNode, ownerPendingCount);

        const localeState = localeHasGaps
          ? 'warn'
          : localeNeedsDeploy
            ? 'info'
            : 'ok';
        let localeDetailText = dashboardCopy.activityAllClear;
        if (localeHasGaps && localeNeedsDeploy) {
          localeDetailText = `${dashboardCopy.activityLocaleGaps.replace('{count}', String(ownerLocaleGapCount))}  ${dashboardCopy.activityLocaleDeploy.replace('{count}', String(ownerLocaleDeployCount))}`;
        } else if (localeHasGaps) {
          localeDetailText = dashboardCopy.activityLocaleGaps.replace('{count}', String(ownerLocaleGapCount));
        } else if (localeNeedsDeploy) {
          localeDetailText = dashboardCopy.activityLocaleDeploy.replace('{count}', String(ownerLocaleDeployCount));
        }
        setOwnerWidgetState(
          ownerWidgetLocaleNode,
          localeState,
          ownerWidgetLocaleStateNode,
          ownerWidgetLocaleDetailNode,
          localeState === 'warn'
            ? dashboardCopy.activityLevelWarn
            : localeState === 'info'
              ? dashboardCopy.activityLevelInfo
              : dashboardCopy.activityLevelOk,
          localeDetailText
        );
        setOwnerWidgetBadge(ownerWidgetLocaleBadgeNode, localeIssueCount);
      };

      const refreshOwnerFingerprint = async () => {
        try {
          const response = await fetch('/.well-known/geovito-build.json', {
            headers: { Accept: 'application/json' },
          });
          if (!response.ok) {
            ownerFingerprintSha = '';
            setText(ownerBuildShaNode, dashboardCopy.unknown);
            return;
          }
          const payload = await response.json().catch(() => null);
          const sha = String(payload?.build_sha7 || '').trim();
          ownerFingerprintSha = sha;
          setText(ownerBuildShaNode, sha || dashboardCopy.unknown);
        } catch {
          ownerFingerprintSha = '';
          setText(ownerBuildShaNode, dashboardCopy.unknown);
        }
      };

      const renderActivityFeed = (hasErrors = false, options = {}) => {
        const host = toNode(activityFeedNode);
        const empty = toNode(activityEmptyNode);
        if (!host) return;

        host.innerHTML = '';
        const nowTs = Date.now();
        const includeLive = !(options && options.includeLive === false);
        const shouldPersist = !(options && options.persist === false);
        const warnOnlyEnabled =
          activityWarnOnlyNode instanceof HTMLInputElement && activityWarnOnlyNode.checked;
        const events = [];

        if (includeLive) {
          if (ownerFingerprintSha) {
            events.push({
              level: 'info',
              message: dashboardCopy.activityBuildLive.replace('{sha}', ownerFingerprintSha),
              actionLabel: dashboardCopy.activityActionRunbook,
              actionHref: launchRunbookUrl,
              ts: nowTs,
            });
          } else {
            events.push({
              level: 'warn',
              message: dashboardCopy.activityBuildUnknown,
              actionLabel: dashboardCopy.activityActionRunbook,
              actionHref: launchRunbookUrl,
              ts: nowTs,
            });
          }

          if (ownerPendingCount > 0) {
            events.push({
              level: 'warn',
              message: dashboardCopy.activityPending.replace('{count}', String(ownerPendingCount)),
              actionLabel: dashboardCopy.activityActionModeration,
              actionHref: editorialSectionHref,
              ts: nowTs,
            });
          }

          if (ownerStalePendingCount > 0) {
            events.push({
              level: 'warn',
              message: dashboardCopy.activityPendingStale
                .replace('{count}', String(ownerStalePendingCount))
                .replace('{hours}', String(STALE_PENDING_HOURS)),
              actionLabel: dashboardCopy.activityActionModeration,
              actionHref: editorialSectionHref,
              ts: nowTs,
            });
          }

          if (ownerLocaleGapCount > 0) {
            events.push({
              level: 'warn',
              message: dashboardCopy.activityLocaleGaps.replace('{count}', String(ownerLocaleGapCount)),
              actionLabel: dashboardCopy.activityActionTranslations,
              actionHref: editorialSectionHref,
              ts: nowTs,
            });
          }

          if (ownerLocaleDeployCount > 0) {
            events.push({
              level: 'info',
              message: dashboardCopy.activityLocaleDeploy.replace('{count}', String(ownerLocaleDeployCount)),
              actionLabel: dashboardCopy.activityActionTranslations,
              actionHref: editorialSectionHref,
              ts: nowTs,
            });
          }

          if (hasErrors) {
            events.push({
              level: 'warn',
              message: dashboardCopy.activityLoadFailed,
              actionLabel: dashboardCopy.activityActionRunbook,
              actionHref: launchRunbookUrl,
              ts: nowTs,
            });
          }

          if (events.length <= 1 && !hasErrors && ownerPendingCount === 0 && ownerLocaleGapCount === 0 && ownerLocaleDeployCount === 0) {
            events.push({
              level: 'ok',
              message: dashboardCopy.activityAllClear,
              ts: nowTs,
            });
          }
        }

        const persistableEvents = includeLive
          ? events.filter((event) => event.level !== 'ok' && event.message !== dashboardCopy.activityWarnOnlyEmpty)
          : [];
        if (shouldPersist && persistableEvents.length > 0) {
          mergeActivityHistory(persistableEvents);
        }

        const sourceEvents = activityHistory.length > 0 ? activityHistory : events;
        let visibleEvents = warnOnlyEnabled
          ? sourceEvents.filter((event) => event.level === 'warn')
          : sourceEvents;
        if (warnOnlyEnabled && visibleEvents.length === 0) {
          visibleEvents = [
            {
              level: 'ok',
              message: dashboardCopy.activityWarnOnlyEmpty,
              ts: nowTs,
            },
          ];
        }

        const fragment = document.createDocumentFragment();
        visibleEvents.slice(0, 10).forEach((event) => {
          const row = document.createElement('li');
          row.className = `dashboard-activity-item dashboard-activity-item--${event.level}`;

          const head = document.createElement('div');
          head.className = 'dashboard-activity-head';

          const badge = document.createElement('strong');
          badge.textContent =
            event.level === 'ok'
              ? dashboardCopy.activityLevelOk
              : event.level === 'warn'
                ? dashboardCopy.activityLevelWarn
                : dashboardCopy.activityLevelInfo;
          head.appendChild(badge);

          const time = document.createElement('time');
          time.className = 'dashboard-activity-time';
          time.dateTime = new Date(Number(event.ts) || nowTs).toISOString();
          time.textContent = formatRelativeTime(Number(event.ts) || nowTs);
          head.appendChild(time);

          const text = document.createElement('span');
          text.textContent = event.message;
          row.appendChild(head);
          row.appendChild(text);

          if (event.actionLabel && event.actionHref) {
            const action = document.createElement('a');
            action.className = 'dashboard-activity-link';
            action.textContent = event.actionLabel;
            action.setAttribute('href', String(event.actionHref));
            if (/^https?:\/\//.test(String(event.actionHref))) {
              action.setAttribute('target', '_blank');
              action.setAttribute('rel', 'noopener noreferrer');
            }
            row.appendChild(action);
          }

          fragment.appendChild(row);
        });

        host.appendChild(fragment);
        host.hidden = visibleEvents.length === 0;
        if (empty) {
          empty.hidden = visibleEvents.length > 0;
        }
      };

      const startActivityTicker = () => {
        if (activityTickTimer) {
          clearInterval(activityTickTimer);
        }
        activityTickTimer = window.setInterval(() => {
          renderActivityFeed(lastActivityHasErrors, { includeLive: false, persist: false });
        }, 60000);
      };

      const escapeHtml = (value) =>
        String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const readSession = () => {
        try {
          const fromLocal = localStorage.getItem('geovito_auth_session');
          const fromSession = sessionStorage.getItem('geovito_auth_session');
          const raw = fromLocal || fromSession;
          if (!raw) return null;

          if (!fromLocal && fromSession) {
            localStorage.setItem('geovito_auth_session', fromSession);
          }

          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return null;
          const jwt = typeof parsed.jwt === 'string' ? parsed.jwt.trim() : '';
          if (!jwt) return null;

          return {
            jwt,
            email: typeof parsed.email === 'string' ? parsed.email.trim() : '',
            username: typeof parsed.username === 'string' ? parsed.username.trim() : '',
            loginAt: typeof parsed.loginAt === 'string' ? parsed.loginAt.trim() : '',
          };
        } catch {
          return null;
        }
      };

      const formatDate = (value) => {
        if (!value) return dashboardCopy.unknown;
        const date = new Date(String(value));
        if (Number.isNaN(date.getTime())) return dashboardCopy.unknown;
        try {
          return new Intl.DateTimeFormat(document.documentElement.lang || 'en', {
            dateStyle: 'medium',
            timeStyle: 'short',
          }).format(date);
        } catch {
          return date.toISOString();
        }
      };

      const normalizeLanguage = (value) => String(value || '').trim().toLowerCase();

      const getGovernanceCopy = (role) => {
        const normalized = String(role || '').toLowerCase();
        if (normalized === 'owner') {
          return {
            scope: dashboardCopy.roleGovernanceOwnerScope,
            policy: dashboardCopy.roleGovernanceOwnerPolicy,
          };
        }
        if (normalized === 'admin') {
          return {
            scope: dashboardCopy.roleGovernanceAdminScope,
            policy: dashboardCopy.roleGovernanceAdminPolicy,
          };
        }
        if (normalized === 'editor') {
          return {
            scope: dashboardCopy.roleGovernanceEditorScope,
            policy: dashboardCopy.roleGovernanceEditorPolicy,
          };
        }
        return {
          scope: dashboardCopy.roleGovernanceMemberScope,
          policy: dashboardCopy.roleGovernanceMemberPolicy,
        };
      };

      const inferRole = (userPayload, session) => {
        const roleRaw = String(
          userPayload?.role?.type ||
          userPayload?.role?.name ||
          userPayload?.role?.code ||
          ''
        ).trim().toLowerCase();

        if (roleRaw.includes('super') || roleRaw === 'admin' || roleRaw.includes('administrator')) {
          return 'admin';
        }
        if (roleRaw.includes('editor')) {
          return 'editor';
        }

        const email = normalizeLanguage(userPayload?.email || session?.email || '');
        if (ownerEmailHint && email && email === normalizeLanguage(ownerEmailHint)) {
          return 'owner';
        }

        return 'member';
      };

      const applyAccessView = (role) => {
        const normalizedRole = String(role || 'member').toLowerCase();
        const isOwner = normalizedRole === 'owner';
        const isAdmin = isOwner || normalizedRole === 'admin';
        const isEditor = isAdmin || normalizedRole === 'editor';
        const effectiveRole = isOwner ? 'owner' : isAdmin ? 'admin' : isEditor ? 'editor' : 'member';
        const effectiveRoleRank = Number(roleRanks[effectiveRole] ?? 0);
        canRunModeration = isEditor;

        const roleLabel = isOwner
          ? dashboardCopy.accessOwner
          : isAdmin
            ? dashboardCopy.accessAdmin
            : isEditor
              ? dashboardCopy.accessEditor
              : dashboardCopy.accessMember;
        setText(roleNode, roleLabel);
        setText(governanceRoleNode, roleLabel);

        const governanceCopy = getGovernanceCopy(
          isOwner ? 'owner' : isAdmin ? 'admin' : isEditor ? 'editor' : 'member'
        );
        setText(governanceScopeNode, governanceCopy.scope);
        setText(governancePolicyNode, governanceCopy.policy);

        setText(capModerationNode, isEditor ? dashboardCopy.capabilityEnabled : dashboardCopy.capabilityDisabled);
        setText(capLocaleNode, isEditor ? dashboardCopy.capabilityEnabled : dashboardCopy.capabilityDisabled);
        setText(capAdminNode, isAdmin ? dashboardCopy.capabilityEnabled : dashboardCopy.capabilityDisabled);

        adminLinks.forEach((link) => {
          if (!(link instanceof HTMLElement)) return;
          link.hidden = !isAdmin;
        });

        copyCommandButtons.forEach((button) => {
          if (!(button instanceof HTMLElement)) return;
          button.hidden = !isAdmin;
        });

        if (toNode(controlNote)) {
          toNode(controlNote).hidden = isAdmin;
        }

        if (toNode(governanceLimitedNoteNode)) {
          toNode(governanceLimitedNoteNode).hidden = isAdmin;
        }

        if (toNode(moderationWrapNode)) {
          toNode(moderationWrapNode).hidden = !canRunModeration;
        }

        laneNodes.forEach((lane) => {
          if (!(lane instanceof HTMLElement)) return;
          const minRole = String(lane.getAttribute('data-min-role') || 'member').toLowerCase();
          const minRoleRank = Number(roleRanks[minRole] ?? 0);
          lane.hidden = effectiveRoleRank < minRoleRank;
          if (!lane.hidden) {
            const laneId = String(lane.id || '').trim();
            const isCollapsed = Boolean(laneCollapsedState[laneId]);
            updateLaneCollapsedState(lane, isCollapsed, { persist: false });
          }
        });

        const hashLane = getLaneFromHash(window.location.hash);
        if (hashLane && isLaneVisible(hashLane)) {
          setActiveSectionPill(window.location.hash);
        } else {
          setActiveSectionPill('');
          requestSectionSync();
        }

        roleGatedNodes.forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          const minRole = String(node.getAttribute('data-min-role') || 'member').toLowerCase();
          const minRoleRank = Number(roleRanks[minRole] ?? 0);
          node.hidden = effectiveRoleRank < minRoleRank;
        });

        return {
          isOwner,
          isAdmin,
          isEditor,
        };
      };

      const renderRecentComments = (items) => {
        const host = toNode(commentsRecentNode);
        if (!host) return;
        host.innerHTML = '';

        const list = Array.isArray(items) ? items.slice(0, 5) : [];
        host.hidden = list.length === 0;
        if (list.length === 0) return;

        const fragment = document.createDocumentFragment();
        list.forEach((item) => {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';
          const status = String(item?.status || '').trim().toUpperCase() || '-';
          const body = String(item?.body || '').trim() || '-';
          const compactBody = body.length > 110 ? `${body.slice(0, 107)}...` : body;
          row.innerHTML = `<strong>${status}</strong><span>${compactBody}</span>`;
          fragment.appendChild(row);
        });

        host.appendChild(fragment);
      };

      const renderModerationQueue = (items) => {
        const host = toNode(moderationListNode);
        if (!host) return;

        host.innerHTML = '';

        const sourceList = Array.isArray(items) ? items : [];
        let staleCount = 0;
        let oldestHours = 0;
        const nowMs = Date.now();

        sourceList.forEach((item) => {
          const createdRaw = String(
            item?.created_at ||
            item?.createdAt ||
            item?.submitted_at ||
            ''
          ).trim();
          if (!createdRaw) return;

          const createdMs = new Date(createdRaw).getTime();
          if (!Number.isFinite(createdMs) || createdMs <= 0) return;

          const ageHours = Math.max(0, Math.floor((nowMs - createdMs) / 3600000));
          if (ageHours > oldestHours) oldestHours = ageHours;
          if (ageHours >= STALE_PENDING_HOURS) staleCount += 1;
        });

        setText(moderationPendingNode, String(sourceList.length));
        setText(moderationStaleNode, String(staleCount));
        setText(moderationOldestNode, `${oldestHours}h`);
        ownerStalePendingCount = staleCount;

        const alertEl = toNode(moderationAlertNode);
        if (alertEl) {
          if (staleCount > 0) {
            alertEl.hidden = false;
            alertEl.textContent = dashboardCopy.moderationQueueStaleAlert
              .replace('{count}', String(staleCount))
              .replace('{hours}', String(STALE_PENDING_HOURS));
          } else {
            alertEl.hidden = true;
            alertEl.textContent = '';
          }
        }

        const list = sourceList.slice(0, 8);
        if (!canRunModeration || list.length === 0) {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';
          row.innerHTML = `<span>${escapeHtml(dashboardCopy.moderationQueueEmpty)}</span>`;
          host.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        list.forEach((item) => {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item dashboard-moderation-item';
          const status = String(item?.status || '').trim().toUpperCase() || '-';
          const body = String(item?.body || '').trim() || '-';
          const compactBody = body.length > 120 ? `${body.slice(0, 117)}...` : body;
          const commentId = String(item?.comment_id || '').trim();
          const author = String(item?.display_name || item?.source || '').trim() || '-';
          const postRef = String(item?.blog_post_ref || '').trim() || '-';
          row.innerHTML = `
            <strong>${escapeHtml(status)}  ${escapeHtml(author)}</strong>
            <span>${escapeHtml(compactBody)}</span>
            <span>${escapeHtml(dashboardCopy.moderationHistoryPost)}: ${escapeHtml(postRef)}</span>
            <div class="dashboard-action-row">
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-moderate="approved" data-comment-id="${escapeHtml(commentId)}">
                <span class="ui-button-label">${escapeHtml(dashboardCopy.moderationApprove)}</span>
              </button>
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-moderate="rejected" data-comment-id="${escapeHtml(commentId)}">
                <span class="ui-button-label">${escapeHtml(dashboardCopy.moderationReject)}</span>
              </button>
              <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-dashboard-moderate="spam" data-comment-id="${escapeHtml(commentId)}">
                <span class="ui-button-label">${escapeHtml(dashboardCopy.moderationSpam)}</span>
              </button>
            </div>
          `;
          fragment.appendChild(row);
        });

        host.appendChild(fragment);
      };

      const renderModerationHistory = (items) => {
        const host = toNode(moderationHistoryNode);
        if (!host) return;

        host.innerHTML = '';
        const list = Array.isArray(items) ? items.slice(0, 8) : [];
        if (!canRunModeration || list.length === 0) {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';
          row.innerHTML = `<span>${escapeHtml(dashboardCopy.moderationHistoryEmpty)}</span>`;
          host.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        list.forEach((item) => {
          const row = document.createElement('li');
          row.className = 'dashboard-mini-item';

          const status = String(item?.status || '').trim().toUpperCase() || '-';
          const reviewer = String(item?.reviewed_by || '').trim() || '-';
          const reviewedAt = String(item?.reviewed_at || item?.updated_at || '').trim();
          const reviewedAtLabel = reviewedAt ? formatDate(reviewedAt) : dashboardCopy.unknown;
          const body = String(item?.body || '').trim() || '-';
          const compactBody = body.length > 120 ? `${body.slice(0, 117)}...` : body;
          const postRef = String(item?.blog_post_ref || '').trim() || '-';
          const moderationNote = String(item?.moderation_notes || '').trim();

          row.innerHTML = `
            <strong>${escapeHtml(status)}  ${escapeHtml(reviewer)}  ${escapeHtml(reviewedAtLabel)}</strong>
            <span>${escapeHtml(compactBody)}</span>
            <span>${escapeHtml(dashboardCopy.moderationHistoryPost)}: ${escapeHtml(postRef)}</span>
            ${moderationNote ? `<span>${escapeHtml(dashboardCopy.moderationHistoryNote)}: ${escapeHtml(moderationNote)}</span>` : ''}
          `;
          fragment.appendChild(row);
        });

        host.appendChild(fragment);
      };

      const runModerationAction = async (session, commentId, status) => {
        if (!session?.jwt || !commentId || !status) return false;

        let moderationNotes = '';
        if (status === 'rejected' || status === 'spam') {
          moderationNotes = String(window.prompt(dashboardCopy.moderationNotesPrompt, '') || '').trim();
          if (!moderationNotes) {
            setFeedback(dashboardCopy.moderationNotesRequired, true);
            return false;
          }
        }

        const response = await fetch(`${authBaseUrl}/api/blog-comments/moderation/set`, {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            Authorization: `Bearer ${session.jwt}`,
          },
          body: JSON.stringify({
            comment_id: commentId,
            status,
            moderation_notes: moderationNotes || undefined,
          }),
        });

        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          const message = String(payload?.error?.message || dashboardCopy.moderationActionFailed);
          setFeedback(message, true);
          return false;
        }

        setFeedback(dashboardCopy.moderationActionSuccess);
        return true;
      };

      const loadDashboard = async (session) => {
        if (isLoading) return;
        isLoading = true;
        setFeedback(dashboardCopy.loading);

        setText(identityNode, session.username || session.email || dashboardCopy.unknown);
        setText(emailNode, session.email || dashboardCopy.unknown);
        setText(loginAtNode, formatDate(session.loginAt));
        setText(statusNode, dashboardCopy.statusActive);
        setText(createdNode, dashboardCopy.unknown);
        setText(preferredNode, normalizeLanguage(document.documentElement.lang || 'en').toUpperCase());
        applyAccessView('member');
        renderRecentComments([]);
        renderModerationQueue([]);
        renderModerationHistory([]);

        setText(commentsTotalNode, '0');
        setText(commentsPendingNode, '0');
        setText(commentsApprovedNode, '0');
        setText(commentsRejectedNode, '0');
        setText(moderationPendingNode, '0');
        setText(moderationStaleNode, '0');
        setText(moderationOldestNode, '0h');
        if (toNode(moderationAlertNode)) {
          toNode(moderationAlertNode).hidden = true;
        }

        setText(localeCoverageNode, '0%');
        setText(localeGapsNode, '0');
        setText(localeDeployNode, '0');
        ownerPendingCount = 0;
        ownerStalePendingCount = 0;
        ownerLocaleGapCount = 0;
        ownerLocaleDeployCount = 0;
        ownerFingerprintSha = '';
        setText(ownerPendingNode, '0');
        setText(ownerLocaleGapsNode, '0');
        setText(ownerLocaleDeployNode, '0');
        setText(ownerReleaseStatusNode, dashboardCopy.ownerSummaryStatusUnknown);
        setText(ownerRefreshedNode, dashboardCopy.unknown);
        syncOwnerWidgets();
        lastActivityHasErrors = false;
        renderActivityFeed(lastActivityHasErrors, { includeLive: false, persist: false });
        if (toNode(localeNote)) {
          toNode(localeNote).hidden = true;
        }

        let hadErrors = false;

        const authHeaders = {
          Accept: 'application/json',
          Authorization: `Bearer ${session.jwt}`,
        };

        let userPayload = null;

        try {
          const response = await fetch(`${authBaseUrl}/api/users/me?populate=role`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => null);
            userPayload = payload;
            setText(identityNode, payload?.username || session.username || session.email || dashboardCopy.unknown);
            setText(emailNode, payload?.email || session.email || dashboardCopy.unknown);
            setText(createdNode, formatDate(payload?.createdAt));
            if (payload?.blocked === true) {
              setText(statusNode, dashboardCopy.statusBlocked);
            } else if (payload?.confirmed === false) {
              setText(statusNode, dashboardCopy.statusPending);
            } else {
              setText(statusNode, dashboardCopy.statusActive);
            }
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        const access = applyAccessView(inferRole(userPayload, session));

        try {
          const response = await fetch(`${authBaseUrl}/api/user-preferences/me`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => null);
            const preferred = normalizeLanguage(payload?.data?.preferred_ui_language || '');
            if (preferred) {
              setText(preferredNode, preferred.toUpperCase());
            }
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        try {
          const response = await fetch(`${authBaseUrl}/api/blog-comments/me/list?limit=30`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => ({}));
            const items = Array.isArray(payload?.data) ? payload.data : [];
            const pending = items.filter((item) => String(item?.status || '').toLowerCase() === 'pending').length;
            const approved = items.filter((item) => String(item?.status || '').toLowerCase() === 'approved').length;
            const rejected = items.filter((item) => {
              const status = String(item?.status || '').toLowerCase();
              return status === 'rejected' || status === 'spam' || status === 'deleted';
            }).length;

            setText(commentsTotalNode, String(items.length));
            setText(commentsPendingNode, String(pending));
            setText(commentsApprovedNode, String(approved));
            setText(commentsRejectedNode, String(rejected));
            renderRecentComments(items);
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        if (access.isEditor) {
          try {
            const response = await fetch(
              `${authBaseUrl}/api/blog-comments/moderation/list?status=all&limit=40`,
              { headers: authHeaders }
            );
            if (response.ok) {
              const payload = await response.json().catch(() => ({}));
              const items = Array.isArray(payload?.data) ? payload.data : [];
              const pendingItems = items.filter((item) => String(item?.status || '').toLowerCase() === 'pending');
              const reviewedItems = items
                .filter((item) => String(item?.status || '').toLowerCase() !== 'pending')
                .sort((a, b) => {
                  const aTs = new Date(String(a?.reviewed_at || a?.updated_at || a?.created_at || 0)).getTime();
                  const bTs = new Date(String(b?.reviewed_at || b?.updated_at || b?.created_at || 0)).getTime();
                  return Number.isFinite(bTs) && Number.isFinite(aTs) ? bTs - aTs : 0;
                });
              ownerPendingCount = pendingItems.length;
              setText(ownerPendingNode, String(ownerPendingCount));
              renderModerationQueue(pendingItems);
              renderModerationHistory(reviewedItems);
            } else {
              hadErrors = true;
            }
          } catch {
            hadErrors = true;
          }
        } else {
          ownerPendingCount = 0;
          ownerStalePendingCount = 0;
          setText(ownerPendingNode, '0');
          renderModerationQueue([]);
          renderModerationHistory([]);
        }

        try {
          const response = await fetch(`${authBaseUrl}/api/ui-locales/meta/progress?reference_locale=en`, { headers: authHeaders });
          if (response.ok) {
            const payload = await response.json().catch(() => ({}));
            const rows = Array.isArray(payload?.data?.locales) ? payload.data.locales : [];
            const summary = payload?.data?.summary && typeof payload.data.summary === 'object' ? payload.data.summary : {};
            const currentLocale = normalizeLanguage(document.documentElement.lang || 'en');
            const currentRow = rows.find((row) => normalizeLanguage(row?.ui_locale) === currentLocale) || null;

            const coverage = Number(currentRow?.coverage_percent || 0);
            const gapLocales = rows.filter((row) => Number(row?.missing_keys || 0) + Number(row?.untranslated_keys || 0) > 0).length;
            const deployRequired = Number(summary?.deploy_required_count || 0);

            setText(localeCoverageNode, `${Math.round(coverage * 100) / 100}%`);
            setText(localeGapsNode, String(gapLocales));
            setText(localeDeployNode, String(deployRequired));
            ownerLocaleGapCount = gapLocales;
            ownerLocaleDeployCount = deployRequired;
            setText(ownerLocaleGapsNode, String(ownerLocaleGapCount));
            setText(ownerLocaleDeployNode, String(ownerLocaleDeployCount));
          } else if (response.status === 401 || response.status === 403) {
            if (toNode(localeNote)) {
              toNode(localeNote).hidden = false;
            }
            ownerLocaleGapCount = 0;
            ownerLocaleDeployCount = 0;
            setText(ownerLocaleGapsNode, '0');
            setText(ownerLocaleDeployNode, '0');
          } else {
            hadErrors = true;
          }
        } catch {
          hadErrors = true;
        }

        if (access.isAdmin) {
          await refreshOwnerFingerprint();
          setText(ownerRefreshedNode, formatDate(new Date().toISOString()));
        }
        syncOwnerReleaseStatus();
        syncOwnerWidgets();
        lastActivityHasErrors = hadErrors;
        renderActivityFeed(lastActivityHasErrors);

        if (hadErrors) {
          setFeedback(dashboardCopy.loadFailed, true);
        } else {
          setFeedback('');
        }
        isLoading = false;
      };

      const init = async () => {
        const session = readSession();
        if (!session) {
          if (toNode(loggedOutPanel)) toNode(loggedOutPanel).hidden = false;
          if (toNode(authedPanel)) toNode(authedPanel).hidden = true;
          return;
        }

        currentSession = session;
        if (toNode(loggedOutPanel)) toNode(loggedOutPanel).hidden = true;
        if (toNode(authedPanel)) toNode(authedPanel).hidden = false;

        activityHistory = readActivityHistory();
        laneCollapsedState = readLaneCollapsedState();
        renderActivityFeed(false, { includeLive: false, persist: false });
        startActivityTicker();

        await loadDashboard(session);

        if (refreshButton instanceof HTMLButtonElement) {
          refreshButton.addEventListener('click', async () => {
            refreshButton.disabled = true;
            try {
              await loadDashboard(session);
            } finally {
              refreshButton.disabled = false;
            }
          });
        }

        if (activityWarnOnlyNode instanceof HTMLInputElement) {
          activityWarnOnlyNode.addEventListener('change', () => {
            renderActivityFeed(lastActivityHasErrors, { includeLive: false, persist: false });
          });
        }

        if (activityClearNode instanceof HTMLButtonElement) {
          activityClearNode.addEventListener('click', () => {
            activityHistory = [];
            persistActivityHistory();
            renderActivityFeed(lastActivityHasErrors, { includeLive: true, persist: false });
            setFeedback(dashboardCopy.activityClearHistoryDone);
          });
        }

        laneToggleButtons.forEach((button) => {
          if (!(button instanceof HTMLButtonElement)) return;
          button.addEventListener('click', () => {
            const laneNode = button.closest('[data-dashboard-lane]');
            if (!(laneNode instanceof HTMLElement)) return;
            const currentlyCollapsed = laneNode.dataset.collapsed === 'true';
            updateLaneCollapsedState(laneNode, !currentlyCollapsed, { persist: true });
            requestSectionSync();
          });
        });

        sectionPillLinks.forEach((link) => {
          if (!(link instanceof HTMLAnchorElement)) return;
          link.addEventListener('click', () => {
            const href = String(link.getAttribute('href') || '').trim();
            setActiveSectionPill(href);
          });
        });

        window.addEventListener('hashchange', () => {
          setActiveSectionPill(window.location.hash);
        });

        window.addEventListener('scroll', requestSectionSync, { passive: true });

        copyCommandButtons.forEach((button) => {
          if (!(button instanceof HTMLButtonElement)) return;
          button.addEventListener('click', async () => {
            const command = String(button.dataset.commandValue || '').trim();
            if (!command) return;
            try {
              await navigator.clipboard.writeText(command);
              setFeedback(dashboardCopy.controlReleaseCopied);
            } catch {
              setFeedback(`${dashboardCopy.controlReleaseCopyFailed} ${command}`, true);
            }
          });
        });

        if (moderationListNode instanceof HTMLElement) {
          moderationListNode.addEventListener('click', async (event) => {
            const target = event.target;
            const button =
              target instanceof HTMLElement ? target.closest('[data-dashboard-moderate]') : null;
            if (!(button instanceof HTMLButtonElement)) return;
            if (!canRunModeration || !currentSession) return;

            const commentId = String(button.dataset.commentId || '').trim();
            const status = String(button.dataset.dashboardModerate || '').trim().toLowerCase();
            if (!commentId || !status) return;

            button.disabled = true;
            try {
              const ok = await runModerationAction(currentSession, commentId, status);
              if (ok) {
                await loadDashboard(currentSession);
              }
            } finally {
              button.disabled = false;
            }
          });
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        void init();
      }
    })();
  </script>
</MainLayout>

<style>
  .dashboard-shell {
    gap: 1rem;
  }

  .dashboard-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .dashboard-section-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }

  .dashboard-section-pill {
    display: inline-flex;
    align-items: center;
    min-height: 1.9rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--ink);
    font-size: 0.78rem;
    font-weight: 600;
    padding: 0.18rem 0.64rem;
  }

  .dashboard-section-pill:hover {
    text-decoration: none;
    border-color: color-mix(in srgb, var(--brand) 28%, var(--border));
    background: var(--brand-soft);
  }

  .dashboard-section-pill.is-active {
    border-color: color-mix(in srgb, var(--brand) 36%, var(--border));
    background: color-mix(in srgb, var(--brand-soft) 70%, var(--surface-2));
    color: var(--brand-strong);
  }

  .dashboard-lanes {
    display: grid;
    gap: 0.95rem;
  }

  .dashboard-lane {
    border: 1px solid var(--border);
    border-radius: 0.9rem;
    background: color-mix(in srgb, var(--surface-2) 68%, transparent);
    padding: 0.75rem;
  }

  .dashboard-lane-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .dashboard-lane-title-wrap {
    display: grid;
    gap: 0.2rem;
  }

  .dashboard-lane-title {
    margin: 0;
    font-size: 1.02rem;
    font-weight: 700;
  }

  .dashboard-lane-toggle {
    width: 2rem;
    height: 2rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--ink);
    font-size: 1rem;
    font-weight: 700;
    line-height: 1;
    cursor: pointer;
    flex: 0 0 auto;
  }

  .dashboard-lane-toggle:hover {
    border-color: color-mix(in srgb, var(--brand) 28%, var(--border));
    background: var(--brand-soft);
  }

  .dashboard-role-pill {
    margin: 0;
    display: grid;
    gap: 0.1rem;
    text-align: right;
    padding: 0.42rem 0.58rem;
    border: 1px solid var(--border);
    border-radius: 0.72rem;
    background: var(--surface-2);
  }

  .dashboard-role-pill span {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--ink-muted);
  }

  .dashboard-role-pill strong {
    font-size: 0.84rem;
    color: var(--ink);
  }

  .dashboard-grid {
    display: grid;
    gap: 0.875rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .dashboard-dl {
    margin: 0;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .dashboard-dl dt {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--ink-muted);
  }

  .dashboard-dl dd {
    margin: 0.25rem 0 0;
    font-weight: 600;
    color: var(--ink);
  }

  .dashboard-kpi-grid {
    display: grid;
    gap: 0.55rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .dashboard-kpi {
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.12rem;
    padding: 0.55rem 0.65rem;
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    background: var(--surface-2);
  }

  .dashboard-kpi span {
    color: var(--ink-muted);
    font-size: 0.78rem;
  }

  .dashboard-kpi strong {
    font-size: 1rem;
    line-height: 1.2;
  }

  .dashboard-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .dashboard-footer {
    border-style: dashed;
  }

  .dashboard-footer-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .dashboard-command-grid {
    display: grid;
    gap: 0.6rem;
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .dashboard-command-card {
    display: grid;
    gap: 0.45rem;
    padding: 0.6rem;
    border: 1px solid var(--border);
    border-radius: 0.72rem;
    background: var(--surface-2);
  }

  .dashboard-command-card strong {
    font-size: 0.83rem;
    color: var(--ink);
  }

  .dashboard-command-card code {
    display: block;
    font-size: 0.72rem;
    line-height: 1.35;
    color: var(--ink-muted);
    word-break: break-word;
  }

  .dashboard-owner-summary-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.45rem;
  }

  .dashboard-owner-summary-list li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.5rem 0.65rem;
    border: 1px solid var(--border);
    border-radius: 0.65rem;
    background: var(--surface-2);
  }

  .dashboard-owner-summary-list span {
    font-size: 0.78rem;
    color: var(--ink-muted);
  }

  .dashboard-owner-summary-list strong {
    font-size: 0.86rem;
    color: var(--ink);
  }

  .dashboard-owner-widgets {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.55rem;
  }

  .dashboard-owner-widget {
    border: 1px solid var(--border);
    border-radius: 0.72rem;
    background: var(--surface-2);
    padding: 0.55rem 0.62rem;
    display: grid;
    gap: 0.32rem;
  }

  .dashboard-owner-widget header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.55rem;
  }

  .dashboard-owner-widget header span {
    font-size: 0.75rem;
    color: var(--ink-muted);
  }

  .dashboard-owner-widget header strong {
    font-size: 0.74rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .dashboard-owner-widget-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .dashboard-owner-widget-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.05rem;
    height: 1.05rem;
    padding: 0 0.28rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--brand) 72%, #ffffff);
    color: #ffffff;
    font-size: 0.68rem;
    font-weight: 700;
    line-height: 1;
  }

  .dashboard-owner-widget[data-state='ok'] {
    border-color: color-mix(in srgb, #1f8d4c 38%, var(--border));
  }

  .dashboard-owner-widget[data-state='warn'] {
    border-color: color-mix(in srgb, #b9382f 42%, var(--border));
  }

  .dashboard-owner-widget[data-state='info'] {
    border-color: color-mix(in srgb, var(--brand) 36%, var(--border));
  }

  .dashboard-activity-feed {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.45rem;
  }

  .dashboard-activity-item {
    border: 1px solid var(--border);
    border-radius: 0.65rem;
    background: var(--surface-2);
    padding: 0.5rem 0.6rem;
    display: grid;
    gap: 0.2rem;
  }

  .dashboard-activity-item strong {
    font-size: 0.72rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .dashboard-activity-head {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .dashboard-activity-time {
    font-size: 0.72rem;
    color: var(--ink-muted);
  }

  .dashboard-activity-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    width: fit-content;
    padding: 0.18rem 0.5rem;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: var(--surface-2);
    font-size: 0.76rem;
    color: var(--ink);
  }

  .dashboard-activity-toggle input {
    margin: 0;
  }

  .dashboard-activity-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .dashboard-activity-item span {
    font-size: 0.84rem;
    line-height: 1.35;
    color: var(--ink);
  }

  .dashboard-activity-link {
    justify-self: start;
    display: inline-flex;
    align-items: center;
    min-height: 1.75rem;
    padding: 0.16rem 0.56rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: color-mix(in srgb, var(--brand) 14%, var(--surface-2));
    color: var(--ink);
    font-size: 0.76rem;
    font-weight: 600;
    text-decoration: none;
  }

  .dashboard-activity-link:hover {
    text-decoration: none;
    border-color: color-mix(in srgb, var(--brand) 36%, var(--border));
    background: color-mix(in srgb, var(--brand) 20%, var(--surface-2));
  }

  .dashboard-activity-item--warn {
    border-color: color-mix(in srgb, #b9382f 46%, var(--border));
  }

  .dashboard-activity-item--ok {
    border-color: color-mix(in srgb, #1f8d4c 42%, var(--border));
  }

  .dashboard-capabilities {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.45rem;
  }

  .dashboard-capabilities li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.5rem 0.65rem;
    border-radius: 0.65rem;
    border: 1px solid var(--border);
    background: var(--surface-2);
    font-size: 0.84rem;
  }

  .dashboard-capabilities strong {
    font-size: 0.78rem;
    color: var(--ink-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .dashboard-mini-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.45rem;
  }

  .dashboard-mini-item {
    border: 1px solid var(--border);
    border-radius: 0.65rem;
    background: var(--surface-2);
    padding: 0.5rem 0.6rem;
    display: grid;
    gap: 0.2rem;
  }

  .dashboard-mini-item strong {
    font-size: 0.74rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .dashboard-mini-item span {
    font-size: 0.85rem;
    color: var(--ink);
    line-height: 1.35;
  }

  .dashboard-mini-title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 700;
  }

  .dashboard-moderation-wrap {
    padding-top: 0.25rem;
  }

  .dashboard-moderation-item {
    gap: 0.45rem;
  }

  .dashboard-alert {
    color: #b9382f;
    font-weight: 600;
  }

  .dashboard-action-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  @media (max-width: 960px) {
    .dashboard-lane-head {
      flex-direction: column;
      align-items: flex-start;
    }

    .dashboard-role-pill {
      text-align: left;
      width: 100%;
    }

    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .dashboard-command-grid {
      grid-template-columns: 1fr;
    }

    .dashboard-dl {
      grid-template-columns: 1fr;
    }

    .dashboard-owner-widgets {
      grid-template-columns: 1fr;
    }
  }
</style>
