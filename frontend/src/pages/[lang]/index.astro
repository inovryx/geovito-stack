---
import MainLayout from '../../layouts/MainLayout.astro';
import StateBanner from '../../components/StateBanner.astro';
import SearchBar from '../../components/SearchBar.astro';
import AdSlot from '../../components/ads/AdSlot.astro';
import Badge from '../../components/ui/Badge.astro';
import EmptyState from '../../components/ui/EmptyState.astro';
import { resolveTranslation } from '../../lib/languageState';
import { getAtlasPlaces, getBlogPosts, getUiPage } from '../../lib/strapi';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../lib/pageHelpers';
import { getUiMessages, translate } from '../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const runtimeMode = Astro.url.searchParams.get('translate') === '1';
const [homePage, places, posts] = await Promise.all([getUiPage('home'), getAtlasPlaces(), getBlogPosts()]);

const homeResolution = homePage
  ? resolveTranslation(homePage.translations, lang, homePage.canonical_language, runtimeMode)
  : null;
const enHomeResolution = homePage ? resolveTranslation(homePage.translations, 'en', homePage.canonical_language) : null;

const homeContent = homeResolution?.output;
const hasMockContent =
  Boolean(homePage?.mock) || places.some((item) => item.mock === true) || posts.some((item) => item.mock === true);

const topCountries = places
  .filter((place) => place.place_type === 'country')
  .map((place) => {
    const resolved = resolveTranslation(place.translations, lang, place.canonical_language);
    const requested = resolved.requested;
    const complete = resolved.complete;
    const slug = requested?.status === 'complete' ? requested.slug : complete?.slug;

    return {
      place_id: place.place_id,
      title: resolved.output?.title || place.place_id,
      href: slug ? pathForLanguage(lang, `atlas/${slug}`) : null,
      status: requested?.status || 'missing',
    };
  })
  .filter((entry) => entry.href)
  .sort((a, b) => a.title.localeCompare(b.title))
  .slice(0, 8);

const DEFAULT_CITY_LIKE_LEVELS = ['city', 'locality', 'admin2'];
const topCities = places
  .filter((place) => {
    const levels =
      Array.isArray(place.country_profile?.city_like_levels) && place.country_profile?.city_like_levels.length > 0
        ? place.country_profile.city_like_levels
        : DEFAULT_CITY_LIKE_LEVELS;
    return levels.includes(String(place.place_type || '').toLowerCase());
  })
  .map((place) => {
    const resolved = resolveTranslation(place.translations, lang, place.canonical_language);
    const requested = resolved.requested;
    const complete = resolved.complete;
    const slug = requested?.status === 'complete' ? requested.slug : complete?.slug;

    return {
      place_id: place.place_id,
      title: resolved.output?.title || place.place_id,
      href: slug ? pathForLanguage(lang, `atlas/${slug}`) : null,
      status: requested?.status || 'missing',
    };
  })
  .filter((entry) => entry.href)
  .sort((a, b) => a.title.localeCompare(b.title))
  .slice(0, 8);

const blogEntries = posts
  .map((post) => {
    const resolved = resolveTranslation(post.translations, lang, post.canonical_language);
    const requested = resolved.requested;
    const complete = resolved.complete;

    if (!resolved.output || !complete?.slug) {
      return null;
    }

    const slug = requested?.status === 'complete' && requested.slug ? requested.slug : complete.slug;

    return {
      post_id: post.post_id,
      title: resolved.output.title || post.post_id,
      href: pathForLanguage(lang, `blog/${slug}`),
      status: requested?.status || 'missing',
      published_on: post.published_on || '',
    };
  })
  .filter(Boolean)
  .sort((a, b) => String(b.published_on).localeCompare(String(a.published_on)));

const now = new Date();
const oneWeekAgo = new Date(now);
oneWeekAgo.setDate(now.getDate() - 7);

const newThisWeek = blogEntries.filter((entry) => {
  if (!entry.published_on) return false;
  const publishedAt = new Date(entry.published_on);
  return !Number.isNaN(publishedAt.getTime()) && publishedAt >= oneWeekAgo;
});

const latestPosts = blogEntries.slice(0, 8);

const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language)));
const alternates = toAlternates(languageLinks);
const homeCanonicalPath = enHomeResolution?.complete?.canonical_path || pathForLanguage('en');
const canonical = absoluteUrl(homeCanonicalPath);

const homeIndexable =
  lang === 'en' && homeResolution?.requested?.status === 'complete' && !homeResolution?.isRuntime && homeResolution?.indexable;
const robots = hasMockContent ? 'noindex,nofollow' : homeIndexable ? 'index,follow' : 'noindex,nofollow';

const title = homeContent?.seo?.metaTitle || homeContent?.title || translate(ui, 'home.defaultTitle');
const description = homeContent?.seo?.metaDescription || homeContent?.excerpt || translate(ui, 'home.defaultExcerpt');
---

<MainLayout
  title={title}
  description={description}
  canonical={canonical}
  robots={robots}
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
  showTools={true}
>
  {hasMockContent ? <StateBanner status="mock" language={lang} canonicalPath={canonical} ui={ui} /> : null}

  {
    homeResolution?.isRuntime ? (
      <StateBanner status="runtime" language={lang} canonicalPath={canonical} ui={ui} />
    ) : homeResolution?.isFallback ? (
      <StateBanner status="fallback" language={lang} canonicalPath={canonical} ui={ui} />
    ) : null
  }

  <section class="hero">
    <p class="eyebrow">{translate(ui, 'site.brand')}</p>
    <h1>{homeContent?.title || translate(ui, 'home.defaultTitle')}</h1>
    <p class="hero-lead">{translate(ui, 'home.microHeroLead', {}, 'Plan trips faster with country-to-city exploration in one place.')}</p>

    <SearchBar currentLanguage={lang} ui={ui} variant="large" />

    <div class="micro-hero-chips" aria-label={translate(ui, 'home.searchScope', {}, 'Search scope')}>
      <Badge variant="info">{translate(ui, 'home.chipCountry', {}, 'Country')}</Badge>
      <Badge variant="info">{translate(ui, 'home.chipCity', {}, 'City')}</Badge>
      <Badge variant="info">{translate(ui, 'home.chipLandmark', {}, 'Landmark')}</Badge>
    </div>

    <div class="hero-text-links">
      <a href={pathForLanguage(lang, 'atlas')}>{translate(ui, 'home.exploreAtlas', {}, 'Explore atlas')}</a>
      <a href={pathForLanguage(lang, 'regions')}>{translate(ui, 'home.exploreRegions', {}, 'Browse regions')}</a>
    </div>
  </section>

  <div class="grid two feature-grid">
    <section class="card panel">
      <div class="panel-head">
        <h2>{translate(ui, 'home.topCountries', {}, 'Top countries')}</h2>
        <span class="small">{topCountries.length}/8</span>
      </div>
      {
        topCountries.length ? (
          <ul class="teaser-list">
            {topCountries.map((entry) => (
              <li class="teaser-item">
                <a href={entry.href || '#'}>{entry.title}</a>
                <span class="status-pill">{entry.status}</span>
              </li>
            ))}
          </ul>
        ) : (
          <EmptyState title={translate(ui, 'atlas.list.empty')} icon="MapPinned" />
        )
      }
    </section>

    <section class="card panel">
      <div class="panel-head">
        <h2>{translate(ui, 'home.topCities', {}, 'Top cities')}</h2>
        <span class="small">{topCities.length}/8</span>
      </div>
      {
        topCities.length ? (
          <ul class="teaser-list">
            {topCities.map((entry) => (
              <li class="teaser-item">
                <a href={entry.href || '#'}>{entry.title}</a>
                <span class="status-pill">{entry.status}</span>
              </li>
            ))}
          </ul>
        ) : (
          <EmptyState title={translate(ui, 'home.noTrending')} icon="Building2" />
        )
      }
    </section>
  </div>

  <AdSlot {...{ slot: 'home_mid' }} class="home-mid-ad" testId="ad-slot-home-mid" />

  <div class="grid two feature-grid">
    <section class="card panel">
      <div class="panel-head">
        <h2>{translate(ui, 'home.newThisWeek', {}, 'New this week')}</h2>
        <span class="small">{newThisWeek.length}</span>
      </div>
      {
        newThisWeek.length ? (
          <ul class="teaser-list">
            {newThisWeek.slice(0, 8).map((entry) => (
              <li class="teaser-item">
                <a href={entry.href}>{entry.title}</a>
                <span class="small">{entry.published_on}</span>
              </li>
            ))}
          </ul>
        ) : (
          <EmptyState
            title={translate(ui, 'home.noNewThisWeek', {}, 'No new items this week')}
            description={translate(ui, 'home.noNewThisWeekHint', {}, 'Fresh entries will appear automatically.')}
            icon="Clock3"
          />
        )
      }
    </section>

    <section class="card panel">
      <div class="panel-head">
        <h2>{translate(ui, 'home.latestBlogPosts', {}, 'Latest blog posts')}</h2>
        <span class="small">{latestPosts.length}</span>
      </div>
      {
        latestPosts.length ? (
          <ul class="teaser-list">
            {latestPosts.map((entry) => (
              <li class="teaser-item">
                <a href={entry.href}>{entry.title}</a>
                <span class="status-pill">{entry.status}</span>
              </li>
            ))}
          </ul>
        ) : (
          <EmptyState title={translate(ui, 'blog.listHint')} icon="Newspaper" />
        )
      }
    </section>
  </div>
</MainLayout>
