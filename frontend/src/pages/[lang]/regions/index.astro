---
import MainLayout from '../../../layouts/MainLayout.astro';
import StateBanner from '../../../components/StateBanner.astro';
import { resolveTranslation } from '../../../lib/languageState';
import { getRegionGroups } from '../../../lib/strapi';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const groups = await getRegionGroups();
const hasMockContent = groups.some((group) => group.mock === true);

const entries = groups
  .map((group) => {
    const resolved = resolveTranslation(group.translations, lang, group.canonical_language);
    const requested = resolved.requested;
    const complete = resolved.complete;

    if (!resolved.output || !complete?.slug) return null;

    const slug = requested?.status === 'complete' && requested.slug ? requested.slug : complete.slug;
    return {
      region_key: group.region_key,
      title: resolved.output.title || group.region_key,
      excerpt: resolved.output.excerpt || '',
      href: pathForLanguage(lang, `regions/${slug}`),
      status: requested?.status || 'missing',
      mock: group.mock === true,
    };
  })
  .filter(Boolean)
  .sort((a, b) => a.title.localeCompare(b.title));

const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'regions')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage('en', 'regions'));

const hasIndexableEn = entries.some((entry) => entry.status === 'complete' && entry.mock === false);
const robots = lang === 'en' && !hasMockContent && hasIndexableEn ? 'index,follow' : 'noindex,nofollow';
---

<MainLayout
  title={translate(ui, 'regions.list.title')}
  description={translate(ui, 'regions.list.description')}
  canonical={canonical}
  robots={robots}
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
  showTools={true}
>
  {hasMockContent ? <StateBanner status="mock" language={lang} canonicalPath={canonical} ui={ui} /> : null}

  <h1>{translate(ui, 'regions.list.title')}</h1>
  <p class="small">{translate(ui, 'regions.list.description')}</p>

  {
    entries.length ? (
      <div class="grid">
        {entries.map((entry) => (
          <article class="card">
            <a href={entry.href}>
              <h2>{entry.title}</h2>
            </a>
            <span class="status-pill">{entry.status}</span>
            <p class="small">{entry.excerpt}</p>
          </article>
        ))}
      </div>
    ) : (
      <div class="empty-state">
        <p>{translate(ui, 'regions.list.empty')}</p>
      </div>
    )
  }
</MainLayout>
