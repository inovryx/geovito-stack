---
export const prerender = false;

import MainLayout from '../../../layouts/MainLayout.astro';
import EmptyState from '../../../components/ui/EmptyState.astro';
import { DEFAULT_LANGUAGE, isSupportedLanguage, pathForLanguage } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { getUiMessages, translate } from '../../../lib/uiLanguage';
import { resolveOpsAccess } from '../../../lib/opsControl';

const requestedLang = Astro.params.lang || DEFAULT_LANGUAGE;
const lang = isSupportedLanguage(requestedLang) ? requestedLang : DEFAULT_LANGUAGE;
const ui = getUiMessages(lang);
const t = (key: string, fallback: string, params: Record<string, string | number> = {}) =>
  translate(ui, key, params, fallback);

const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'ops/metrics')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage(lang, 'ops/metrics'));

const runtimeEnv = (Astro.locals as Record<string, any> | undefined)?.runtime?.env;
const opsAccess = await resolveOpsAccess(Astro.request, runtimeEnv);
const canViewOps = opsAccess.canView;

Astro.response.status = 200;
Astro.response.headers.set('Cache-Control', 'private, no-store');
Astro.response.headers.set('Vary', 'X-Geovito-Ops-Token');
---

<MainLayout
  title={t('ops.title', 'Ops Metrics')}
  description={t('ops.subtitle', 'Owner-only aggregated metrics workspace.')}
  canonical={canonical}
  robots="noindex,nofollow"
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  {canViewOps ? <meta slot="head" name="geovito:ops" content="enabled" /> : null}

  {
    canViewOps ? (
      <>
        <section class="card panel gv-card ops-header" data-ops-root>
          <h1 class="gv-h1" data-ops-title>{t('ops.title', 'Ops Metrics')}</h1>
          <p class="gv-body">Owner-only metrics area. Data connectors can be reviewed here without exposing public details.</p>
          <p class="gv-caption">Noindex utility page.</p>
        </section>

        <section class="ops-kpi-grid" aria-label={t('ops.title', 'Ops Metrics')}>
          <article class="card gv-card ops-kpi-card">
            <p class="gv-caption ops-kpi-label">Metrics feed</p>
            <p class="ops-kpi-value">ready</p>
          </article>
          <article class="card gv-card ops-kpi-card">
            <p class="gv-caption ops-kpi-label">Refresh mode</p>
            <p class="ops-kpi-value">manual</p>
          </article>
          <article class="card gv-card ops-kpi-card">
            <p class="gv-caption ops-kpi-label">Visibility</p>
            <p class="ops-kpi-value">owner-only</p>
          </article>
        </section>

        <section class="card panel gv-card">
          <EmptyState
            title={t('ops.empty.title', 'No metrics collected yet')}
            description={t('ops.empty.desc', 'Run the metrics collector locally, then refresh this page.')}
            icon="Database"
          />
        </section>
      </>
    ) : (
      <section class="card panel gv-card" data-ops-placeholder>
        <EmptyState title="Not available" description="This page is not available." icon="ShieldOff" />
      </section>
    )
  }
</MainLayout>

<style>
  .ops-header {
    margin-bottom: 0.86rem;
  }

  .ops-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.72rem;
    margin-bottom: 0.86rem;
  }

  .ops-kpi-card {
    display: grid;
    gap: 0.3rem;
  }

  .ops-kpi-label {
    margin: 0;
  }

  .ops-kpi-value {
    margin: 0;
    font-size: 1.12rem;
    line-height: 1.25;
    font-weight: 700;
    color: var(--ink);
  }

  @media (max-width: 900px) {
    .ops-kpi-grid {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>
