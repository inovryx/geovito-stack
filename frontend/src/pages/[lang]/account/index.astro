---
import MainLayout from '../../../layouts/MainLayout.astro';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { resolveStrapiBaseUrl } from '../../../lib/strapiConfig';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'account')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage('en', 'account'));
const loginPath = pathForLanguage(lang, 'login');
const authBaseUrl = resolveStrapiBaseUrl({
  STRAPI_URL: import.meta.env.STRAPI_URL as string | undefined,
  PUBLIC_STRAPI_URL: import.meta.env.PUBLIC_STRAPI_URL as string | undefined,
  CF_PAGES: process.env.CF_PAGES,
  NODE_ENV: process.env.NODE_ENV,
  ALLOW_LOCALHOST_STRAPI:
    process.env.ALLOW_LOCALHOST_STRAPI || (import.meta.env.ALLOW_LOCALHOST_STRAPI as string | undefined),
});
const availableLanguages = SUPPORTED_LANGUAGES;
const accountCopy = {
  loginRequiredTitle: translate(ui, 'account.loginRequiredTitle', {}, 'Login required'),
  loginRequiredBody: translate(ui, 'account.loginRequiredBody', {}, 'You need to login before managing account preferences.'),
  loginCta: translate(ui, 'account.loginCta', {}, 'Go to login'),
  profileTitle: translate(ui, 'account.profileTitle', {}, 'Profile overview'),
  profileDescription: translate(ui, 'account.profileDescription', {}, 'Basic account identity pulled from your authenticated session.'),
  profileUsername: translate(ui, 'account.profileUsername', {}, 'Username'),
  profileEmail: translate(ui, 'account.profileEmail', {}, 'Email'),
  profileCreatedAt: translate(ui, 'account.profileCreatedAt', {}, 'Member since'),
  profileStatus: translate(ui, 'account.profileStatus', {}, 'Status'),
  profileStatusActive: translate(ui, 'account.profileStatusActive', {}, 'Active'),
  profileStatusPending: translate(ui, 'account.profileStatusPending', {}, 'Pending confirmation'),
  profileStatusBlocked: translate(ui, 'account.profileStatusBlocked', {}, 'Blocked'),
  profileUnknown: translate(ui, 'account.profileUnknown', {}, 'Unknown'),
  profileSyncFallback: translate(
    ui,
    'account.profileSyncFallback',
    {},
    'Could not refresh profile from API. Showing local session snapshot.'
  ),
  commentsTitle: translate(ui, 'account.commentsTitle', {}, 'My comment queue'),
  commentsDescription: translate(
    ui,
    'account.commentsDescription',
    {},
    'Track moderation status of your recent blog comments.'
  ),
  commentsPending: translate(ui, 'account.commentsPending', {}, 'Pending'),
  commentsApproved: translate(ui, 'account.commentsApproved', {}, 'Approved'),
  commentsRejected: translate(ui, 'account.commentsRejected', {}, 'Rejected'),
  commentsSpam: translate(ui, 'account.commentsSpam', {}, 'Spam'),
  commentsNone: translate(ui, 'account.commentsNone', {}, 'No comments yet.'),
  commentsRefresh: translate(ui, 'account.commentsRefresh', {}, 'Refresh comments'),
  commentsLoading: translate(ui, 'account.commentsLoading', {}, 'Loading comments...'),
  commentsLoadFailed: translate(ui, 'account.commentsLoadFailed', {}, 'Could not load comments right now.'),
  commentsPostRef: translate(ui, 'account.commentsPostRef', {}, 'Post'),
  commentsStatus: translate(ui, 'account.commentsStatus', {}, 'Status'),
  commentsModerationNote: translate(ui, 'account.commentsModerationNote', {}, 'Moderation note'),
  localeProgressTitle: translate(ui, 'account.localeProgressTitle', {}, 'Translation progress'),
  localeProgressDescription: translate(
    ui,
    'account.localeProgressDescription',
    {},
    'Track missing and untranslated UI keys by language.'
  ),
  localeProgressRefresh: translate(ui, 'account.localeProgressRefresh', {}, 'Refresh progress'),
  localeProgressLoading: translate(ui, 'account.localeProgressLoading', {}, 'Loading translation progress...'),
  localeProgressLoadFailed: translate(
    ui,
    'account.localeProgressLoadFailed',
    {},
    'Could not load translation progress right now.'
  ),
  localeProgressNone: translate(ui, 'account.localeProgressNone', {}, 'No locale progress rows found.'),
  localeProgressReference: translate(ui, 'account.localeProgressReference', {}, 'Reference'),
  localeProgressMissing: translate(ui, 'account.localeProgressMissing', {}, 'Missing'),
  localeProgressUntranslated: translate(ui, 'account.localeProgressUntranslated', {}, 'Untranslated'),
  localeProgressCoverage: translate(ui, 'account.localeProgressCoverage', {}, 'Coverage'),
  localeProgressDeployRequired: translate(ui, 'account.localeProgressDeployRequired', {}, 'Deploy required'),
  localeProgressShowDetails: translate(ui, 'account.localeProgressShowDetails', {}, 'Show key examples'),
  localeProgressHideDetails: translate(ui, 'account.localeProgressHideDetails', {}, 'Hide key examples'),
  localeProgressLoadingDetails: translate(ui, 'account.localeProgressLoadingDetails', {}, 'Loading key examples...'),
  localeProgressDetailsEmpty: translate(ui, 'account.localeProgressDetailsEmpty', {}, 'No missing/untranslated keys found.'),
  localeProgressDetailsKey: translate(ui, 'account.localeProgressDetailsKey', {}, 'Key'),
  localeProgressDetailsRef: translate(ui, 'account.localeProgressDetailsRef', {}, 'Reference'),
  localeProgressDetailsLocale: translate(ui, 'account.localeProgressDetailsLocale', {}, 'Locale'),
  localeProgressDetailsState: translate(ui, 'account.localeProgressDetailsState', {}, 'State'),
  localeProgressExportCsv: translate(ui, 'account.localeProgressExportCsv', {}, 'Export CSV'),
  localeProgressExportDone: translate(ui, 'account.localeProgressExportDone', {}, 'CSV exported for {locale}.'),
  localeProgressExportFailed: translate(ui, 'account.localeProgressExportFailed', {}, 'Could not export CSV right now.'),
  localeProgressExportEmpty: translate(ui, 'account.localeProgressExportEmpty', {}, 'No rows available for CSV export.'),
  localeProgressFilterLabel: translate(ui, 'account.localeProgressFilterLabel', {}, 'Preview filter'),
  localeProgressFilterAll: translate(ui, 'account.localeProgressFilterAll', {}, 'All'),
  localeProgressFilterMissing: translate(ui, 'account.localeProgressFilterMissing', {}, 'Missing only'),
  localeProgressFilterUntranslated: translate(
    ui,
    'account.localeProgressFilterUntranslated',
    {},
    'Untranslated only'
  ),
  localeProgressActiveFilter: translate(ui, 'account.localeProgressActiveFilter', {}, 'Active filter'),
  localeProgressFilteredKeys: translate(ui, 'account.localeProgressFilteredKeys', {}, 'Filtered keys'),
  localeProgressDeployActionTitle: translate(ui, 'account.localeProgressDeployActionTitle', {}, 'Deployment reminder'),
  localeProgressDeployActionBody: translate(
    ui,
    'account.localeProgressDeployActionBody',
    {},
    '{count} locale(s) are pending deploy. Run this on VPS:'
  ),
  localeProgressDeployCommand: translate(ui, 'account.localeProgressDeployCommand', {}, 'bash tools/ui_locale_sync.sh'),
  localeProgressDeployCopy: translate(ui, 'account.localeProgressDeployCopy', {}, 'Copy command'),
  localeProgressDeployReleaseCommand: translate(
    ui,
    'account.localeProgressDeployReleaseCommand',
    {},
    'bash tools/release_deploy_smoke.sh --with-moderation'
  ),
  localeProgressDeployWorkflowCommand: translate(
    ui,
    'account.localeProgressDeployWorkflowCommand',
    {},
    'bash tools/ui_locale_sync.sh && EXPECTED_SHA7=$(git rev-parse --short=7 HEAD) bash tools/release_deploy_smoke.sh --with-moderation'
  ),
  localeProgressDeployCopyRelease: translate(ui, 'account.localeProgressDeployCopyRelease', {}, 'Copy release command'),
  localeProgressDeployCopyWorkflow: translate(ui, 'account.localeProgressDeployCopyWorkflow', {}, 'Copy full workflow'),
  localeProgressDeployCopyDone: translate(ui, 'account.localeProgressDeployCopyDone', {}, 'Command copied.'),
  localeProgressDeployCopyReleaseDone: translate(
    ui,
    'account.localeProgressDeployCopyReleaseDone',
    {},
    'Release command copied.'
  ),
  localeProgressDeployCopyWorkflowDone: translate(
    ui,
    'account.localeProgressDeployCopyWorkflowDone',
    {},
    'Workflow command copied.'
  ),
  localeProgressDeployCopyFailed: translate(
    ui,
    'account.localeProgressDeployCopyFailed',
    {},
    'Clipboard blocked. Copy command manually.'
  ),
  localeProgressMissingLocales: translate(ui, 'account.localeProgressMissingLocales', {}, 'Locales with missing'),
  localeProgressUntranslatedLocales: translate(
    ui,
    'account.localeProgressUntranslatedLocales',
    {},
    'Locales with untranslated'
  ),
  localeProgressDeployCount: translate(ui, 'account.localeProgressDeployCount', {}, 'Locales pending deploy'),
  languageHealthWarning: translate(
    ui,
    'account.languageHealthWarning',
    {},
    'This locale still has {count} missing/untranslated UI keys.'
  ),
  languageHealthComplete: translate(ui, 'account.languageHealthComplete', {}, 'This locale is fully translated.'),
  languageHealthUnknown: translate(ui, 'account.languageHealthUnknown', {}, 'No translation progress row found for this locale.'),
  languageTitle: translate(ui, 'account.languageTitle', {}, 'Site language preference'),
  languageDescription: translate(
    ui,
    'account.languageDescription',
    {},
    'This preference is saved to your account profile and overrides browser language.'
  ),
  preferredLanguage: translate(ui, 'account.preferredLanguage', {}, 'Preferred site language'),
  savePreference: translate(ui, 'account.savePreference', {}, 'Save preference'),
  loadedPreference: translate(ui, 'account.loadedPreference', {}, 'Loaded your saved preference.'),
  chooseSupportedLanguage: translate(ui, 'account.chooseSupportedLanguage', {}, 'Please choose a supported language.'),
  savingPreference: translate(ui, 'account.savingPreference', {}, 'Saving preference...'),
  preferenceSaveFailed: translate(ui, 'account.preferenceSaveFailed', {}, 'Failed to save preference.'),
  preferenceSavedRedirect: translate(ui, 'account.preferenceSavedRedirect', {}, 'Preference saved. Redirecting...'),
  preferenceNetworkError: translate(ui, 'account.preferenceNetworkError', {}, 'Network error while saving preference.'),
  passwordTitle: translate(ui, 'account.passwordTitle', {}, 'Change password'),
  passwordDescription: translate(
    ui,
    'account.passwordDescription',
    {},
    'Update your account password. Use a strong password with at least 8 characters.'
  ),
  currentPassword: translate(ui, 'account.currentPassword', {}, 'Current password'),
  newPassword: translate(ui, 'account.newPassword', {}, 'New password'),
  passwordConfirm: translate(ui, 'account.passwordConfirm', {}, 'Confirm new password'),
  changePassword: translate(ui, 'account.changePassword', {}, 'Change password'),
  passwordRequired: translate(ui, 'account.passwordRequired', {}, 'All password fields are required.'),
  passwordLength: translate(ui, 'account.passwordLength', {}, 'New password must be at least 8 characters.'),
  passwordMismatch: translate(ui, 'account.passwordMismatch', {}, 'Password confirmation does not match.'),
  passwordSameAsCurrent: translate(ui, 'account.passwordSameAsCurrent', {}, 'New password must be different from current password.'),
  passwordSaving: translate(ui, 'account.passwordSaving', {}, 'Updating password...'),
  passwordSaveFailed: translate(ui, 'account.passwordSaveFailed', {}, 'Could not update password. Please verify your current password.'),
  passwordSaved: translate(ui, 'account.passwordSaved', {}, 'Password updated successfully.'),
  passwordSavedReauth: translate(
    ui,
    'account.passwordSavedReauth',
    {},
    'Password updated. Please login again. Redirecting...'
  ),
  passwordNetworkError: translate(ui, 'account.passwordNetworkError', {}, 'Network error while updating password.'),
};
---

<MainLayout
  title={translate(ui, 'account.title', {}, 'Account')}
  description={translate(ui, 'account.description', {}, 'Manage your account and UI language preferences.')}
  canonical={canonical}
  robots="noindex,nofollow"
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  <h1>{translate(ui, 'account.title', {}, 'Account')}</h1>
  <p class="small">{translate(ui, 'account.description', {}, 'Manage your account and UI language preferences.')}</p>

  <section class="card panel gv-stack" data-account-logged-out hidden>
    <h2>{accountCopy.loginRequiredTitle}</h2>
    <p class="small">{accountCopy.loginRequiredBody}</p>
    <a class="ui-button ui-button-primary ui-button-md" href={loginPath}>{accountCopy.loginCta}</a>
  </section>

  <section class="card panel gv-stack" data-account-profile hidden>
    <h2>{accountCopy.profileTitle}</h2>
    <p class="small">{accountCopy.profileDescription}</p>

    <dl class="account-profile-grid">
      <div>
        <dt>{accountCopy.profileUsername}</dt>
        <dd data-account-profile-username>{accountCopy.profileUnknown}</dd>
      </div>
      <div>
        <dt>{accountCopy.profileEmail}</dt>
        <dd data-account-profile-email>{accountCopy.profileUnknown}</dd>
      </div>
      <div>
        <dt>{accountCopy.profileCreatedAt}</dt>
        <dd data-account-profile-created>{accountCopy.profileUnknown}</dd>
      </div>
      <div>
        <dt>{accountCopy.profileStatus}</dt>
        <dd data-account-profile-status>{accountCopy.profileUnknown}</dd>
      </div>
    </dl>
    <p class="small account-feedback" data-account-profile-feedback aria-live="polite"></p>
  </section>

  <section class="card panel gv-stack" data-account-comments hidden>
    <div class="account-comments-head">
      <div>
        <h2>{accountCopy.commentsTitle}</h2>
        <p class="small">{accountCopy.commentsDescription}</p>
      </div>
      <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-account-comments-refresh>
        <span class="ui-button-label">{accountCopy.commentsRefresh}</span>
      </button>
    </div>

    <div class="account-comments-stats" data-account-comments-stats>
      <span>
        {accountCopy.commentsPending}: <strong data-account-comments-pending>0</strong>
      </span>
      <span>
        {accountCopy.commentsApproved}: <strong data-account-comments-approved>0</strong>
      </span>
      <span>
        {accountCopy.commentsRejected}: <strong data-account-comments-rejected>0</strong>
      </span>
      <span>
        {accountCopy.commentsSpam}: <strong data-account-comments-spam>0</strong>
      </span>
    </div>

    <ul class="account-comments-list gv-stack" data-account-comments-list></ul>
    <p class="small" data-account-comments-empty>{accountCopy.commentsNone}</p>
    <p class="small account-feedback" data-account-comments-feedback aria-live="polite"></p>
  </section>

  <section class="card panel gv-stack" id="locale-progress" data-account-locale-progress hidden>
    <div class="account-comments-head">
      <div>
        <h2>{accountCopy.localeProgressTitle}</h2>
        <p class="small">{accountCopy.localeProgressDescription}</p>
      </div>
      <label class="account-field account-inline-field account-locale-filter">
        <span>{accountCopy.localeProgressFilterLabel}</span>
        <select data-account-locale-progress-filter>
          <option value="all">{accountCopy.localeProgressFilterAll}</option>
          <option value="missing">{accountCopy.localeProgressFilterMissing}</option>
          <option value="untranslated">{accountCopy.localeProgressFilterUntranslated}</option>
        </select>
      </label>
      <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-account-locale-progress-refresh>
        <span class="ui-button-label">{accountCopy.localeProgressRefresh}</span>
      </button>
    </div>

    <div class="account-comments-stats" data-account-locale-progress-summary>
      <span>
        {accountCopy.localeProgressMissingLocales}: <strong data-account-locale-progress-missing-locales>0</strong>
      </span>
      <span>
        {accountCopy.localeProgressUntranslatedLocales}: <strong data-account-locale-progress-untranslated-locales>0</strong>
      </span>
      <span>
        {accountCopy.localeProgressDeployCount}: <strong data-account-locale-progress-deploy-count>0</strong>
      </span>
      <span>
        {accountCopy.localeProgressActiveFilter}: <strong data-account-locale-progress-active-filter>{accountCopy.localeProgressFilterAll}</strong>
      </span>
      <span>
        {accountCopy.localeProgressFilteredKeys}: <strong data-account-locale-progress-filtered-total>0</strong>
      </span>
    </div>

    <div class="account-locale-deploy-hint gv-stack" data-account-locale-deploy-hint hidden>
      <p class="account-comment-meta">
        <strong>{accountCopy.localeProgressDeployActionTitle}</strong>
      </p>
      <p class="account-comment-meta" data-account-locale-deploy-body>{accountCopy.localeProgressDeployActionBody}</p>
      <div class="account-locale-deploy-command-wrap">
        <code data-account-locale-deploy-command>{accountCopy.localeProgressDeployCommand}</code>
        <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-account-locale-deploy-copy>
          <span class="ui-button-label">{accountCopy.localeProgressDeployCopy}</span>
        </button>
      </div>
      <div class="account-locale-deploy-command-wrap">
        <code data-account-locale-release-command>{accountCopy.localeProgressDeployReleaseCommand}</code>
        <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-account-locale-release-copy>
          <span class="ui-button-label">{accountCopy.localeProgressDeployCopyRelease}</span>
        </button>
      </div>
      <div class="account-locale-deploy-command-wrap">
        <code data-account-locale-workflow-command>{accountCopy.localeProgressDeployWorkflowCommand}</code>
        <button type="button" class="ui-button ui-button-secondary ui-button-sm" data-account-locale-workflow-copy>
          <span class="ui-button-label">{accountCopy.localeProgressDeployCopyWorkflow}</span>
        </button>
      </div>
      <p class="small account-feedback" data-account-locale-deploy-feedback aria-live="polite"></p>
    </div>

    <ul class="account-comments-list gv-stack" data-account-locale-progress-list></ul>
    <p class="small" data-account-locale-progress-empty>{accountCopy.localeProgressNone}</p>
    <p class="small account-feedback" data-account-locale-progress-feedback aria-live="polite"></p>
  </section>

  <section class="card panel gv-stack" data-account-settings hidden>
    <h2>{accountCopy.languageTitle}</h2>
    <p class="small">{accountCopy.languageDescription}</p>

    <form class="gv-stack account-form" data-account-language-form data-auth-base={authBaseUrl} novalidate>
      <label class="account-field">
        <span>{accountCopy.preferredLanguage}</span>
        <select name="preferred_ui_language" data-account-language-select>
          {
            availableLanguages.map((language) => (
              <option value={language} data-default-label={language.toUpperCase()}>
                {language.toUpperCase()}
              </option>
            ))
          }
        </select>
      </label>
      <p class="small account-feedback" data-account-language-health></p>

      <button type="submit" class="ui-button ui-button-primary ui-button-md">
        <span class="ui-button-label">{accountCopy.savePreference}</span>
      </button>
      <p class="small account-feedback" data-account-feedback aria-live="polite"></p>
    </form>
  </section>

  <section class="card panel gv-stack" data-account-password hidden>
    <h2>{accountCopy.passwordTitle}</h2>
    <p class="small">{accountCopy.passwordDescription}</p>

    <form class="gv-stack account-form" data-account-password-form data-auth-base={authBaseUrl} novalidate>
      <label class="account-field">
        <span>{accountCopy.currentPassword}</span>
        <input type="password" name="currentPassword" autocomplete="current-password" minlength="8" required />
      </label>

      <label class="account-field">
        <span>{accountCopy.newPassword}</span>
        <input type="password" name="password" autocomplete="new-password" minlength="8" required />
      </label>

      <label class="account-field">
        <span>{accountCopy.passwordConfirm}</span>
        <input type="password" name="passwordConfirmation" autocomplete="new-password" minlength="8" required />
      </label>

      <button type="submit" class="ui-button ui-button-primary ui-button-md">
        <span class="ui-button-label">{accountCopy.changePassword}</span>
      </button>
      <p class="small account-feedback" data-account-password-feedback aria-live="polite"></p>
    </form>
  </section>

  <script is:inline define:vars={{ lang, loginPath, availableLanguages, accountCopy }}>
    (() => {
      const settingsPanel = document.querySelector('[data-account-settings]');
      const passwordPanel = document.querySelector('[data-account-password]');
      const loggedOutPanel = document.querySelector('[data-account-logged-out]');
      const profilePanel = document.querySelector('[data-account-profile]');
      const commentsPanel = document.querySelector('[data-account-comments]');
      const localeProgressPanel = document.querySelector('[data-account-locale-progress]');
      const profileUsername = document.querySelector('[data-account-profile-username]');
      const profileEmail = document.querySelector('[data-account-profile-email]');
      const profileCreated = document.querySelector('[data-account-profile-created]');
      const profileStatus = document.querySelector('[data-account-profile-status]');
      const profileFeedback = document.querySelector('[data-account-profile-feedback]');
      const commentsList = document.querySelector('[data-account-comments-list]');
      const commentsEmpty = document.querySelector('[data-account-comments-empty]');
      const commentsFeedback = document.querySelector('[data-account-comments-feedback]');
      const commentsRefreshButton = document.querySelector('[data-account-comments-refresh]');
      const commentsCountPending = document.querySelector('[data-account-comments-pending]');
      const commentsCountApproved = document.querySelector('[data-account-comments-approved]');
      const commentsCountRejected = document.querySelector('[data-account-comments-rejected]');
      const commentsCountSpam = document.querySelector('[data-account-comments-spam]');
      const localeProgressList = document.querySelector('[data-account-locale-progress-list]');
      const localeProgressEmpty = document.querySelector('[data-account-locale-progress-empty]');
      const localeProgressFeedback = document.querySelector('[data-account-locale-progress-feedback]');
      const localeProgressRefreshButton = document.querySelector('[data-account-locale-progress-refresh]');
      const localeProgressFilterSelect = document.querySelector('[data-account-locale-progress-filter]');
      const localeProgressMissingLocales = document.querySelector('[data-account-locale-progress-missing-locales]');
      const localeProgressUntranslatedLocales = document.querySelector('[data-account-locale-progress-untranslated-locales]');
      const localeProgressDeployCount = document.querySelector('[data-account-locale-progress-deploy-count]');
      const localeProgressActiveFilter = document.querySelector('[data-account-locale-progress-active-filter]');
      const localeProgressFilteredTotal = document.querySelector('[data-account-locale-progress-filtered-total]');
      const localeDeployHint = document.querySelector('[data-account-locale-deploy-hint]');
      const localeDeployBody = document.querySelector('[data-account-locale-deploy-body]');
      const localeDeployCommand = document.querySelector('[data-account-locale-deploy-command]');
      const localeDeployCopyButton = document.querySelector('[data-account-locale-deploy-copy]');
      const localeReleaseCommand = document.querySelector('[data-account-locale-release-command]');
      const localeReleaseCopyButton = document.querySelector('[data-account-locale-release-copy]');
      const localeWorkflowCommand = document.querySelector('[data-account-locale-workflow-command]');
      const localeWorkflowCopyButton = document.querySelector('[data-account-locale-workflow-copy]');
      const localeDeployFeedback = document.querySelector('[data-account-locale-deploy-feedback]');
      const form = document.querySelector('[data-account-language-form]');
      const feedback = document.querySelector('[data-account-feedback]');
      const select = document.querySelector('[data-account-language-select]');
      const languageHealth = document.querySelector('[data-account-language-health]');
      const passwordForm = document.querySelector('[data-account-password-form]');
      const passwordFeedback = document.querySelector('[data-account-password-feedback]');

      if (
        !(settingsPanel instanceof HTMLElement) ||
        !(passwordPanel instanceof HTMLElement) ||
        !(loggedOutPanel instanceof HTMLElement) ||
        !(profilePanel instanceof HTMLElement) ||
        !(commentsPanel instanceof HTMLElement) ||
        !(localeProgressPanel instanceof HTMLElement)
      ) {
        return;
      }
      if (
        !(form instanceof HTMLFormElement) ||
        !(feedback instanceof HTMLElement) ||
        !(select instanceof HTMLSelectElement) ||
        !(languageHealth instanceof HTMLElement)
      )
        return;
      if (!(passwordForm instanceof HTMLFormElement) || !(passwordFeedback instanceof HTMLElement)) return;
      if (
        !(profileUsername instanceof HTMLElement) ||
        !(profileEmail instanceof HTMLElement) ||
        !(profileCreated instanceof HTMLElement) ||
        !(profileStatus instanceof HTMLElement) ||
        !(commentsList instanceof HTMLElement) ||
        !(commentsEmpty instanceof HTMLElement) ||
        !(commentsFeedback instanceof HTMLElement) ||
        !(commentsRefreshButton instanceof HTMLButtonElement) ||
        !(commentsCountPending instanceof HTMLElement) ||
        !(commentsCountApproved instanceof HTMLElement) ||
        !(commentsCountRejected instanceof HTMLElement) ||
        !(commentsCountSpam instanceof HTMLElement) ||
        !(localeProgressList instanceof HTMLElement) ||
        !(localeProgressEmpty instanceof HTMLElement) ||
        !(localeProgressFeedback instanceof HTMLElement) ||
        !(localeProgressRefreshButton instanceof HTMLButtonElement) ||
        !(localeProgressFilterSelect instanceof HTMLSelectElement) ||
        !(localeProgressMissingLocales instanceof HTMLElement) ||
        !(localeProgressUntranslatedLocales instanceof HTMLElement) ||
        !(localeProgressDeployCount instanceof HTMLElement) ||
        !(localeProgressActiveFilter instanceof HTMLElement) ||
        !(localeProgressFilteredTotal instanceof HTMLElement) ||
        !(localeDeployHint instanceof HTMLElement) ||
        !(localeDeployBody instanceof HTMLElement) ||
        !(localeDeployCommand instanceof HTMLElement) ||
        !(localeDeployCopyButton instanceof HTMLButtonElement) ||
        !(localeReleaseCommand instanceof HTMLElement) ||
        !(localeReleaseCopyButton instanceof HTMLButtonElement) ||
        !(localeWorkflowCommand instanceof HTMLElement) ||
        !(localeWorkflowCopyButton instanceof HTMLButtonElement) ||
        !(localeDeployFeedback instanceof HTMLElement)
      ) {
        return;
      }

      const authBase = form.getAttribute('data-auth-base');
      if (!authBase) return;

      const normalizedLanguages = Array.isArray(availableLanguages) ? availableLanguages : [];
      const isAllowedLanguage = (value) => normalizedLanguages.includes(value);
      const normalizeLanguage = (value) => String(value || '').trim().toLowerCase();
      const normalizePreviewState = (value) => {
        const normalized = String(value || '').trim().toLowerCase();
        if (normalized === 'missing' || normalized === 'untranslated') return normalized;
        return 'all';
      };
      const queryParams = new URLSearchParams(window.location.search);
      const initialLocaleFromQuery = normalizeLanguage(queryParams.get('locale') || '');
      const initialPreviewState = normalizePreviewState(queryParams.get('state') || 'all');
      let localeProgressFocusLocale = initialLocaleFromQuery;
      let localeProgressFocusPending = Boolean(initialLocaleFromQuery);
      const getCurrentPreviewState = () => normalizePreviewState(localeProgressFilterSelect.value);
      const getPreviewCacheKey = (localeCode, state) => `${normalizeLanguage(localeCode)}:${normalizePreviewState(state)}`;
      const localeProgressByLocale = new Map();
      const localePreviewCache = new Map();
      const deployCommandText = String(accountCopy.localeProgressDeployCommand || 'bash tools/ui_locale_sync.sh');
      const releaseCommandText = String(
        accountCopy.localeProgressDeployReleaseCommand || 'bash tools/release_deploy_smoke.sh --with-moderation'
      );
      const workflowCommandText = String(
        accountCopy.localeProgressDeployWorkflowCommand ||
          'bash tools/ui_locale_sync.sh && EXPECTED_SHA7=$(git rev-parse --short=7 HEAD) bash tools/release_deploy_smoke.sh --with-moderation'
      );
      localeDeployCommand.textContent = deployCommandText;
      localeReleaseCommand.textContent = releaseCommandText;
      localeWorkflowCommand.textContent = workflowCommandText;

      const getPreviewStateLabel = (state) => {
        const normalized = normalizePreviewState(state);
        if (normalized === 'missing') return accountCopy.localeProgressFilterMissing;
        if (normalized === 'untranslated') return accountCopy.localeProgressFilterUntranslated;
        return accountCopy.localeProgressFilterAll;
      };

      const setFeedback = (message, isError = false) => {
        feedback.textContent = message;
        feedback.classList.toggle('is-error', isError);
      };

      const setProfileFeedback = (message, isError = false) => {
        if (!(profileFeedback instanceof HTMLElement)) return;
        profileFeedback.textContent = message;
        profileFeedback.classList.toggle('is-error', isError);
      };

      const setPasswordFeedback = (message, isError = false) => {
        passwordFeedback.textContent = message;
        passwordFeedback.classList.toggle('is-error', isError);
      };

      const setCommentsFeedback = (message, isError = false) => {
        commentsFeedback.textContent = message;
        commentsFeedback.classList.toggle('is-error', isError);
      };

      const setLocaleProgressFeedback = (message, isError = false) => {
        localeProgressFeedback.textContent = message;
        localeProgressFeedback.classList.toggle('is-error', isError);
      };

      const setLocaleDeployFeedback = (message, isError = false) => {
        localeDeployFeedback.textContent = message;
        localeDeployFeedback.classList.toggle('is-error', isError);
      };

      const setCommentsCounts = (meta) => {
        const counts = meta && typeof meta === 'object' ? meta.counts || {} : {};
        commentsCountPending.textContent = String(Number(counts.pending) || 0);
        commentsCountApproved.textContent = String(Number(counts.approved) || 0);
        commentsCountRejected.textContent = String(Number(counts.rejected) || 0);
        commentsCountSpam.textContent = String(Number(counts.spam) || 0);
      };

      const setLocaleProgressSummary = (summary) => {
        const source = summary && typeof summary === 'object' ? summary : {};
        localeProgressMissingLocales.textContent = String(Number(source.locales_with_missing) || 0);
        localeProgressUntranslatedLocales.textContent = String(Number(source.locales_with_untranslated) || 0);
        localeProgressDeployCount.textContent = String(Number(source.deploy_required_count) || 0);
      };

      const setLocaleDeployHint = (summary) => {
        const source = summary && typeof summary === 'object' ? summary : {};
        const deployRequiredCount = Number(source.deploy_required_count) || 0;
        localeDeployHint.hidden = deployRequiredCount <= 0;
        if (deployRequiredCount <= 0) {
          setLocaleDeployFeedback('');
          return;
        }

        localeDeployBody.textContent = String(accountCopy.localeProgressDeployActionBody || '').replace(
          '{count}',
          String(deployRequiredCount)
        );
      };

      const setLocaleFilterSummary = () => {
        const state = getCurrentPreviewState();
        localeProgressActiveFilter.textContent = getPreviewStateLabel(state);
        let total = 0;
        for (const row of localeProgressByLocale.values()) {
          const missing = Number(row?.missing_keys || 0);
          const untranslated = Number(row?.untranslated_keys || 0);
          if (state === 'missing') {
            total += missing;
            continue;
          }
          if (state === 'untranslated') {
            total += untranslated;
            continue;
          }
          total += missing + untranslated;
        }
        localeProgressFilteredTotal.textContent = String(total);
      };

      const getLocaleWorkCount = (localeCode) => {
        const normalized = normalizeLanguage(localeCode);
        if (!normalized || !localeProgressByLocale.has(normalized)) return null;
        const row = localeProgressByLocale.get(normalized);
        const missing = Number(row?.missing_keys || 0);
        const untranslated = Number(row?.untranslated_keys || 0);
        return missing + untranslated;
      };

      const updateSelectOptionLabels = () => {
        const options = Array.from(select.options);
        for (const option of options) {
          const localeCode = normalizeLanguage(option.value);
          const defaultLabel = option.dataset.defaultLabel || option.value.toUpperCase();
          const workCount = getLocaleWorkCount(localeCode);
          if (workCount === null) {
            option.textContent = defaultLabel;
            continue;
          }
          option.textContent = workCount > 0 ? `${defaultLabel} · ${workCount}` : defaultLabel;
        }
      };

      const updateLanguageHealth = () => {
        const selectedLocale = normalizeLanguage(select.value);
        if (!selectedLocale || !isAllowedLanguage(selectedLocale)) {
          languageHealth.textContent = '';
          languageHealth.classList.remove('is-error');
          return;
        }

        const workCount = getLocaleWorkCount(selectedLocale);
        if (workCount === null) {
          languageHealth.textContent = accountCopy.languageHealthUnknown;
          languageHealth.classList.add('is-error');
          return;
        }

        if (workCount > 0) {
          languageHealth.textContent = String(accountCopy.languageHealthWarning || '').replace('{count}', String(workCount));
          languageHealth.classList.add('is-error');
          return;
        }

        languageHealth.textContent = accountCopy.languageHealthComplete;
        languageHealth.classList.remove('is-error');
      };

      const escapeHtml = (value) =>
        String(value || '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');

      const formatPreviewValue = (value) => {
        if (value === null || value === undefined) return '∅';
        const text = String(value);
        return text.length > 120 ? `${text.slice(0, 117)}...` : text;
      };

      const csvEscape = (value) => `"${String(value ?? '').replaceAll('"', '""')}"`;

      const rowsToCsv = (rows) => {
        const list = Array.isArray(rows) ? rows : [];
        const lines = ['key,state,reference_value,locale_value'];
        for (const row of list) {
          lines.push(
            [
              csvEscape(row?.key || ''),
              csvEscape(row?.state || ''),
              csvEscape(row?.reference_value ?? ''),
              csvEscape(row?.locale_value ?? ''),
            ].join(',')
          );
        }
        return `${lines.join('\n')}\n`;
      };

      const findLocalePreviewNode = (localeCode) => {
        const normalized = normalizeLanguage(localeCode);
        if (!normalized) return null;
        const nodes = localeProgressList.querySelectorAll('[data-account-locale-preview]');
        for (const node of nodes) {
          if (!(node instanceof HTMLElement)) continue;
          const current = normalizeLanguage(node.getAttribute('data-account-locale-preview'));
          if (current === normalized) {
            return node;
          }
        }
        return null;
      };

      const findLocaleItemNode = (localeCode) => {
        const normalized = normalizeLanguage(localeCode);
        if (!normalized) return null;
        const nodes = localeProgressList.querySelectorAll('[data-account-locale-item]');
        for (const node of nodes) {
          if (!(node instanceof HTMLElement)) continue;
          const current = normalizeLanguage(node.getAttribute('data-account-locale-item'));
          if (current === normalized) {
            return node;
          }
        }
        return null;
      };

      const fetchLocalePreviewRows = async (localeCode, state = 'all', limit = 12) => {
        const normalized = normalizeLanguage(localeCode);
        const normalizedState = normalizePreviewState(state);
        if (!normalized) return [];
        const response = await fetch(
          `${authBase}/api/ui-locales/meta/${encodeURIComponent(normalized)}/reference-preview?reference_locale=en&state=${encodeURIComponent(normalizedState)}&limit=${limit}`,
          {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          }
        );
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(String(payload?.error?.message || accountCopy.localeProgressLoadFailed));
        }
        const rows = Array.isArray(payload?.data?.rows) ? payload.data.rows : [];
        if (normalizedState === 'all') {
          return rows.filter((item) => item?.state === 'missing' || item?.state === 'untranslated');
        }
        return rows.filter((item) => item?.state === normalizedState);
      };

      const clearAuthSession = () => {
        try {
          localStorage.removeItem('geovito_auth_session');
          sessionStorage.removeItem('geovito_auth_session');
        } catch {
          // no-op
        }
      };

      const formatDate = (value) => {
        if (!value) return accountCopy.profileUnknown;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return accountCopy.profileUnknown;
        try {
          return new Intl.DateTimeFormat(document.documentElement.lang || 'en', {
            dateStyle: 'medium',
            timeStyle: 'short',
          }).format(date);
        } catch {
          return date.toISOString();
        }
      };

      const renderProfile = (payload) => {
        const username = String(payload?.username || '').trim();
        const email = String(payload?.email || '').trim();
        const createdAt = payload?.createdAt || payload?.loginAt;
        const blocked = payload?.blocked === true;
        const confirmed = payload?.confirmed !== false;

        profileUsername.textContent = username || accountCopy.profileUnknown;
        profileEmail.textContent = email || accountCopy.profileUnknown;
        profileCreated.textContent = formatDate(createdAt);

        if (blocked) {
          profileStatus.textContent = accountCopy.profileStatusBlocked;
        } else if (!confirmed) {
          profileStatus.textContent = accountCopy.profileStatusPending;
        } else {
          profileStatus.textContent = accountCopy.profileStatusActive;
        }
      };

      const readSession = () => {
        try {
          const readRaw = () => {
            const fromLocal = localStorage.getItem('geovito_auth_session');
            if (fromLocal) return fromLocal;
            const fromSession = sessionStorage.getItem('geovito_auth_session');
            if (fromSession) {
              localStorage.setItem('geovito_auth_session', fromSession);
            }
            return fromSession;
          };

          const raw = readRaw();
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return null;
          if (!parsed.jwt || typeof parsed.jwt !== 'string') return null;
          return parsed;
        } catch {
          return null;
        }
      };

      const session = readSession();
      if (!session) {
        settingsPanel.hidden = true;
        passwordPanel.hidden = true;
        profilePanel.hidden = true;
        commentsPanel.hidden = true;
        localeProgressPanel.hidden = true;
        loggedOutPanel.hidden = false;
        return;
      }

      settingsPanel.hidden = false;
      passwordPanel.hidden = false;
      profilePanel.hidden = false;
      commentsPanel.hidden = false;
      localeProgressPanel.hidden = false;
      loggedOutPanel.hidden = true;
      renderProfile(session);

      const applyPreferredLanguage = (language) => {
        const normalized = normalizeLanguage(language);
        if (!isAllowedLanguage(normalized)) return false;
        select.value = normalized;
        updateLanguageHealth();
        try {
          localStorage.setItem('geovito.ui_lang', normalized);
        } catch {
          // no-op
        }
        return true;
      };

      const loadPreference = async () => {
        const localPreferred = normalizeLanguage(localStorage.getItem('geovito.ui_lang') || '');
        if (isAllowedLanguage(localPreferred)) {
          select.value = localPreferred;
          updateLanguageHealth();
        }

        try {
          const response = await fetch(`${authBase}/api/user-preferences/me`, {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          });
          if (!response.ok) return;
          const payload = await response.json().catch(() => null);
          const language = normalizeLanguage(payload?.data?.preferred_ui_language);
          if (applyPreferredLanguage(language)) {
            setFeedback(accountCopy.loadedPreference);
          }
        } catch {
          // no-op
        }
      };

      const loadProfile = async () => {
        try {
          const response = await fetch(`${authBase}/api/users/me`, {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          });
          if (!response.ok) {
            setProfileFeedback(accountCopy.profileSyncFallback, true);
            return;
          }
          const payload = await response.json().catch(() => null);
          if (!payload || typeof payload !== 'object') {
            setProfileFeedback(accountCopy.profileSyncFallback, true);
            return;
          }
          renderProfile(payload);
          setProfileFeedback('');
        } catch {
          setProfileFeedback(accountCopy.profileSyncFallback, true);
        }
      };

      const renderComments = (items) => {
        commentsList.innerHTML = '';
        const list = Array.isArray(items) ? items : [];
        commentsEmpty.hidden = list.length > 0;
        if (list.length === 0) return;

        const fragment = document.createDocumentFragment();
        for (const item of list) {
          const li = document.createElement('li');
          li.className = 'account-comment-item';
          const postRef = escapeHtml(item?.blog_post_ref || '-');
          const status = escapeHtml(item?.status || '-');
          const note = escapeHtml(item?.moderation_notes || '');
          const body = escapeHtml(item?.body || '');
          const created = formatDate(item?.created_at);

          li.innerHTML = `
            <p class="account-comment-meta">
              <strong>${escapeHtml(accountCopy.commentsPostRef)}:</strong> ${postRef}
              · <strong>${escapeHtml(accountCopy.commentsStatus)}:</strong> ${status}
              · <span>${escapeHtml(created)}</span>
            </p>
            <p class="account-comment-body">${body}</p>
            ${note ? `<p class="account-comment-note"><strong>${escapeHtml(accountCopy.commentsModerationNote)}:</strong> ${note}</p>` : ''}
          `;
          fragment.appendChild(li);
        }
        commentsList.appendChild(fragment);
      };

      const loadComments = async () => {
        setCommentsFeedback(accountCopy.commentsLoading);
        try {
          const response = await fetch(`${authBase}/api/blog-comments/me/list?limit=30`, {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload?.error?.message || accountCopy.commentsLoadFailed;
            renderComments([]);
            setCommentsCounts(null);
            setCommentsFeedback(message, true);
            return;
          }

          const items = Array.isArray(payload?.data) ? payload.data : [];
          renderComments(items);
          setCommentsCounts(payload?.meta);
          setCommentsFeedback('');
        } catch {
          renderComments([]);
          setCommentsCounts(null);
          setCommentsFeedback(accountCopy.commentsLoadFailed, true);
        }
      };

      const renderLocaleProgress = (rows, referenceLocale) => {
        localeProgressList.innerHTML = '';
        const list = Array.isArray(rows) ? rows : [];
        localeProgressEmpty.hidden = list.length > 0;
        if (list.length === 0) return;

        const fragment = document.createDocumentFragment();
        const normalizedReference = normalizeLanguage(referenceLocale || 'en');
        const sorted = [...list].sort((left, right) => {
          const leftScore = Number(left?.missing_keys || 0) + Number(left?.untranslated_keys || 0);
          const rightScore = Number(right?.missing_keys || 0) + Number(right?.untranslated_keys || 0);
          if (rightScore !== leftScore) return rightScore - leftScore;
          return String(left?.ui_locale || '').localeCompare(String(right?.ui_locale || ''));
        });

        for (const item of sorted) {
          const locale = normalizeLanguage(item?.ui_locale || '-');
          const missing = Number(item?.missing_keys || 0);
          const untranslated = Number(item?.untranslated_keys || 0);
          const coverage = Number(item?.coverage_percent || 0);
          const deployRequired = item?.deploy_required === true;
          const status = String(item?.status || 'draft');

          const li = document.createElement('li');
          li.className = 'account-comment-item';
          li.setAttribute('data-account-locale-item', locale);
          if (missing > 0 || untranslated > 0) {
            li.classList.add('account-locale-item-needs-work');
          }

          li.innerHTML = `
            <p class="account-comment-meta">
              <strong>${escapeHtml(locale.toUpperCase() || '-')}</strong>
              · <strong>${escapeHtml(accountCopy.commentsStatus)}:</strong> ${escapeHtml(status)}
              ${locale === normalizedReference ? `· <strong>${escapeHtml(accountCopy.localeProgressReference)}</strong>` : ''}
            </p>
            <p class="account-comment-meta">
              <strong>${escapeHtml(accountCopy.localeProgressMissing)}:</strong> ${missing}
              · <strong>${escapeHtml(accountCopy.localeProgressUntranslated)}:</strong> ${untranslated}
              · <strong>${escapeHtml(accountCopy.localeProgressCoverage)}:</strong> ${Number.isFinite(coverage) ? coverage.toFixed(1) : '0.0'}%
            </p>
            ${deployRequired ? `<p class="account-comment-note"><strong>${escapeHtml(accountCopy.localeProgressDeployRequired)}</strong></p>` : ''}
            ${
              missing > 0 || untranslated > 0
                ? `
                  <div class="account-locale-actions">
                    <button
                      type="button"
                      class="ui-button ui-button-secondary ui-button-sm account-locale-preview-toggle"
                      data-account-locale-preview-toggle
                      data-locale-code="${escapeHtml(locale)}"
                      aria-expanded="false"
                    >
                      <span class="ui-button-label">${escapeHtml(accountCopy.localeProgressShowDetails)}</span>
                    </button>
                    <button
                      type="button"
                      class="ui-button ui-button-secondary ui-button-sm account-locale-preview-export"
                      data-account-locale-preview-export
                      data-locale-code="${escapeHtml(locale)}"
                    >
                      <span class="ui-button-label">${escapeHtml(accountCopy.localeProgressExportCsv)}</span>
                    </button>
                  </div>
                  <div class="account-locale-preview" data-account-locale-preview="${escapeHtml(locale)}" hidden></div>
                `
                : ''
            }
          `;
          fragment.appendChild(li);
        }

        localeProgressList.appendChild(fragment);
      };

      const applyLocaleProgressFocus = () => {
        const targetLocale = normalizeLanguage(localeProgressFocusLocale);
        if (!targetLocale) {
          localeProgressFocusPending = false;
          return;
        }

        const nodes = localeProgressList.querySelectorAll('[data-account-locale-item]');
        for (const node of nodes) {
          if (node instanceof HTMLElement) {
            node.classList.remove('account-locale-item-focus');
          }
        }

        const targetNode = findLocaleItemNode(targetLocale);
        if (!(targetNode instanceof HTMLElement)) {
          localeProgressFocusPending = false;
          return;
        }

        targetNode.classList.add('account-locale-item-focus');
        targetNode.scrollIntoView({ block: 'nearest', behavior: 'smooth' });

        const toggleButton = targetNode.querySelector('[data-account-locale-preview-toggle]');
        const previewNode = findLocalePreviewNode(targetLocale);
        if (
          localeProgressFocusPending &&
          toggleButton instanceof HTMLButtonElement &&
          previewNode instanceof HTMLElement &&
          previewNode.hidden
        ) {
          loadLocalePreview(targetLocale, previewNode, toggleButton);
        }

        localeProgressFocusPending = false;
      };

      const renderLocalePreview = (previewNode, rows) => {
        if (!(previewNode instanceof HTMLElement)) return;
        const list = Array.isArray(rows) ? rows.slice(0, 8) : [];
        if (list.length === 0) {
          previewNode.innerHTML = `<p class="account-comment-meta">${escapeHtml(accountCopy.localeProgressDetailsEmpty)}</p>`;
          return;
        }

        const items = list
          .map((row) => {
            const key = escapeHtml(row?.key || '-');
            const state = escapeHtml(row?.state || '-');
            const reference = escapeHtml(formatPreviewValue(row?.reference_value));
            const localeValue = escapeHtml(formatPreviewValue(row?.locale_value));
            return `
              <li class="account-locale-preview-item">
                <p class="account-comment-meta">
                  <strong>${escapeHtml(accountCopy.localeProgressDetailsKey)}:</strong> ${key}
                  · <strong>${escapeHtml(accountCopy.localeProgressDetailsState)}:</strong> ${state}
                </p>
                <p class="account-comment-meta"><strong>${escapeHtml(accountCopy.localeProgressDetailsRef)}:</strong> ${reference}</p>
                <p class="account-comment-meta"><strong>${escapeHtml(accountCopy.localeProgressDetailsLocale)}:</strong> ${localeValue}</p>
              </li>
            `;
          })
          .join('');

        previewNode.innerHTML = `<ul class="account-locale-preview-list">${items}</ul>`;
      };

      const loadLocalePreview = async (localeCode, previewNode, toggleButton) => {
        const normalized = normalizeLanguage(localeCode);
        const selectedState = getCurrentPreviewState();
        const cacheKey = getPreviewCacheKey(normalized, selectedState);
        if (!normalized || !(previewNode instanceof HTMLElement) || !(toggleButton instanceof HTMLButtonElement)) return;

        if (localePreviewCache.has(cacheKey)) {
          renderLocalePreview(previewNode, localePreviewCache.get(cacheKey));
          previewNode.hidden = false;
          toggleButton.setAttribute('aria-expanded', 'true');
          toggleButton.querySelector('.ui-button-label')?.replaceChildren(accountCopy.localeProgressHideDetails);
          return;
        }

        previewNode.hidden = false;
        previewNode.innerHTML = `<p class="account-comment-meta">${escapeHtml(accountCopy.localeProgressLoadingDetails)}</p>`;
        toggleButton.disabled = true;
        toggleButton.setAttribute('aria-expanded', 'true');

        try {
          const rows = await fetchLocalePreviewRows(normalized, selectedState, 12);
          localePreviewCache.set(cacheKey, rows);
          renderLocalePreview(previewNode, rows);
          toggleButton.querySelector('.ui-button-label')?.replaceChildren(accountCopy.localeProgressHideDetails);
        } catch {
          previewNode.innerHTML = `<p class="account-comment-meta is-error">${escapeHtml(accountCopy.localeProgressLoadFailed)}</p>`;
          toggleButton.querySelector('.ui-button-label')?.replaceChildren(accountCopy.localeProgressShowDetails);
        } finally {
          toggleButton.disabled = false;
        }
      };

      const exportLocalePreviewCsv = async (localeCode, exportButton) => {
        const normalized = normalizeLanguage(localeCode);
        const selectedState = getCurrentPreviewState();
        const cacheKey = getPreviewCacheKey(normalized, selectedState);
        if (!normalized || !(exportButton instanceof HTMLButtonElement)) return;

        exportButton.disabled = true;
        setLocaleProgressFeedback(accountCopy.localeProgressLoadingDetails);
        try {
          const rows = await fetchLocalePreviewRows(normalized, selectedState, 300);
          if (rows.length === 0) {
            setLocaleProgressFeedback(accountCopy.localeProgressExportEmpty);
            return;
          }

          const csv = rowsToCsv(rows);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
          const objectUrl = URL.createObjectURL(blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = objectUrl;
          downloadLink.download = `ui-locale-${normalized}-${selectedState}.csv`;
          downloadLink.rel = 'noopener';
          document.body.appendChild(downloadLink);
          downloadLink.click();
          downloadLink.remove();
          window.setTimeout(() => URL.revokeObjectURL(objectUrl), 0);

          localePreviewCache.set(cacheKey, rows);
          setLocaleProgressFeedback(
            String(accountCopy.localeProgressExportDone || '').replace('{locale}', normalized.toUpperCase())
          );
        } catch (error) {
          const message = error instanceof Error && error.message ? error.message : accountCopy.localeProgressExportFailed;
          setLocaleProgressFeedback(message, true);
        } finally {
          exportButton.disabled = false;
        }
      };

      const loadLocaleProgress = async () => {
        setLocaleProgressFeedback(accountCopy.localeProgressLoading);
        try {
          const response = await fetch(`${authBase}/api/ui-locales/meta/progress?reference_locale=en`, {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload?.error?.message || accountCopy.localeProgressLoadFailed;
            localeProgressByLocale.clear();
            localePreviewCache.clear();
            renderLocaleProgress([], 'en');
            setLocaleProgressSummary(null);
            setLocaleDeployHint(null);
            setLocaleFilterSummary();
            updateSelectOptionLabels();
            updateLanguageHealth();
            setLocaleProgressFeedback(message, true);
            return;
          }

          const data = payload?.data && typeof payload.data === 'object' ? payload.data : {};
          const rows = Array.isArray(data.locales) ? data.locales : [];
          const summary = data.summary && typeof data.summary === 'object' ? data.summary : {};
          const referenceLocale = normalizeLanguage(summary.reference_locale || 'en');

          localeProgressByLocale.clear();
          localePreviewCache.clear();
          for (const row of rows) {
            const localeCode = normalizeLanguage(row?.ui_locale);
            if (!localeCode) continue;
            localeProgressByLocale.set(localeCode, row);
          }

          renderLocaleProgress(rows, referenceLocale);
          setLocaleProgressSummary(summary);
          setLocaleDeployHint(summary);
          setLocaleFilterSummary();
          updateSelectOptionLabels();
          updateLanguageHealth();
          applyLocaleProgressFocus();
          setLocaleProgressFeedback('');
        } catch {
          localeProgressByLocale.clear();
          localePreviewCache.clear();
          renderLocaleProgress([], 'en');
          setLocaleProgressSummary(null);
          setLocaleDeployHint(null);
          setLocaleFilterSummary();
          updateSelectOptionLabels();
          updateLanguageHealth();
          setLocaleProgressFeedback(accountCopy.localeProgressLoadFailed, true);
        }
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const selected = normalizeLanguage(select.value);
        if (!isAllowedLanguage(selected)) {
          setFeedback(accountCopy.chooseSupportedLanguage, true);
          return;
        }

        setFeedback(accountCopy.savingPreference);
        try {
          const response = await fetch(`${authBase}/api/user-preferences/me`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
            body: JSON.stringify({
              data: {
                preferred_ui_language: selected,
              },
            }),
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload?.error?.message || accountCopy.preferenceSaveFailed;
            setFeedback(message, true);
            return;
          }

          applyPreferredLanguage(selected);
          setFeedback(accountCopy.preferenceSavedRedirect);
          window.setTimeout(() => {
            window.location.assign(`/${selected}/`);
          }, 400);
        } catch {
          setFeedback(accountCopy.preferenceNetworkError, true);
        }
      });

      select.addEventListener('change', () => {
        updateLanguageHealth();
      });

      passwordForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(passwordForm);
        const currentPassword = String(formData.get('currentPassword') || '');
        const password = String(formData.get('password') || '');
        const passwordConfirmation = String(formData.get('passwordConfirmation') || '');

        if (!currentPassword || !password || !passwordConfirmation) {
          setPasswordFeedback(accountCopy.passwordRequired, true);
          return;
        }

        if (password.length < 8) {
          setPasswordFeedback(accountCopy.passwordLength, true);
          return;
        }

        if (password !== passwordConfirmation) {
          setPasswordFeedback(accountCopy.passwordMismatch, true);
          return;
        }

        if (password === currentPassword) {
          setPasswordFeedback(accountCopy.passwordSameAsCurrent, true);
          return;
        }

        setPasswordFeedback(accountCopy.passwordSaving);
        try {
          const response = await fetch(`${authBase}/api/auth/change-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
            body: JSON.stringify({
              currentPassword,
              password,
              passwordConfirmation,
            }),
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload?.error?.message || payload?.message || accountCopy.passwordSaveFailed;
            setPasswordFeedback(message, true);
            return;
          }

          setPasswordFeedback(accountCopy.passwordSavedReauth);
          passwordForm.reset();
          clearAuthSession();
          window.setTimeout(() => {
            window.location.assign(loginPath);
          }, 1100);
        } catch {
          setPasswordFeedback(accountCopy.passwordNetworkError, true);
        }
      });

      commentsRefreshButton.addEventListener('click', () => {
        loadComments();
      });

      localeProgressRefreshButton.addEventListener('click', () => {
        loadLocaleProgress();
      });

      localeProgressList.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;

        const exportButton = target.closest('[data-account-locale-preview-export]');
        if (exportButton instanceof HTMLButtonElement) {
          const localeCode = normalizeLanguage(exportButton.getAttribute('data-locale-code') || '');
          exportLocalePreviewCsv(localeCode, exportButton);
          return;
        }

        const toggleButton = target.closest('[data-account-locale-preview-toggle]');
        if (!(toggleButton instanceof HTMLButtonElement)) return;

        const localeCode = normalizeLanguage(toggleButton.getAttribute('data-locale-code') || '');
        const previewNode = findLocalePreviewNode(localeCode);
        if (!(previewNode instanceof HTMLElement)) return;

        if (!previewNode.hidden) {
          previewNode.hidden = true;
          toggleButton.setAttribute('aria-expanded', 'false');
          toggleButton.querySelector('.ui-button-label')?.replaceChildren(accountCopy.localeProgressShowDetails);
          return;
        }

        loadLocalePreview(localeCode, previewNode, toggleButton);
      });

      localeProgressFilterSelect.addEventListener('change', () => {
        localePreviewCache.clear();
        localeProgressFocusLocale = '';
        localeProgressFocusPending = false;
        setLocaleFilterSummary();
        const previewNodes = localeProgressList.querySelectorAll('[data-account-locale-preview]');
        for (const node of previewNodes) {
          if (node instanceof HTMLElement) {
            node.hidden = true;
            node.innerHTML = '';
          }
        }
        const toggleButtons = localeProgressList.querySelectorAll('[data-account-locale-preview-toggle]');
        for (const button of toggleButtons) {
          if (button instanceof HTMLButtonElement) {
            button.setAttribute('aria-expanded', 'false');
            button.querySelector('.ui-button-label')?.replaceChildren(accountCopy.localeProgressShowDetails);
          }
        }
      });

      localeDeployCopyButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(deployCommandText);
          setLocaleDeployFeedback(accountCopy.localeProgressDeployCopyDone);
        } catch {
          setLocaleDeployFeedback(accountCopy.localeProgressDeployCopyFailed, true);
        }
      });

      localeReleaseCopyButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(releaseCommandText);
          setLocaleDeployFeedback(accountCopy.localeProgressDeployCopyReleaseDone);
        } catch {
          setLocaleDeployFeedback(accountCopy.localeProgressDeployCopyFailed, true);
        }
      });

      localeWorkflowCopyButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(workflowCommandText);
          setLocaleDeployFeedback(accountCopy.localeProgressDeployCopyWorkflowDone);
        } catch {
          setLocaleDeployFeedback(accountCopy.localeProgressDeployCopyFailed, true);
        }
      });

      if (initialPreviewState === 'missing' || initialPreviewState === 'untranslated') {
        localeProgressFilterSelect.value = initialPreviewState;
      } else {
        localeProgressFilterSelect.value = 'all';
      }
      updateSelectOptionLabels();
      updateLanguageHealth();
      loadPreference();
      loadProfile();
      loadComments();
      loadLocaleProgress();
    })();
  </script>
</MainLayout>

<style>
  .account-form {
    gap: 0.75rem;
    max-width: 520px;
  }

  .account-field {
    display: grid;
    gap: 0.4rem;
  }

  .account-field select {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 0.85rem;
    background: var(--surface);
    color: var(--text);
  }

  .account-field input {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 0.85rem;
    background: var(--surface);
    color: var(--text);
  }

  .account-field select:focus-visible,
  .account-field input:focus-visible {
    outline: 2px solid var(--brand);
    outline-offset: 1px;
  }

  .account-feedback {
    margin: 0;
    min-height: 1.25rem;
  }

  .account-profile-grid {
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
  }

  .account-profile-grid div {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.65rem 0.75rem;
    background: var(--surface);
  }

  .account-profile-grid dt {
    margin: 0;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .account-profile-grid dd {
    margin: 0.22rem 0 0;
    font-weight: 600;
    overflow-wrap: anywhere;
  }

  .account-comments-head {
    display: flex;
    gap: 0.8rem;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .account-inline-field {
    max-width: 220px;
    min-width: 180px;
  }

  .account-locale-filter {
    margin: 0;
  }

  .account-comments-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
  }

  .account-comments-stats span {
    display: inline-flex;
    gap: 0.35rem;
    align-items: center;
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.2rem 0.62rem;
    background: var(--surface);
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .account-comments-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .account-comment-item {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.65rem 0.78rem;
    background: var(--surface);
  }

  .account-comment-meta {
    margin: 0 0 0.35rem;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .account-comment-body {
    margin: 0;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
  }

  .account-comment-note {
    margin: 0.48rem 0 0;
    font-size: 0.82rem;
    color: var(--text-muted);
  }

  .account-locale-item-needs-work {
    border-color: color-mix(in srgb, var(--warning) 58%, var(--border));
  }

  .account-locale-item-focus {
    border-color: color-mix(in srgb, var(--brand) 62%, var(--border));
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--brand) 35%, transparent);
  }

  .account-locale-actions {
    margin-top: 0.45rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }

  .account-locale-deploy-hint {
    border: 1px dashed color-mix(in srgb, var(--brand) 42%, var(--border));
    border-radius: 10px;
    padding: 0.6rem 0.7rem;
    background: color-mix(in srgb, var(--surface) 90%, var(--surface2));
  }

  .account-locale-deploy-command-wrap {
    display: flex;
    gap: 0.45rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .account-locale-deploy-command-wrap code {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.35rem 0.5rem;
    background: var(--surface);
    font-size: 0.78rem;
    overflow-wrap: anywhere;
  }

  .account-locale-preview-toggle,
  .account-locale-preview-export {
    margin-top: 0;
  }

  .account-locale-preview {
    margin-top: 0.5rem;
    padding: 0.6rem;
    border: 1px dashed var(--border);
    border-radius: 10px;
    background: color-mix(in srgb, var(--surface) 92%, var(--surface2));
  }

  .account-locale-preview-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 0.55rem;
  }

  .account-locale-preview-item {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem 0.6rem;
    background: var(--surface);
  }

  .account-comment-meta.is-error {
    color: var(--danger);
  }

  .account-feedback.is-error {
    color: var(--danger);
  }
</style>
