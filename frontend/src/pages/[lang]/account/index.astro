---
import MainLayout from '../../../layouts/MainLayout.astro';
import { isSupportedLanguage, pathForLanguage, SUPPORTED_LANGUAGES } from '../../../lib/languages';
import { absoluteUrl, buildLanguageLinks, languagePathMap, toAlternates } from '../../../lib/pageHelpers';
import { resolveStrapiBaseUrl } from '../../../lib/strapiConfig';
import { getUiMessages, translate } from '../../../lib/uiLanguage';

export async function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((language) => ({
    params: { lang: language },
  }));
}

const lang = Astro.params.lang || '';
if (!isSupportedLanguage(lang)) {
  throw new Error(`Unsupported language: ${lang}`);
}

const ui = getUiMessages(lang);
const languageLinks = buildLanguageLinks(languagePathMap((language) => pathForLanguage(language, 'account')));
const alternates = toAlternates(languageLinks);
const canonical = absoluteUrl(pathForLanguage('en', 'account'));
const loginPath = pathForLanguage(lang, 'login');
const authBaseUrl = resolveStrapiBaseUrl({
  STRAPI_URL: import.meta.env.STRAPI_URL as string | undefined,
  PUBLIC_STRAPI_URL: import.meta.env.PUBLIC_STRAPI_URL as string | undefined,
  CF_PAGES: process.env.CF_PAGES,
  NODE_ENV: process.env.NODE_ENV,
  ALLOW_LOCALHOST_STRAPI:
    process.env.ALLOW_LOCALHOST_STRAPI || (import.meta.env.ALLOW_LOCALHOST_STRAPI as string | undefined),
});
const availableLanguages = SUPPORTED_LANGUAGES;
const accountCopy = {
  loginRequiredTitle: translate(ui, 'account.loginRequiredTitle', {}, 'Login required'),
  loginRequiredBody: translate(ui, 'account.loginRequiredBody', {}, 'You need to login before managing account preferences.'),
  loginCta: translate(ui, 'account.loginCta', {}, 'Go to login'),
  profileTitle: translate(ui, 'account.profileTitle', {}, 'Profile overview'),
  profileDescription: translate(ui, 'account.profileDescription', {}, 'Basic account identity pulled from your authenticated session.'),
  profileUsername: translate(ui, 'account.profileUsername', {}, 'Username'),
  profileEmail: translate(ui, 'account.profileEmail', {}, 'Email'),
  profileCreatedAt: translate(ui, 'account.profileCreatedAt', {}, 'Member since'),
  profileStatus: translate(ui, 'account.profileStatus', {}, 'Status'),
  profileStatusActive: translate(ui, 'account.profileStatusActive', {}, 'Active'),
  profileStatusPending: translate(ui, 'account.profileStatusPending', {}, 'Pending confirmation'),
  profileStatusBlocked: translate(ui, 'account.profileStatusBlocked', {}, 'Blocked'),
  profileUnknown: translate(ui, 'account.profileUnknown', {}, 'Unknown'),
  profileSyncFallback: translate(
    ui,
    'account.profileSyncFallback',
    {},
    'Could not refresh profile from API. Showing local session snapshot.'
  ),
  languageTitle: translate(ui, 'account.languageTitle', {}, 'Site language preference'),
  languageDescription: translate(
    ui,
    'account.languageDescription',
    {},
    'This preference is saved to your account profile and overrides browser language.'
  ),
  preferredLanguage: translate(ui, 'account.preferredLanguage', {}, 'Preferred site language'),
  savePreference: translate(ui, 'account.savePreference', {}, 'Save preference'),
  loadedPreference: translate(ui, 'account.loadedPreference', {}, 'Loaded your saved preference.'),
  chooseSupportedLanguage: translate(ui, 'account.chooseSupportedLanguage', {}, 'Please choose a supported language.'),
  savingPreference: translate(ui, 'account.savingPreference', {}, 'Saving preference...'),
  preferenceSaveFailed: translate(ui, 'account.preferenceSaveFailed', {}, 'Failed to save preference.'),
  preferenceSavedRedirect: translate(ui, 'account.preferenceSavedRedirect', {}, 'Preference saved. Redirecting...'),
  preferenceNetworkError: translate(ui, 'account.preferenceNetworkError', {}, 'Network error while saving preference.'),
  passwordTitle: translate(ui, 'account.passwordTitle', {}, 'Change password'),
  passwordDescription: translate(
    ui,
    'account.passwordDescription',
    {},
    'Update your account password. Use a strong password with at least 8 characters.'
  ),
  currentPassword: translate(ui, 'account.currentPassword', {}, 'Current password'),
  newPassword: translate(ui, 'account.newPassword', {}, 'New password'),
  passwordConfirm: translate(ui, 'account.passwordConfirm', {}, 'Confirm new password'),
  changePassword: translate(ui, 'account.changePassword', {}, 'Change password'),
  passwordRequired: translate(ui, 'account.passwordRequired', {}, 'All password fields are required.'),
  passwordLength: translate(ui, 'account.passwordLength', {}, 'New password must be at least 8 characters.'),
  passwordMismatch: translate(ui, 'account.passwordMismatch', {}, 'Password confirmation does not match.'),
  passwordSameAsCurrent: translate(ui, 'account.passwordSameAsCurrent', {}, 'New password must be different from current password.'),
  passwordSaving: translate(ui, 'account.passwordSaving', {}, 'Updating password...'),
  passwordSaveFailed: translate(ui, 'account.passwordSaveFailed', {}, 'Could not update password. Please verify your current password.'),
  passwordSaved: translate(ui, 'account.passwordSaved', {}, 'Password updated successfully.'),
  passwordSavedReauth: translate(
    ui,
    'account.passwordSavedReauth',
    {},
    'Password updated. Please login again. Redirecting...'
  ),
  passwordNetworkError: translate(ui, 'account.passwordNetworkError', {}, 'Network error while updating password.'),
};
---

<MainLayout
  title={translate(ui, 'account.title', {}, 'Account')}
  description={translate(ui, 'account.description', {}, 'Manage your account and UI language preferences.')}
  canonical={canonical}
  robots="noindex,nofollow"
  currentLanguage={lang}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  <h1>{translate(ui, 'account.title', {}, 'Account')}</h1>
  <p class="small">{translate(ui, 'account.description', {}, 'Manage your account and UI language preferences.')}</p>

  <section class="card panel gv-stack" data-account-logged-out hidden>
    <h2>{accountCopy.loginRequiredTitle}</h2>
    <p class="small">{accountCopy.loginRequiredBody}</p>
    <a class="ui-button ui-button-primary ui-button-md" href={loginPath}>{accountCopy.loginCta}</a>
  </section>

  <section class="card panel gv-stack" data-account-profile hidden>
    <h2>{accountCopy.profileTitle}</h2>
    <p class="small">{accountCopy.profileDescription}</p>

    <dl class="account-profile-grid">
      <div>
        <dt>{accountCopy.profileUsername}</dt>
        <dd data-account-profile-username>{accountCopy.profileUnknown}</dd>
      </div>
      <div>
        <dt>{accountCopy.profileEmail}</dt>
        <dd data-account-profile-email>{accountCopy.profileUnknown}</dd>
      </div>
      <div>
        <dt>{accountCopy.profileCreatedAt}</dt>
        <dd data-account-profile-created>{accountCopy.profileUnknown}</dd>
      </div>
      <div>
        <dt>{accountCopy.profileStatus}</dt>
        <dd data-account-profile-status>{accountCopy.profileUnknown}</dd>
      </div>
    </dl>
    <p class="small account-feedback" data-account-profile-feedback aria-live="polite"></p>
  </section>

  <section class="card panel gv-stack" data-account-settings hidden>
    <h2>{accountCopy.languageTitle}</h2>
    <p class="small">{accountCopy.languageDescription}</p>

    <form class="gv-stack account-form" data-account-language-form data-auth-base={authBaseUrl} novalidate>
      <label class="account-field">
        <span>{accountCopy.preferredLanguage}</span>
        <select name="preferred_ui_language" data-account-language-select>
          {
            availableLanguages.map((language) => (
              <option value={language}>{language.toUpperCase()}</option>
            ))
          }
        </select>
      </label>

      <button type="submit" class="ui-button ui-button-primary ui-button-md">
        <span class="ui-button-label">{accountCopy.savePreference}</span>
      </button>
      <p class="small account-feedback" data-account-feedback aria-live="polite"></p>
    </form>
  </section>

  <section class="card panel gv-stack" data-account-password hidden>
    <h2>{accountCopy.passwordTitle}</h2>
    <p class="small">{accountCopy.passwordDescription}</p>

    <form class="gv-stack account-form" data-account-password-form data-auth-base={authBaseUrl} novalidate>
      <label class="account-field">
        <span>{accountCopy.currentPassword}</span>
        <input type="password" name="currentPassword" autocomplete="current-password" minlength="8" required />
      </label>

      <label class="account-field">
        <span>{accountCopy.newPassword}</span>
        <input type="password" name="password" autocomplete="new-password" minlength="8" required />
      </label>

      <label class="account-field">
        <span>{accountCopy.passwordConfirm}</span>
        <input type="password" name="passwordConfirmation" autocomplete="new-password" minlength="8" required />
      </label>

      <button type="submit" class="ui-button ui-button-primary ui-button-md">
        <span class="ui-button-label">{accountCopy.changePassword}</span>
      </button>
      <p class="small account-feedback" data-account-password-feedback aria-live="polite"></p>
    </form>
  </section>

  <script is:inline define:vars={{ lang, loginPath, availableLanguages, accountCopy }}>
    (() => {
      const settingsPanel = document.querySelector('[data-account-settings]');
      const passwordPanel = document.querySelector('[data-account-password]');
      const loggedOutPanel = document.querySelector('[data-account-logged-out]');
      const profilePanel = document.querySelector('[data-account-profile]');
      const profileUsername = document.querySelector('[data-account-profile-username]');
      const profileEmail = document.querySelector('[data-account-profile-email]');
      const profileCreated = document.querySelector('[data-account-profile-created]');
      const profileStatus = document.querySelector('[data-account-profile-status]');
      const profileFeedback = document.querySelector('[data-account-profile-feedback]');
      const form = document.querySelector('[data-account-language-form]');
      const feedback = document.querySelector('[data-account-feedback]');
      const select = document.querySelector('[data-account-language-select]');
      const passwordForm = document.querySelector('[data-account-password-form]');
      const passwordFeedback = document.querySelector('[data-account-password-feedback]');

      if (
        !(settingsPanel instanceof HTMLElement) ||
        !(passwordPanel instanceof HTMLElement) ||
        !(loggedOutPanel instanceof HTMLElement) ||
        !(profilePanel instanceof HTMLElement)
      ) {
        return;
      }
      if (!(form instanceof HTMLFormElement) || !(feedback instanceof HTMLElement) || !(select instanceof HTMLSelectElement)) return;
      if (!(passwordForm instanceof HTMLFormElement) || !(passwordFeedback instanceof HTMLElement)) return;
      if (
        !(profileUsername instanceof HTMLElement) ||
        !(profileEmail instanceof HTMLElement) ||
        !(profileCreated instanceof HTMLElement) ||
        !(profileStatus instanceof HTMLElement)
      ) {
        return;
      }

      const authBase = form.getAttribute('data-auth-base');
      if (!authBase) return;

      const normalizedLanguages = Array.isArray(availableLanguages) ? availableLanguages : [];
      const isAllowedLanguage = (value) => normalizedLanguages.includes(value);
      const normalizeLanguage = (value) => String(value || '').trim().toLowerCase();

      const setFeedback = (message, isError = false) => {
        feedback.textContent = message;
        feedback.classList.toggle('is-error', isError);
      };

      const setProfileFeedback = (message, isError = false) => {
        if (!(profileFeedback instanceof HTMLElement)) return;
        profileFeedback.textContent = message;
        profileFeedback.classList.toggle('is-error', isError);
      };

      const setPasswordFeedback = (message, isError = false) => {
        passwordFeedback.textContent = message;
        passwordFeedback.classList.toggle('is-error', isError);
      };

      const clearAuthSession = () => {
        try {
          localStorage.removeItem('geovito_auth_session');
          sessionStorage.removeItem('geovito_auth_session');
        } catch {
          // no-op
        }
      };

      const formatDate = (value) => {
        if (!value) return accountCopy.profileUnknown;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return accountCopy.profileUnknown;
        try {
          return new Intl.DateTimeFormat(document.documentElement.lang || 'en', {
            dateStyle: 'medium',
            timeStyle: 'short',
          }).format(date);
        } catch {
          return date.toISOString();
        }
      };

      const renderProfile = (payload) => {
        const username = String(payload?.username || '').trim();
        const email = String(payload?.email || '').trim();
        const createdAt = payload?.createdAt || payload?.loginAt;
        const blocked = payload?.blocked === true;
        const confirmed = payload?.confirmed !== false;

        profileUsername.textContent = username || accountCopy.profileUnknown;
        profileEmail.textContent = email || accountCopy.profileUnknown;
        profileCreated.textContent = formatDate(createdAt);

        if (blocked) {
          profileStatus.textContent = accountCopy.profileStatusBlocked;
        } else if (!confirmed) {
          profileStatus.textContent = accountCopy.profileStatusPending;
        } else {
          profileStatus.textContent = accountCopy.profileStatusActive;
        }
      };

      const readSession = () => {
        try {
          const readRaw = () => {
            const fromLocal = localStorage.getItem('geovito_auth_session');
            if (fromLocal) return fromLocal;
            const fromSession = sessionStorage.getItem('geovito_auth_session');
            if (fromSession) {
              localStorage.setItem('geovito_auth_session', fromSession);
            }
            return fromSession;
          };

          const raw = readRaw();
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return null;
          if (!parsed.jwt || typeof parsed.jwt !== 'string') return null;
          return parsed;
        } catch {
          return null;
        }
      };

      const session = readSession();
      if (!session) {
        settingsPanel.hidden = true;
        passwordPanel.hidden = true;
        profilePanel.hidden = true;
        loggedOutPanel.hidden = false;
        return;
      }

      settingsPanel.hidden = false;
      passwordPanel.hidden = false;
      profilePanel.hidden = false;
      loggedOutPanel.hidden = true;
      renderProfile(session);

      const applyPreferredLanguage = (language) => {
        const normalized = normalizeLanguage(language);
        if (!isAllowedLanguage(normalized)) return false;
        select.value = normalized;
        try {
          localStorage.setItem('geovito.ui_lang', normalized);
        } catch {
          // no-op
        }
        return true;
      };

      const loadPreference = async () => {
        const localPreferred = normalizeLanguage(localStorage.getItem('geovito.ui_lang') || '');
        if (isAllowedLanguage(localPreferred)) {
          select.value = localPreferred;
        }

        try {
          const response = await fetch(`${authBase}/api/user-preferences/me`, {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          });
          if (!response.ok) return;
          const payload = await response.json().catch(() => null);
          const language = normalizeLanguage(payload?.data?.preferred_ui_language);
          if (applyPreferredLanguage(language)) {
            setFeedback(accountCopy.loadedPreference);
          }
        } catch {
          // no-op
        }
      };

      const loadProfile = async () => {
        try {
          const response = await fetch(`${authBase}/api/users/me`, {
            headers: {
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
          });
          if (!response.ok) {
            setProfileFeedback(accountCopy.profileSyncFallback, true);
            return;
          }
          const payload = await response.json().catch(() => null);
          if (!payload || typeof payload !== 'object') {
            setProfileFeedback(accountCopy.profileSyncFallback, true);
            return;
          }
          renderProfile(payload);
          setProfileFeedback('');
        } catch {
          setProfileFeedback(accountCopy.profileSyncFallback, true);
        }
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const selected = normalizeLanguage(select.value);
        if (!isAllowedLanguage(selected)) {
          setFeedback(accountCopy.chooseSupportedLanguage, true);
          return;
        }

        setFeedback(accountCopy.savingPreference);
        try {
          const response = await fetch(`${authBase}/api/user-preferences/me`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
            body: JSON.stringify({
              data: {
                preferred_ui_language: selected,
              },
            }),
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload?.error?.message || accountCopy.preferenceSaveFailed;
            setFeedback(message, true);
            return;
          }

          applyPreferredLanguage(selected);
          setFeedback(accountCopy.preferenceSavedRedirect);
          window.setTimeout(() => {
            window.location.assign(`/${selected}/`);
          }, 400);
        } catch {
          setFeedback(accountCopy.preferenceNetworkError, true);
        }
      });

      passwordForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(passwordForm);
        const currentPassword = String(formData.get('currentPassword') || '');
        const password = String(formData.get('password') || '');
        const passwordConfirmation = String(formData.get('passwordConfirmation') || '');

        if (!currentPassword || !password || !passwordConfirmation) {
          setPasswordFeedback(accountCopy.passwordRequired, true);
          return;
        }

        if (password.length < 8) {
          setPasswordFeedback(accountCopy.passwordLength, true);
          return;
        }

        if (password !== passwordConfirmation) {
          setPasswordFeedback(accountCopy.passwordMismatch, true);
          return;
        }

        if (password === currentPassword) {
          setPasswordFeedback(accountCopy.passwordSameAsCurrent, true);
          return;
        }

        setPasswordFeedback(accountCopy.passwordSaving);
        try {
          const response = await fetch(`${authBase}/api/auth/change-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
              Authorization: `Bearer ${session.jwt}`,
            },
            body: JSON.stringify({
              currentPassword,
              password,
              passwordConfirmation,
            }),
          });

          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload?.error?.message || payload?.message || accountCopy.passwordSaveFailed;
            setPasswordFeedback(message, true);
            return;
          }

          setPasswordFeedback(accountCopy.passwordSavedReauth);
          passwordForm.reset();
          clearAuthSession();
          window.setTimeout(() => {
            window.location.assign(loginPath);
          }, 1100);
        } catch {
          setPasswordFeedback(accountCopy.passwordNetworkError, true);
        }
      });

      loadPreference();
      loadProfile();
    })();
  </script>
</MainLayout>

<style>
  .account-form {
    gap: 0.75rem;
    max-width: 520px;
  }

  .account-field {
    display: grid;
    gap: 0.4rem;
  }

  .account-field select {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 0.85rem;
    background: var(--surface);
    color: var(--text);
  }

  .account-field input {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 0.85rem;
    background: var(--surface);
    color: var(--text);
  }

  .account-field select:focus-visible,
  .account-field input:focus-visible {
    outline: 2px solid var(--brand);
    outline-offset: 1px;
  }

  .account-feedback {
    margin: 0;
    min-height: 1.25rem;
  }

  .account-profile-grid {
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
  }

  .account-profile-grid div {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.65rem 0.75rem;
    background: var(--surface);
  }

  .account-profile-grid dt {
    margin: 0;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .account-profile-grid dd {
    margin: 0.22rem 0 0;
    font-weight: 600;
    overflow-wrap: anywhere;
  }

  .account-feedback.is-error {
    color: var(--danger);
  }
</style>
