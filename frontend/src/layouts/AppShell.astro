---
import BaseLayout from './BaseLayout.astro';
import LeftSidebar from '../components/LeftSidebar.astro';
import RightTools from '../components/RightTools.astro';
import Accordion from '../components/ui/Accordion.astro';
import Icon from '../components/Icon.astro';
import { translate } from '../lib/uiLanguage';

interface AlternateLink {
  hreflang: string;
  href: string;
}

interface Props {
  title: string;
  description?: string;
  canonical: string;
  robots?: string;
  currentLanguage: string;
  languageLinks: Record<string, string>;
  alternates?: AlternateLink[];
  ui: Record<string, unknown>;
  showTools?: boolean;
  toolsContext?: string | null;
  hasCustomTools?: boolean;
}

const {
  title,
  description,
  canonical,
  robots,
  currentLanguage,
  languageLinks,
  alternates = [],
  ui,
  showTools = false,
  toolsContext = null,
  hasCustomTools = false,
} = Astro.props as Props;
const t = (key: string, fallback: string) => translate(ui, key, {}, fallback);
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  robots={robots}
  currentLanguage={currentLanguage}
  languageLinks={languageLinks}
  alternates={alternates}
  ui={ui}
>
  {Astro.slots.has('head') ? <slot name="head" slot="head" /> : null}
  <div class={`shell-layout ${showTools ? 'has-tools' : 'no-tools'}`} data-ev-root="ui">
    <aside class="left-column desktop-tablet-column" aria-label={t('layout.mainNavigation', 'Main navigation')}>
      <div class="left-nav-card">
        <div class="left-nav-head">
          <button
            type="button"
            class="icon-button sidebar-toggle-button"
            data-sidebar-toggle
            data-ev-scope="ui"
            data-label-expand={t('layout.expandSidebar', 'Expand sidebar')}
            data-label-collapse={t('layout.collapseSidebar', 'Collapse sidebar')}
            aria-label={t('layout.collapseSidebar', 'Collapse sidebar')}
            aria-pressed="false"
          >
            <Icon name="PanelLeftClose" size={18} />
            <span class="sr-only" data-sidebar-toggle-label>{t('layout.collapseSidebar', 'Collapse sidebar')}</span>
          </button>
        </div>
        <LeftSidebar currentLanguage={currentLanguage} languageLinks={languageLinks} ui={ui} />
      </div>
    </aside>

    <main id="main-content" tabindex="-1" class="center-column">
      <section class="content">
        <slot />
      </section>

      {
        showTools ? (
          <div class="tablet-tools">
            <Accordion title={t('layout.toolsTitle', 'Tools')}>
              <div class="tablet-tools-body">
                {hasCustomTools ? <slot name="tools" /> : <RightTools currentLanguage={currentLanguage} ui={ui} contextLabel={toolsContext} />}
              </div>
            </Accordion>
          </div>
        ) : null
      }
    </main>

    {
      showTools ? (
        <aside class="right-column desktop-tools-column" aria-label={t('layout.toolsTitle', 'Tools')}>
          {hasCustomTools ? <slot name="tools" /> : <RightTools currentLanguage={currentLanguage} ui={ui} contextLabel={toolsContext} />}
        </aside>
      ) : null
    }
  </div>

  <p class="app-shell-fallback" data-client-fallback="app-shell" aria-live="polite" aria-hidden="true" hidden>
    {t('errorPage.inlineFallback', 'Some interactive controls are temporarily unavailable.')}
  </p>

  <div class="drawer-backdrop" data-shell-backdrop hidden></div>

  <aside
    class="mobile-drawer"
    id="mobile-shell-drawer"
    data-shell-drawer
    data-ev-root="ui"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    tabindex="-1"
  >
    <div class="mobile-drawer-head">
      <strong class="brand drawer-brand">
        <Icon name="Map" size={20} />
        <span class="truncate">{t('layout.mainNavigation', 'Navigation')}</span>
      </strong>
      <button type="button" class="icon-button" data-shell-menu-close aria-label={t('layout.closeMenu', 'Close menu')}>
        <Icon name="X" size={20} />
        <span class="sr-only">{t('layout.closeMenu', 'Close menu')}</span>
      </button>
    </div>

    <div class="mobile-drawer-scroll">
      <LeftSidebar currentLanguage={currentLanguage} languageLinks={languageLinks} ui={ui} />
      {
        showTools ? (
          <div class="mobile-drawer-tools">
            <h2 class="sidebar-title">{t('layout.toolsTitle', 'Tools')}</h2>
            {hasCustomTools ? <slot name="tools" /> : <RightTools currentLanguage={currentLanguage} ui={ui} contextLabel={toolsContext} />}
          </div>
        ) : null
      }
    </div>
  </aside>

  <script>
    import { createFocusTrap } from '../lib/a11y/focusTrap';
    import { trackSidebarToggle } from '../lib/analytics';
    import { runWithClientBoundary } from '../lib/observability/clientBoundary';

    runWithClientBoundary(
      'app_shell',
      () => {
      const root = document.documentElement;
      const sidebarToggles = Array.from(document.querySelectorAll('[data-sidebar-toggle]'));

      if (sidebarToggles.length > 0) {
        const applySidebarState = (state) => {
          const compact = state === 'compact';
          root.classList.toggle('sidebar-compact', compact);
          sidebarToggles.forEach((button) => {
            const expandLabel = button.getAttribute('data-label-expand') || 'Expand sidebar';
            const collapseLabel = button.getAttribute('data-label-collapse') || 'Collapse sidebar';
            const label = compact ? expandLabel : collapseLabel;
            button.setAttribute('aria-pressed', compact ? 'true' : 'false');
            button.setAttribute('aria-label', label);
            const labelNode = button.querySelector('[data-sidebar-toggle-label]');
            if (labelNode) {
              labelNode.textContent = label;
            }
          });
        };

        const readSidebarState = () => {
          try {
            return localStorage.getItem('sidebar') === 'compact' ? 'compact' : 'expanded';
          } catch {
            return root.classList.contains('sidebar-compact') ? 'compact' : 'expanded';
          }
        };

        const writeSidebarState = (state) => {
          try {
            localStorage.setItem('sidebar', state);
          } catch {
            // no-op
          }
        };

        applySidebarState(readSidebarState());

        sidebarToggles.forEach((button) => {
          if (button.getAttribute('data-sidebar-bound') === 'true') return;
          button.setAttribute('data-sidebar-bound', 'true');
          button.addEventListener('click', () => {
            const nextState = root.classList.contains('sidebar-compact') ? 'expanded' : 'compact';
            writeSidebarState(nextState);
            applySidebarState(nextState);
            trackSidebarToggle({
              to: nextState,
              lang: document.documentElement.lang?.toLowerCase() || 'en',
            });
          });
        });
      }

      const drawer = document.querySelector('[data-shell-drawer]');
      const backdrop = document.querySelector('[data-shell-backdrop]');
      const openButtons = Array.from(document.querySelectorAll('[data-shell-menu-open]'));
      const closeButtons = Array.from(document.querySelectorAll('[data-shell-menu-close]'));

      if (!drawer || !backdrop || openButtons.length === 0) {
        return;
      }

      const closeButton = drawer.querySelector('[data-shell-menu-close]');
      const inertTargets = Array.from(
        document.querySelectorAll('.site-header, .site-header-spacer, .background-layer, .shell-layout, .site-footer')
      );
      let trapCleanup = null;
      let opener = null;

      openButtons.forEach((button) => {
        button.setAttribute('aria-controls', 'mobile-shell-drawer');
        button.setAttribute('aria-expanded', 'false');
      });

      const setBackgroundInert = (open) => {
        inertTargets.forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          if ('inert' in node) {
            node.inert = open;
          }
          if (open) {
            node.setAttribute('aria-hidden', 'true');
          } else {
            node.removeAttribute('aria-hidden');
          }
        });
      };

      const setOpen = (open, trigger = null) => {
        if (open && trigger instanceof HTMLElement) {
          opener = trigger;
        }

        drawer.classList.toggle('is-open', open);
        drawer.setAttribute('aria-hidden', open ? 'false' : 'true');
        backdrop.hidden = !open;
        document.body.classList.toggle('drawer-open', open);

        openButtons.forEach((button) => {
          button.setAttribute('aria-controls', 'mobile-shell-drawer');
          button.setAttribute('aria-expanded', open ? 'true' : 'false');
        });

        setBackgroundInert(open);

        if (open) {
          if (trapCleanup) trapCleanup();
          trapCleanup = createFocusTrap(drawer, {
            onEscape: () => setOpen(false),
            initialFocusEl: closeButton instanceof HTMLElement ? closeButton : null,
          });
          return;
        }

        if (trapCleanup) {
          trapCleanup();
          trapCleanup = null;
        }

        if (opener instanceof HTMLElement) {
          opener.focus();
        }
      };

      openButtons.forEach((button) => button.addEventListener('click', () => setOpen(true, button)));
      closeButtons.forEach((button) => button.addEventListener('click', () => setOpen(false)));
      backdrop.addEventListener('click', () => setOpen(false));
      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && drawer.classList.contains('is-open')) {
          setOpen(false);
        }
      });
      },
      { fallbackSelector: '[data-client-fallback="app-shell"]' }
    );
  </script>
</BaseLayout>
